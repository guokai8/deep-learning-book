<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>ç¬¬ä¹ç« ï¼šè¿ç§»å­¦ä¹ ä¸å¾®è°ƒ (Transfer Learning &amp; Fine-tuning) â€“ æ·±åº¦å­¦ä¹ å®Œæ•´æ•™ç¨‹</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./Chapter10.html" rel="next">
<link href="./Chapter8.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-5ea8f22911a6df30576a2a25a24cdd7a.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./Chapter9.html">ç¬¬ä¸‰éƒ¨åˆ†ï¼šå®è·µä¸åº”ç”¨</a></li><li class="breadcrumb-item"><a href="./Chapter9.html"><span class="chapter-title">ç¬¬ä¹ç« ï¼šè¿ç§»å­¦ä¹ ä¸å¾®è°ƒ (Transfer Learning &amp; Fine-tuning)</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">æ·±åº¦å­¦ä¹ å®Œæ•´æ•™ç¨‹</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">ğŸ“‹ è¯¾ç¨‹æ•´ä½“æ¡†æ¶</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºç¡€ç¯‡</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter1.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">æœºå™¨å­¦ä¹ å®Œæ•´è¯¾ç¨‹</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter2.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">ç¬¬äºŒç« ï¼šå›å½’ (Regression)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter3.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">ç¬¬ä¸‰ç« ï¼šåˆ†ç±»ä¸é€»è¾‘å›å½’ (Classification &amp; Logistic Regression)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter4.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">ç¬¬å››ç« ï¼šæ·±åº¦ç¥ç»ç½‘ç»œåŸºç¡€ (Deep Neural Networks)</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">ç¬¬äºŒéƒ¨åˆ†ï¼šè¿›é˜¶ç¯‡</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter5.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">ç¬¬äº”ç« ï¼šä¼˜åŒ–ç®—æ³•ä¸è®­ç»ƒæŠ€å·§ (Optimization &amp; Training Tricks)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter6.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">ç¬¬å…­ç« ï¼šå·ç§¯ç¥ç»ç½‘ç»œ (Convolutional Neural Networks)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter7.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">ç¬¬ä¸ƒç« ï¼šå¾ªç¯ç¥ç»ç½‘ç»œ (Recurrent Neural Networks)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter8.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">ç¬¬å…«ç« ï¼šAttention ä¸ Transformer</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">ç¬¬ä¸‰éƒ¨åˆ†ï¼šå®è·µä¸åº”ç”¨</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter9.html" class="sidebar-item-text sidebar-link active"><span class="chapter-title">ç¬¬ä¹ç« ï¼šè¿ç§»å­¦ä¹ ä¸å¾®è°ƒ (Transfer Learning &amp; Fine-tuning)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter10.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">ç¬¬åç« ï¼šå¼ºåŒ–å­¦ä¹  (Reinforcement Learning)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter11.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">ç¬¬åä¸€ç« ï¼šæ— ç›‘ç£å­¦ä¹  (Unsupervised Learning)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter12.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">ç¬¬åäºŒç« ï¼šå¯è§£é‡Šæ€§ä¸å¯¹æŠ—æ”»å‡»</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter13.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">ç¬¬åä¸‰ç« ï¼šå¤§è¯­è¨€æ¨¡å‹æ—¶ä»£</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#ç« èŠ‚ç›®æ ‡" id="toc-ç« èŠ‚ç›®æ ‡" class="nav-link active" data-scroll-target="#ç« èŠ‚ç›®æ ‡">ğŸ“Œ ç« èŠ‚ç›®æ ‡</a></li>
  <li><a href="#ä¸ºä»€ä¹ˆéœ€è¦è¿ç§»å­¦ä¹ " id="toc-ä¸ºä»€ä¹ˆéœ€è¦è¿ç§»å­¦ä¹ " class="nav-link" data-scroll-target="#ä¸ºä»€ä¹ˆéœ€è¦è¿ç§»å­¦ä¹ ">9.1 ä¸ºä»€ä¹ˆéœ€è¦è¿ç§»å­¦ä¹ ï¼Ÿ</a>
  <ul class="collapse">
  <li><a href="#ä»é›¶è®­ç»ƒçš„é—®é¢˜" id="toc-ä»é›¶è®­ç»ƒçš„é—®é¢˜" class="nav-link" data-scroll-target="#ä»é›¶è®­ç»ƒçš„é—®é¢˜">ğŸš¨ ä»é›¶è®­ç»ƒçš„é—®é¢˜</a></li>
  <li><a href="#è¿ç§»å­¦ä¹ çš„ä¼˜åŠ¿" id="toc-è¿ç§»å­¦ä¹ çš„ä¼˜åŠ¿" class="nav-link" data-scroll-target="#è¿ç§»å­¦ä¹ çš„ä¼˜åŠ¿">âœ… è¿ç§»å­¦ä¹ çš„ä¼˜åŠ¿</a></li>
  <li><a href="#ç›´è§‰ç†è§£" id="toc-ç›´è§‰ç†è§£" class="nav-link" data-scroll-target="#ç›´è§‰ç†è§£">ğŸ§  ç›´è§‰ç†è§£</a></li>
  </ul></li>
  <li><a href="#è¿ç§»å­¦ä¹ çš„åˆ†ç±»" id="toc-è¿ç§»å­¦ä¹ çš„åˆ†ç±»" class="nav-link" data-scroll-target="#è¿ç§»å­¦ä¹ çš„åˆ†ç±»">9.2 è¿ç§»å­¦ä¹ çš„åˆ†ç±»</a>
  <ul class="collapse">
  <li><a href="#æŒ‰ä»»åŠ¡å…³ç³»åˆ†ç±»" id="toc-æŒ‰ä»»åŠ¡å…³ç³»åˆ†ç±»" class="nav-link" data-scroll-target="#æŒ‰ä»»åŠ¡å…³ç³»åˆ†ç±»">ğŸ“Š æŒ‰ä»»åŠ¡å…³ç³»åˆ†ç±»</a></li>
  <li><a href="#æŒ‰è¿ç§»å†…å®¹åˆ†ç±»" id="toc-æŒ‰è¿ç§»å†…å®¹åˆ†ç±»" class="nav-link" data-scroll-target="#æŒ‰è¿ç§»å†…å®¹åˆ†ç±»">ğŸ“Š æŒ‰è¿ç§»å†…å®¹åˆ†ç±»</a></li>
  </ul></li>
  <li><a href="#è®¡ç®—æœºè§†è§‰ä¸­çš„è¿ç§»å­¦ä¹ " id="toc-è®¡ç®—æœºè§†è§‰ä¸­çš„è¿ç§»å­¦ä¹ " class="nav-link" data-scroll-target="#è®¡ç®—æœºè§†è§‰ä¸­çš„è¿ç§»å­¦ä¹ ">9.3 è®¡ç®—æœºè§†è§‰ä¸­çš„è¿ç§»å­¦ä¹ </a>
  <ul class="collapse">
  <li><a href="#é¢„è®­ç»ƒæ¨¡å‹" id="toc-é¢„è®­ç»ƒæ¨¡å‹" class="nav-link" data-scroll-target="#é¢„è®­ç»ƒæ¨¡å‹">ğŸ–¼ï¸ é¢„è®­ç»ƒæ¨¡å‹</a></li>
  <li><a href="#ç‰¹å¾æå–-vs-å¾®è°ƒ" id="toc-ç‰¹å¾æå–-vs-å¾®è°ƒ" class="nav-link" data-scroll-target="#ç‰¹å¾æå–-vs-å¾®è°ƒ">ğŸ“ ç‰¹å¾æå– vs å¾®è°ƒ</a></li>
  <li><a href="#å®æˆ˜çŒ«ç‹—åˆ†ç±»è¿ç§»å­¦ä¹ " id="toc-å®æˆ˜çŒ«ç‹—åˆ†ç±»è¿ç§»å­¦ä¹ " class="nav-link" data-scroll-target="#å®æˆ˜çŒ«ç‹—åˆ†ç±»è¿ç§»å­¦ä¹ ">ğŸ¯ å®æˆ˜ï¼šçŒ«ç‹—åˆ†ç±»ï¼ˆè¿ç§»å­¦ä¹ ï¼‰</a></li>
  </ul></li>
  <li><a href="#è‡ªç„¶è¯­è¨€å¤„ç†ä¸­çš„è¿ç§»å­¦ä¹ " id="toc-è‡ªç„¶è¯­è¨€å¤„ç†ä¸­çš„è¿ç§»å­¦ä¹ " class="nav-link" data-scroll-target="#è‡ªç„¶è¯­è¨€å¤„ç†ä¸­çš„è¿ç§»å­¦ä¹ ">9.4 è‡ªç„¶è¯­è¨€å¤„ç†ä¸­çš„è¿ç§»å­¦ä¹ </a>
  <ul class="collapse">
  <li><a href="#é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹" id="toc-é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹" class="nav-link" data-scroll-target="#é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹">ğŸ“ é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹</a></li>
  <li><a href="#ä½¿ç”¨-hugging-face-transformers" id="toc-ä½¿ç”¨-hugging-face-transformers" class="nav-link" data-scroll-target="#ä½¿ç”¨-hugging-face-transformers">ğŸ”¹ ä½¿ç”¨ Hugging Face Transformers</a></li>
  </ul></li>
  <li><a href="#é¢†åŸŸè‡ªé€‚åº”-domain-adaptation" id="toc-é¢†åŸŸè‡ªé€‚åº”-domain-adaptation" class="nav-link" data-scroll-target="#é¢†åŸŸè‡ªé€‚åº”-domain-adaptation">9.5 é¢†åŸŸè‡ªé€‚åº” (Domain Adaptation)</a>
  <ul class="collapse">
  <li><a href="#é—®é¢˜è®¾å®š" id="toc-é—®é¢˜è®¾å®š" class="nav-link" data-scroll-target="#é—®é¢˜è®¾å®š">ğŸ¯ é—®é¢˜è®¾å®š</a></li>
  <li><a href="#æ–¹æ³•åˆ†ç±»" id="toc-æ–¹æ³•åˆ†ç±»" class="nav-link" data-scroll-target="#æ–¹æ³•åˆ†ç±»">ğŸ“ æ–¹æ³•åˆ†ç±»</a></li>
  </ul></li>
  <li><a href="#å°‘æ ·æœ¬å­¦ä¹ -few-shot-learning" id="toc-å°‘æ ·æœ¬å­¦ä¹ -few-shot-learning" class="nav-link" data-scroll-target="#å°‘æ ·æœ¬å­¦ä¹ -few-shot-learning">9.6 å°‘æ ·æœ¬å­¦ä¹  (Few-Shot Learning)</a>
  <ul class="collapse">
  <li><a href="#é—®é¢˜å®šä¹‰" id="toc-é—®é¢˜å®šä¹‰" class="nav-link" data-scroll-target="#é—®é¢˜å®šä¹‰">ğŸ¯ é—®é¢˜å®šä¹‰</a></li>
  <li><a href="#å…ƒå­¦ä¹ -meta-learning" id="toc-å…ƒå­¦ä¹ -meta-learning" class="nav-link" data-scroll-target="#å…ƒå­¦ä¹ -meta-learning">ğŸ“ å…ƒå­¦ä¹  (Meta-Learning)</a></li>
  <li><a href="#åŸå‹ç½‘ç»œ-prototypical-networks" id="toc-åŸå‹ç½‘ç»œ-prototypical-networks" class="nav-link" data-scroll-target="#åŸå‹ç½‘ç»œ-prototypical-networks">ğŸ“ åŸå‹ç½‘ç»œ (Prototypical Networks)</a></li>
  </ul></li>
  <li><a href="#çŸ¥è¯†è’¸é¦-knowledge-distillation" id="toc-çŸ¥è¯†è’¸é¦-knowledge-distillation" class="nav-link" data-scroll-target="#çŸ¥è¯†è’¸é¦-knowledge-distillation">9.7 çŸ¥è¯†è’¸é¦ (Knowledge Distillation)</a>
  <ul class="collapse">
  <li><a href="#æ ¸å¿ƒæ€æƒ³" id="toc-æ ¸å¿ƒæ€æƒ³" class="nav-link" data-scroll-target="#æ ¸å¿ƒæ€æƒ³">ğŸ¯ æ ¸å¿ƒæ€æƒ³</a></li>
  <li><a href="#æ¸©åº¦-softmax" id="toc-æ¸©åº¦-softmax" class="nav-link" data-scroll-target="#æ¸©åº¦-softmax">ğŸ“ æ¸©åº¦ Softmax</a></li>
  <li><a href="#å®ç°" id="toc-å®ç°" class="nav-link" data-scroll-target="#å®ç°">ğŸ’» å®ç°</a></li>
  </ul></li>
  <li><a href="#å®æˆ˜å®Œæ•´è¿ç§»å­¦ä¹ é¡¹ç›®" id="toc-å®æˆ˜å®Œæ•´è¿ç§»å­¦ä¹ é¡¹ç›®" class="nav-link" data-scroll-target="#å®æˆ˜å®Œæ•´è¿ç§»å­¦ä¹ é¡¹ç›®">9.8 å®æˆ˜ï¼šå®Œæ•´è¿ç§»å­¦ä¹ é¡¹ç›®</a>
  <ul class="collapse">
  <li><a href="#ä»»åŠ¡åŒ»å­¦å›¾åƒåˆ†ç±»" id="toc-ä»»åŠ¡åŒ»å­¦å›¾åƒåˆ†ç±»" class="nav-link" data-scroll-target="#ä»»åŠ¡åŒ»å­¦å›¾åƒåˆ†ç±»">ğŸ“‹ ä»»åŠ¡ï¼šåŒ»å­¦å›¾åƒåˆ†ç±»</a></li>
  </ul></li>
  <li><a href="#è¿ç§»å­¦ä¹ æœ€ä½³å®è·µ" id="toc-è¿ç§»å­¦ä¹ æœ€ä½³å®è·µ" class="nav-link" data-scroll-target="#è¿ç§»å­¦ä¹ æœ€ä½³å®è·µ">9.9 è¿ç§»å­¦ä¹ æœ€ä½³å®è·µ</a>
  <ul class="collapse">
  <li><a href="#æ•°æ®é›†å¤§å°ç­–ç•¥" id="toc-æ•°æ®é›†å¤§å°ç­–ç•¥" class="nav-link" data-scroll-target="#æ•°æ®é›†å¤§å°ç­–ç•¥">âœ… æ•°æ®é›†å¤§å°ç­–ç•¥</a></li>
  <li><a href="#å­¦ä¹ ç‡ç­–ç•¥" id="toc-å­¦ä¹ ç‡ç­–ç•¥" class="nav-link" data-scroll-target="#å­¦ä¹ ç‡ç­–ç•¥">ğŸ“Š å­¦ä¹ ç‡ç­–ç•¥</a></li>
  <li><a href="#æ•°æ®å¢å¼ºæŠ€å·§" id="toc-æ•°æ®å¢å¼ºæŠ€å·§" class="nav-link" data-scroll-target="#æ•°æ®å¢å¼ºæŠ€å·§">ğŸ¯ æ•°æ®å¢å¼ºæŠ€å·§</a></li>
  </ul></li>
  <li><a href="#æœ¬ç« ä½œä¸š" id="toc-æœ¬ç« ä½œä¸š" class="nav-link" data-scroll-target="#æœ¬ç« ä½œä¸š">ğŸ“ æœ¬ç« ä½œä¸š</a>
  <ul class="collapse">
  <li><a href="#ä½œä¸š-1å¯¹æ¯”å®éªŒ" id="toc-ä½œä¸š-1å¯¹æ¯”å®éªŒ" class="nav-link" data-scroll-target="#ä½œä¸š-1å¯¹æ¯”å®éªŒ">ä½œä¸š 1ï¼šå¯¹æ¯”å®éªŒ</a></li>
  <li><a href="#ä½œä¸š-2åŒ»å­¦å›¾åƒåˆ†ç±»" id="toc-ä½œä¸š-2åŒ»å­¦å›¾åƒåˆ†ç±»" class="nav-link" data-scroll-target="#ä½œä¸š-2åŒ»å­¦å›¾åƒåˆ†ç±»">ä½œä¸š 2ï¼šåŒ»å­¦å›¾åƒåˆ†ç±»</a></li>
  <li><a href="#ä½œä¸š-3å°‘æ ·æœ¬å­¦ä¹ " id="toc-ä½œä¸š-3å°‘æ ·æœ¬å­¦ä¹ " class="nav-link" data-scroll-target="#ä½œä¸š-3å°‘æ ·æœ¬å­¦ä¹ ">ä½œä¸š 3ï¼šå°‘æ ·æœ¬å­¦ä¹ </a></li>
  <li><a href="#ä½œä¸š-4é¢†åŸŸè‡ªé€‚åº”" id="toc-ä½œä¸š-4é¢†åŸŸè‡ªé€‚åº”" class="nav-link" data-scroll-target="#ä½œä¸š-4é¢†åŸŸè‡ªé€‚åº”">ä½œä¸š 4ï¼šé¢†åŸŸè‡ªé€‚åº”</a></li>
  </ul></li>
  <li><a href="#æœ¬ç« å…³é”®æ¦‚å¿µ" id="toc-æœ¬ç« å…³é”®æ¦‚å¿µ" class="nav-link" data-scroll-target="#æœ¬ç« å…³é”®æ¦‚å¿µ">ğŸ”‘ æœ¬ç« å…³é”®æ¦‚å¿µ</a></li>
  <li><a href="#è¿›é˜¶è¯é¢˜" id="toc-è¿›é˜¶è¯é¢˜" class="nav-link" data-scroll-target="#è¿›é˜¶è¯é¢˜">9.10 è¿›é˜¶è¯é¢˜</a>
  <ul class="collapse">
  <li><a href="#å¤šä»»åŠ¡å­¦ä¹ -multi-task-learning" id="toc-å¤šä»»åŠ¡å­¦ä¹ -multi-task-learning" class="nav-link" data-scroll-target="#å¤šä»»åŠ¡å­¦ä¹ -multi-task-learning">ğŸ”¹ å¤šä»»åŠ¡å­¦ä¹  (Multi-Task Learning)</a></li>
  <li><a href="#æŒç»­å­¦ä¹ -continual-learning" id="toc-æŒç»­å­¦ä¹ -continual-learning" class="nav-link" data-scroll-target="#æŒç»­å­¦ä¹ -continual-learning">ğŸ”¹ æŒç»­å­¦ä¹  (Continual Learning)</a></li>
  <li><a href="#å¯¹æ¯”å­¦ä¹ -contrastive-learning" id="toc-å¯¹æ¯”å­¦ä¹ -contrastive-learning" class="nav-link" data-scroll-target="#å¯¹æ¯”å­¦ä¹ -contrastive-learning">ğŸ”¹ å¯¹æ¯”å­¦ä¹  (Contrastive Learning)</a></li>
  </ul></li>
  <li><a href="#å®ç”¨å·¥å…·å’ŒæŠ€å·§" id="toc-å®ç”¨å·¥å…·å’ŒæŠ€å·§" class="nav-link" data-scroll-target="#å®ç”¨å·¥å…·å’ŒæŠ€å·§">9.11 å®ç”¨å·¥å…·å’ŒæŠ€å·§</a>
  <ul class="collapse">
  <li><a href="#æ¨¡å‹è½¬æ¢å’Œéƒ¨ç½²" id="toc-æ¨¡å‹è½¬æ¢å’Œéƒ¨ç½²" class="nav-link" data-scroll-target="#æ¨¡å‹è½¬æ¢å’Œéƒ¨ç½²">ğŸ› ï¸ æ¨¡å‹è½¬æ¢å’Œéƒ¨ç½²</a></li>
  <li><a href="#æ¨¡å‹åˆ†æå·¥å…·" id="toc-æ¨¡å‹åˆ†æå·¥å…·" class="nav-link" data-scroll-target="#æ¨¡å‹åˆ†æå·¥å…·">ğŸ“Š æ¨¡å‹åˆ†æå·¥å…·</a></li>
  <li><a href="#é”™è¯¯åˆ†æå·¥å…·" id="toc-é”™è¯¯åˆ†æå·¥å…·" class="nav-link" data-scroll-target="#é”™è¯¯åˆ†æå·¥å…·">ğŸ” é”™è¯¯åˆ†æå·¥å…·</a></li>
  </ul></li>
  <li><a href="#æ¨èèµ„æº" id="toc-æ¨èèµ„æº" class="nav-link" data-scroll-target="#æ¨èèµ„æº">ğŸ“š æ¨èèµ„æº</a>
  <ul class="collapse">
  <li><a href="#è®ºæ–‡" id="toc-è®ºæ–‡" class="nav-link" data-scroll-target="#è®ºæ–‡">ğŸ“– è®ºæ–‡</a></li>
  <li><a href="#å·¥å…·å’Œåº“" id="toc-å·¥å…·å’Œåº“" class="nav-link" data-scroll-target="#å·¥å…·å’Œåº“">ğŸ”§ å·¥å…·å’Œåº“</a></li>
  </ul></li>
  <li><a href="#æ€»ç»“" id="toc-æ€»ç»“" class="nav-link" data-scroll-target="#æ€»ç»“">ğŸ“ æ€»ç»“</a>
  <ul class="collapse">
  <li><a href="#è¿ç§»å­¦ä¹ ä½•æ—¶æœ‰æ•ˆ" id="toc-è¿ç§»å­¦ä¹ ä½•æ—¶æœ‰æ•ˆ" class="nav-link" data-scroll-target="#è¿ç§»å­¦ä¹ ä½•æ—¶æœ‰æ•ˆ">âœ… è¿ç§»å­¦ä¹ ä½•æ—¶æœ‰æ•ˆï¼Ÿ</a></li>
  <li><a href="#è¿ç§»å­¦ä¹ ä½•æ—¶æ— æ•ˆ" id="toc-è¿ç§»å­¦ä¹ ä½•æ—¶æ— æ•ˆ" class="nav-link" data-scroll-target="#è¿ç§»å­¦ä¹ ä½•æ—¶æ— æ•ˆ">âŒ è¿ç§»å­¦ä¹ ä½•æ—¶æ— æ•ˆï¼Ÿ</a></li>
  <li><a href="#å®è·µå»ºè®®" id="toc-å®è·µå»ºè®®" class="nav-link" data-scroll-target="#å®è·µå»ºè®®">ğŸ¯ å®è·µå»ºè®®</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./Chapter9.html">ç¬¬ä¸‰éƒ¨åˆ†ï¼šå®è·µä¸åº”ç”¨</a></li><li class="breadcrumb-item"><a href="./Chapter9.html"><span class="chapter-title">ç¬¬ä¹ç« ï¼šè¿ç§»å­¦ä¹ ä¸å¾®è°ƒ (Transfer Learning &amp; Fine-tuning)</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-title">ç¬¬ä¹ç« ï¼šè¿ç§»å­¦ä¹ ä¸å¾®è°ƒ (Transfer Learning &amp; Fine-tuning)</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="ç« èŠ‚ç›®æ ‡" class="level2">
<h2 class="anchored" data-anchor-id="ç« èŠ‚ç›®æ ‡">ğŸ“Œ ç« èŠ‚ç›®æ ‡</h2>
<ul>
<li>ç†è§£è¿ç§»å­¦ä¹ çš„åŠ¨æœºå’ŒåŸç†</li>
<li>æŒæ¡é¢„è®­ç»ƒæ¨¡å‹çš„ä½¿ç”¨æ–¹æ³•</li>
<li>å­¦ä¹ ä¸åŒçš„å¾®è°ƒç­–ç•¥</li>
<li>äº†è§£é¢†åŸŸè‡ªé€‚åº”æŠ€æœ¯</li>
<li>å®æˆ˜ï¼šå›¾åƒåˆ†ç±»ã€æ–‡æœ¬åˆ†ç±»çš„è¿ç§»å­¦ä¹ </li>
</ul>
<hr>
</section>
<section id="ä¸ºä»€ä¹ˆéœ€è¦è¿ç§»å­¦ä¹ " class="level2">
<h2 class="anchored" data-anchor-id="ä¸ºä»€ä¹ˆéœ€è¦è¿ç§»å­¦ä¹ ">9.1 ä¸ºä»€ä¹ˆéœ€è¦è¿ç§»å­¦ä¹ ï¼Ÿ</h2>
<section id="ä»é›¶è®­ç»ƒçš„é—®é¢˜" class="level3">
<h3 class="anchored" data-anchor-id="ä»é›¶è®­ç»ƒçš„é—®é¢˜">ğŸš¨ ä»é›¶è®­ç»ƒçš„é—®é¢˜</h3>
<p><strong>ä¼ ç»Ÿæ·±åº¦å­¦ä¹ </strong>ï¼š</p>
<pre><code>æ”¶é›†å¤§é‡æ•°æ® â†’ è®¾è®¡ç½‘ç»œ â†’ ä»é›¶è®­ç»ƒ â†’ éƒ¨ç½²

é—®é¢˜ï¼š
  âŒ éœ€è¦æµ·é‡æ ‡æ³¨æ•°æ®
  âŒ è®­ç»ƒæ—¶é—´é•¿ï¼ˆå‡ å¤©åˆ°å‡ å‘¨ï¼‰
  âŒ è®¡ç®—èµ„æºæ˜‚è´µ
  âŒ å®¹æ˜“è¿‡æ‹Ÿåˆï¼ˆå°æ•°æ®é›†ï¼‰</code></pre>
<p><strong>ä¾‹å­</strong>ï¼šè®­ç»ƒ ResNet-50 on ImageNet</p>
<pre><code>æ•°æ®ï¼š120ä¸‡å¼ æ ‡æ³¨å›¾ç‰‡
æ—¶é—´ï¼š8ä¸ª GPUï¼Œå‡ å¤©åˆ°ä¸€å‘¨
æˆæœ¬ï¼šæ•°åƒç¾å…ƒ</code></pre>
</section>
<section id="è¿ç§»å­¦ä¹ çš„ä¼˜åŠ¿" class="level3">
<h3 class="anchored" data-anchor-id="è¿ç§»å­¦ä¹ çš„ä¼˜åŠ¿">âœ… è¿ç§»å­¦ä¹ çš„ä¼˜åŠ¿</h3>
<p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šåˆ©ç”¨å·²æœ‰çŸ¥è¯†åŠ é€Ÿæ–°ä»»åŠ¡å­¦ä¹ </p>
<pre><code>é¢„è®­ç»ƒï¼ˆå¤§æ•°æ®é›†ï¼‰â†’ å¾®è°ƒï¼ˆå°æ•°æ®é›†ï¼‰â†’ éƒ¨ç½²

ä¼˜åŠ¿ï¼š
  âœ“ éœ€è¦æ›´å°‘çš„æ•°æ®
  âœ“ è®­ç»ƒæ›´å¿«ï¼ˆå°æ—¶çº§åˆ«ï¼‰
  âœ“ æ€§èƒ½æ›´å¥½ï¼ˆç‰¹åˆ«æ˜¯å°æ•°æ®é›†ï¼‰
  âœ“ é™ä½æˆæœ¬</code></pre>
</section>
<section id="ç›´è§‰ç†è§£" class="level3">
<h3 class="anchored" data-anchor-id="ç›´è§‰ç†è§£">ğŸ§  ç›´è§‰ç†è§£</h3>
<p><strong>äººç±»å­¦ä¹ çš„ç±»æ¯”</strong>ï¼š</p>
<pre><code>å­¦ä¹ è¯†åˆ«çŒ«ï¼š
  ä¸éœ€è¦ä»é›¶å­¦ä¹ "ä»€ä¹ˆæ˜¯è¾¹ç¼˜"ã€"ä»€ä¹ˆæ˜¯çº¹ç†"
  å·²ç»æœ‰è§†è§‰ç³»ç»Ÿçš„åŸºç¡€çŸ¥è¯†
  åªéœ€è¦å­¦ä¹ "çŒ«çš„ç‰¹å¾"

è¿ç§»å­¦ä¹ ï¼š
  é¢„è®­ç»ƒæ¨¡å‹ = å·²æœ‰çš„è§†è§‰/è¯­è¨€çŸ¥è¯†
  å¾®è°ƒ = é’ˆå¯¹ç‰¹å®šä»»åŠ¡è°ƒæ•´</code></pre>
<hr>
</section>
</section>
<section id="è¿ç§»å­¦ä¹ çš„åˆ†ç±»" class="level2">
<h2 class="anchored" data-anchor-id="è¿ç§»å­¦ä¹ çš„åˆ†ç±»">9.2 è¿ç§»å­¦ä¹ çš„åˆ†ç±»</h2>
<section id="æŒ‰ä»»åŠ¡å…³ç³»åˆ†ç±»" class="level3">
<h3 class="anchored" data-anchor-id="æŒ‰ä»»åŠ¡å…³ç³»åˆ†ç±»">ğŸ“Š æŒ‰ä»»åŠ¡å…³ç³»åˆ†ç±»</h3>
<section id="å½’çº³è¿ç§»-inductive-transfer" class="level4">
<h4 class="anchored" data-anchor-id="å½’çº³è¿ç§»-inductive-transfer"><strong>1. å½’çº³è¿ç§» (Inductive Transfer)</strong></h4>
<pre><code>æºä»»åŠ¡ â‰  ç›®æ ‡ä»»åŠ¡ï¼Œä½†ç›¸å…³

ä¾‹ï¼š
  æºï¼šImageNet åˆ†ç±» (1000ç±»)
  ç›®æ ‡ï¼šåŒ»å­¦å›¾åƒåˆ†ç±» (5ç±»)</code></pre>
</section>
<section id="è½¬å¯¼è¿ç§»-transductive-transfer" class="level4">
<h4 class="anchored" data-anchor-id="è½¬å¯¼è¿ç§»-transductive-transfer"><strong>2. è½¬å¯¼è¿ç§» (Transductive Transfer)</strong></h4>
<pre><code>æºä»»åŠ¡ = ç›®æ ‡ä»»åŠ¡ï¼Œä½†æ•°æ®åˆ†å¸ƒä¸åŒ

ä¾‹ï¼š
  æºï¼šç”µå½±è¯„è®ºæƒ…æ„Ÿåˆ†æ
  ç›®æ ‡ï¼šäº§å“è¯„è®ºæƒ…æ„Ÿåˆ†æ</code></pre>
</section>
<section id="æ— ç›‘ç£è¿ç§»-unsupervised-transfer" class="level4">
<h4 class="anchored" data-anchor-id="æ— ç›‘ç£è¿ç§»-unsupervised-transfer"><strong>3. æ— ç›‘ç£è¿ç§» (Unsupervised Transfer)</strong></h4>
<pre><code>æºä»»åŠ¡å’Œç›®æ ‡ä»»åŠ¡éƒ½æ— æ ‡ç­¾

ä¾‹ï¼š
  èšç±»ã€é™ç»´ä»»åŠ¡</code></pre>
<hr>
</section>
</section>
<section id="æŒ‰è¿ç§»å†…å®¹åˆ†ç±»" class="level3">
<h3 class="anchored" data-anchor-id="æŒ‰è¿ç§»å†…å®¹åˆ†ç±»">ğŸ“Š æŒ‰è¿ç§»å†…å®¹åˆ†ç±»</h3>
<section id="ç‰¹å¾è¿ç§»-feature-transfer" class="level4">
<h4 class="anchored" data-anchor-id="ç‰¹å¾è¿ç§»-feature-transfer"><strong>1. ç‰¹å¾è¿ç§» (Feature Transfer)</strong></h4>
<pre><code>è¿ç§»å­¦åˆ°çš„ç‰¹å¾è¡¨ç¤º

æ–¹æ³•ï¼šå›ºå®šé¢„è®­ç»ƒæ¨¡å‹ï¼Œåªè®­ç»ƒåˆ†ç±»å™¨</code></pre>
</section>
<section id="å‚æ•°è¿ç§»-parameter-transfer" class="level4">
<h4 class="anchored" data-anchor-id="å‚æ•°è¿ç§»-parameter-transfer"><strong>2. å‚æ•°è¿ç§» (Parameter Transfer)</strong></h4>
<pre><code>è¿ç§»æ¨¡å‹å‚æ•°ä½œä¸ºåˆå§‹åŒ–

æ–¹æ³•ï¼šç”¨é¢„è®­ç»ƒæƒé‡åˆå§‹åŒ–ï¼Œç„¶åå¾®è°ƒ</code></pre>
</section>
<section id="å…³ç³»è¿ç§»-relation-transfer" class="level4">
<h4 class="anchored" data-anchor-id="å…³ç³»è¿ç§»-relation-transfer"><strong>3. å…³ç³»è¿ç§» (Relation Transfer)</strong></h4>
<pre><code>è¿ç§»æ ·æœ¬é—´çš„å…³ç³»

ä¾‹ï¼šçŸ¥è¯†å›¾è°±ã€ç»“æ„åŒ–é¢„æµ‹</code></pre>
<hr>
</section>
</section>
</section>
<section id="è®¡ç®—æœºè§†è§‰ä¸­çš„è¿ç§»å­¦ä¹ " class="level2">
<h2 class="anchored" data-anchor-id="è®¡ç®—æœºè§†è§‰ä¸­çš„è¿ç§»å­¦ä¹ ">9.3 è®¡ç®—æœºè§†è§‰ä¸­çš„è¿ç§»å­¦ä¹ </h2>
<section id="é¢„è®­ç»ƒæ¨¡å‹" class="level3">
<h3 class="anchored" data-anchor-id="é¢„è®­ç»ƒæ¨¡å‹">ğŸ–¼ï¸ é¢„è®­ç»ƒæ¨¡å‹</h3>
<p><strong>å¸¸ç”¨é¢„è®­ç»ƒæ¨¡å‹</strong>ï¼ˆåœ¨ ImageNet ä¸Šè®­ç»ƒï¼‰ï¼š</p>
<pre><code>è½»é‡çº§ï¼š
  - MobileNet (4M å‚æ•°)
  - EfficientNet-B0 (5M)

ä¸­ç­‰ï¼š
  - ResNet-50 (25M)
  - VGG-16 (138M)

å¤§å‹ï¼š
  - ResNet-152 (60M)
  - EfficientNet-B7 (66M)
  - Vision Transformer (ViT) (86M)</code></pre>
</section>
<section id="ç‰¹å¾æå–-vs-å¾®è°ƒ" class="level3">
<h3 class="anchored" data-anchor-id="ç‰¹å¾æå–-vs-å¾®è°ƒ">ğŸ“ ç‰¹å¾æå– vs å¾®è°ƒ</h3>
<section id="ç‰¹å¾æå–-feature-extraction" class="level4">
<h4 class="anchored" data-anchor-id="ç‰¹å¾æå–-feature-extraction"><strong>ç‰¹å¾æå– (Feature Extraction)</strong></h4>
<pre><code>å†»ç»“é¢„è®­ç»ƒæ¨¡å‹ â†’ åªè®­ç»ƒæ–°çš„åˆ†ç±»å™¨

é€‚ç”¨åœºæ™¯ï¼š
  âœ“ æ•°æ®é›†å¾ˆå° (&lt; 1000 æ ·æœ¬)
  âœ“ ç›®æ ‡ä»»åŠ¡ä¸æºä»»åŠ¡ç›¸ä¼¼
  âœ“ è®¡ç®—èµ„æºæœ‰é™</code></pre>
<p><strong>å®ç°</strong>ï¼š</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision <span class="im">import</span> models</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># åŠ è½½é¢„è®­ç»ƒæ¨¡å‹</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> models.resnet50(pretrained<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co"># å†»ç»“æ‰€æœ‰å‚æ•°</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> param <span class="kw">in</span> model.parameters():</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    param.requires_grad <span class="op">=</span> <span class="va">False</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co"># æ›¿æ¢æœ€åçš„å…¨è¿æ¥å±‚</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>num_features <span class="op">=</span> model.fc.in_features</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>model.fc <span class="op">=</span> nn.Linear(num_features, num_classes)  <span class="co"># åªæœ‰è¿™å±‚ä¼šè®­ç»ƒ</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="co"># åªä¼˜åŒ–æ–°æ·»åŠ çš„å±‚</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.Adam(model.fc.parameters(), lr<span class="op">=</span><span class="fl">0.001</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
</section>
<section id="å¾®è°ƒ-fine-tuning" class="level4">
<h4 class="anchored" data-anchor-id="å¾®è°ƒ-fine-tuning"><strong>å¾®è°ƒ (Fine-tuning)</strong></h4>
<pre><code>è§£å†»éƒ¨åˆ†æˆ–å…¨éƒ¨å±‚ â†’ åœ¨æ–°æ•°æ®ä¸Šè®­ç»ƒ

é€‚ç”¨åœºæ™¯ï¼š
  âœ“ æ•°æ®é›†ä¸­ç­‰å¤§å° (1k - 100k)
  âœ“ ç›®æ ‡ä»»åŠ¡ä¸æºä»»åŠ¡æœ‰å·®å¼‚
  âœ“ è¿½æ±‚æ›´å¥½æ€§èƒ½</code></pre>
<p><strong>ç­–ç•¥</strong>ï¼š</p>
<pre><code>1. å…¨å±€å¾®è°ƒï¼š
   è§£å†»æ‰€æœ‰å±‚ï¼Œç”¨å°å­¦ä¹ ç‡è®­ç»ƒ

2. é€å±‚å¾®è°ƒï¼š
   å…ˆè®­ç»ƒé¡¶å±‚ï¼Œé€æ¸è§£å†»åº•å±‚

3. åˆ¤åˆ«å¼å¾®è°ƒï¼š
   ä¸åŒå±‚ç”¨ä¸åŒå­¦ä¹ ç‡</code></pre>
<p><strong>å®ç°</strong>ï¼š</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># æ–¹æ³•1ï¼šå…¨å±€å¾®è°ƒï¼ˆå°å­¦ä¹ ç‡ï¼‰</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> models.resnet50(pretrained<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co"># æ›¿æ¢åˆ†ç±»å™¨</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>model.fc <span class="op">=</span> nn.Linear(model.fc.in_features, num_classes)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co"># æ‰€æœ‰å‚æ•°éƒ½è®­ç»ƒï¼Œä½†ç”¨å°å­¦ä¹ ç‡</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span><span class="fl">1e-4</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># æ–¹æ³•2ï¼šé€å±‚å¾®è°ƒ</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> models.resnet50(pretrained<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>model.fc <span class="op">=</span> nn.Linear(model.fc.in_features, num_classes)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ç¬¬ä¸€é˜¶æ®µï¼šåªè®­ç»ƒåˆ†ç±»å™¨</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> param <span class="kw">in</span> model.parameters():</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    param.requires_grad <span class="op">=</span> <span class="va">False</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> param <span class="kw">in</span> model.fc.parameters():</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    param.requires_grad <span class="op">=</span> <span class="va">True</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.Adam(model.fc.parameters(), lr<span class="op">=</span><span class="fl">0.001</span>)</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="co"># è®­ç»ƒå‡ ä¸ª epoch...</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co"># ç¬¬äºŒé˜¶æ®µï¼šè§£å†» layer4</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> param <span class="kw">in</span> model.layer4.parameters():</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    param.requires_grad <span class="op">=</span> <span class="va">True</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.Adam([</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'params'</span>: model.fc.parameters(), <span class="st">'lr'</span>: <span class="fl">0.001</span>},</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'params'</span>: model.layer4.parameters(), <span class="st">'lr'</span>: <span class="fl">0.0001</span>}</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="co"># ç»§ç»­è®­ç»ƒ...</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># æ–¹æ³•3ï¼šåˆ¤åˆ«å¼å­¦ä¹ ç‡</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> models.resnet50(pretrained<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>model.fc <span class="op">=</span> nn.Linear(model.fc.in_features, num_classes)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ä¸åŒå±‚ç»„ä½¿ç”¨ä¸åŒå­¦ä¹ ç‡</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.Adam([</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'params'</span>: model.conv1.parameters(), <span class="st">'lr'</span>: <span class="fl">1e-5</span>},</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'params'</span>: model.layer1.parameters(), <span class="st">'lr'</span>: <span class="fl">1e-5</span>},</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'params'</span>: model.layer2.parameters(), <span class="st">'lr'</span>: <span class="fl">1e-4</span>},</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'params'</span>: model.layer3.parameters(), <span class="st">'lr'</span>: <span class="fl">1e-4</span>},</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'params'</span>: model.layer4.parameters(), <span class="st">'lr'</span>: <span class="fl">1e-3</span>},</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'params'</span>: model.fc.parameters(), <span class="st">'lr'</span>: <span class="fl">1e-2</span>}</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
</section>
</section>
<section id="å®æˆ˜çŒ«ç‹—åˆ†ç±»è¿ç§»å­¦ä¹ " class="level3">
<h3 class="anchored" data-anchor-id="å®æˆ˜çŒ«ç‹—åˆ†ç±»è¿ç§»å­¦ä¹ ">ğŸ¯ å®æˆ˜ï¼šçŒ«ç‹—åˆ†ç±»ï¼ˆè¿ç§»å­¦ä¹ ï¼‰</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.optim <span class="im">as</span> optim</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> DataLoader</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision <span class="im">import</span> datasets, transforms, models</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co"># ==================== è¶…å‚æ•° ====================</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>DATA_DIR <span class="op">=</span> <span class="st">'./data/cats_and_dogs'</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>BATCH_SIZE <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>EPOCHS <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>LEARNING_RATE <span class="op">=</span> <span class="fl">0.001</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>NUM_CLASSES <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>DEVICE <span class="op">=</span> torch.device(<span class="st">'cuda'</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">'cpu'</span>)</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="co"># ==================== æ•°æ®å¢å¼º ====================</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>data_transforms <span class="op">=</span> {</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">'train'</span>: transforms.Compose([</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>        transforms.RandomResizedCrop(<span class="dv">224</span>),</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>        transforms.RandomHorizontalFlip(),</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>        transforms.RandomRotation(<span class="dv">15</span>),</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>        transforms.ColorJitter(brightness<span class="op">=</span><span class="fl">0.2</span>, contrast<span class="op">=</span><span class="fl">0.2</span>, saturation<span class="op">=</span><span class="fl">0.2</span>),</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>        transforms.ToTensor(),</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>        transforms.Normalize([<span class="fl">0.485</span>, <span class="fl">0.456</span>, <span class="fl">0.406</span>], [<span class="fl">0.229</span>, <span class="fl">0.224</span>, <span class="fl">0.225</span>])</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    ]),</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">'val'</span>: transforms.Compose([</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>        transforms.Resize(<span class="dv">256</span>),</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>        transforms.CenterCrop(<span class="dv">224</span>),</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>        transforms.ToTensor(),</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>        transforms.Normalize([<span class="fl">0.485</span>, <span class="fl">0.456</span>, <span class="fl">0.406</span>], [<span class="fl">0.229</span>, <span class="fl">0.224</span>, <span class="fl">0.225</span>])</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a><span class="co"># ==================== æ•°æ®åŠ è½½ ====================</span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>image_datasets <span class="op">=</span> {</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>    x: datasets.ImageFolder(os.path.join(DATA_DIR, x), data_transforms[x])</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> x <span class="kw">in</span> [<span class="st">'train'</span>, <span class="st">'val'</span>]</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>dataloaders <span class="op">=</span> {</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>    x: DataLoader(image_datasets[x], batch_size<span class="op">=</span>BATCH_SIZE,</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>                  shuffle<span class="op">=</span>(x<span class="op">==</span><span class="st">'train'</span>), num_workers<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> x <span class="kw">in</span> [<span class="st">'train'</span>, <span class="st">'val'</span>]</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>dataset_sizes <span class="op">=</span> {x: <span class="bu">len</span>(image_datasets[x]) <span class="cf">for</span> x <span class="kw">in</span> [<span class="st">'train'</span>, <span class="st">'val'</span>]}</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>class_names <span class="op">=</span> image_datasets[<span class="st">'train'</span>].classes</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"è®­ç»ƒé›†: </span><span class="sc">{</span>dataset_sizes[<span class="st">'train'</span>]<span class="sc">}</span><span class="ss"> å¼ "</span>)</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"éªŒè¯é›†: </span><span class="sc">{</span>dataset_sizes[<span class="st">'val'</span>]<span class="sc">}</span><span class="ss"> å¼ "</span>)</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"ç±»åˆ«: </span><span class="sc">{</span>class_names<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a><span class="co"># ==================== æ¨¡å‹å®šä¹‰ ====================</span></span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_model(model_name<span class="op">=</span><span class="st">'resnet50'</span>, num_classes<span class="op">=</span><span class="dv">2</span>, feature_extract<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a><span class="co">    åˆ›å»ºè¿ç§»å­¦ä¹ æ¨¡å‹</span></span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a><span class="co">    å‚æ•°:</span></span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a><span class="co">        model_name: é¢„è®­ç»ƒæ¨¡å‹åç§°</span></span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a><span class="co">        num_classes: è¾“å‡ºç±»åˆ«æ•°</span></span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a><span class="co">        feature_extract: True=ç‰¹å¾æå–, False=å¾®è°ƒ</span></span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> <span class="va">None</span></span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> model_name <span class="op">==</span> <span class="st">'resnet50'</span>:</span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> models.resnet50(pretrained<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ç‰¹å¾æå–æ¨¡å¼ï¼šå†»ç»“å‚æ•°</span></span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> feature_extract:</span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> param <span class="kw">in</span> model.parameters():</span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a>                param.requires_grad <span class="op">=</span> <span class="va">False</span></span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a>        <span class="co"># æ›¿æ¢åˆ†ç±»å™¨</span></span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a>        num_features <span class="op">=</span> model.fc.in_features</span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a>        model.fc <span class="op">=</span> nn.Sequential(</span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(<span class="fl">0.5</span>),</span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a>            nn.Linear(num_features, num_classes)</span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> model_name <span class="op">==</span> <span class="st">'efficientnet_b0'</span>:</span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> models.efficientnet_b0(pretrained<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-85"><a href="#cb19-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-86"><a href="#cb19-86" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> feature_extract:</span>
<span id="cb19-87"><a href="#cb19-87" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> param <span class="kw">in</span> model.parameters():</span>
<span id="cb19-88"><a href="#cb19-88" aria-hidden="true" tabindex="-1"></a>                param.requires_grad <span class="op">=</span> <span class="va">False</span></span>
<span id="cb19-89"><a href="#cb19-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-90"><a href="#cb19-90" aria-hidden="true" tabindex="-1"></a>        num_features <span class="op">=</span> model.classifier[<span class="dv">1</span>].in_features</span>
<span id="cb19-91"><a href="#cb19-91" aria-hidden="true" tabindex="-1"></a>        model.classifier <span class="op">=</span> nn.Sequential(</span>
<span id="cb19-92"><a href="#cb19-92" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(<span class="fl">0.3</span>),</span>
<span id="cb19-93"><a href="#cb19-93" aria-hidden="true" tabindex="-1"></a>            nn.Linear(num_features, num_classes)</span>
<span id="cb19-94"><a href="#cb19-94" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb19-95"><a href="#cb19-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-96"><a href="#cb19-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> model_name <span class="op">==</span> <span class="st">'vgg16'</span>:</span>
<span id="cb19-97"><a href="#cb19-97" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> models.vgg16(pretrained<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-98"><a href="#cb19-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-99"><a href="#cb19-99" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> feature_extract:</span>
<span id="cb19-100"><a href="#cb19-100" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> param <span class="kw">in</span> model.features.parameters():</span>
<span id="cb19-101"><a href="#cb19-101" aria-hidden="true" tabindex="-1"></a>                param.requires_grad <span class="op">=</span> <span class="va">False</span></span>
<span id="cb19-102"><a href="#cb19-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-103"><a href="#cb19-103" aria-hidden="true" tabindex="-1"></a>        num_features <span class="op">=</span> model.classifier[<span class="dv">6</span>].in_features</span>
<span id="cb19-104"><a href="#cb19-104" aria-hidden="true" tabindex="-1"></a>        model.classifier[<span class="dv">6</span>] <span class="op">=</span> nn.Linear(num_features, num_classes)</span>
<span id="cb19-105"><a href="#cb19-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-106"><a href="#cb19-106" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span>
<span id="cb19-107"><a href="#cb19-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-108"><a href="#cb19-108" aria-hidden="true" tabindex="-1"></a><span class="co"># ==================== è®­ç»ƒå‡½æ•° ====================</span></span>
<span id="cb19-109"><a href="#cb19-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-110"><a href="#cb19-110" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_model(model, criterion, optimizer, scheduler, num_epochs):</span>
<span id="cb19-111"><a href="#cb19-111" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""è®­ç»ƒæ¨¡å‹"""</span></span>
<span id="cb19-112"><a href="#cb19-112" aria-hidden="true" tabindex="-1"></a>    best_acc <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb19-113"><a href="#cb19-113" aria-hidden="true" tabindex="-1"></a>    history <span class="op">=</span> {<span class="st">'train_loss'</span>: [], <span class="st">'train_acc'</span>: [], <span class="st">'val_loss'</span>: [], <span class="st">'val_acc'</span>: []}</span>
<span id="cb19-114"><a href="#cb19-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-115"><a href="#cb19-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(num_epochs):</span>
<span id="cb19-116"><a href="#cb19-116" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'</span><span class="ch">\n</span><span class="ss">Epoch </span><span class="sc">{</span>epoch<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>num_epochs<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb19-117"><a href="#cb19-117" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'-'</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb19-118"><a href="#cb19-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-119"><a href="#cb19-119" aria-hidden="true" tabindex="-1"></a>        <span class="co"># è®­ç»ƒå’ŒéªŒè¯</span></span>
<span id="cb19-120"><a href="#cb19-120" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> phase <span class="kw">in</span> [<span class="st">'train'</span>, <span class="st">'val'</span>]:</span>
<span id="cb19-121"><a href="#cb19-121" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> phase <span class="op">==</span> <span class="st">'train'</span>:</span>
<span id="cb19-122"><a href="#cb19-122" aria-hidden="true" tabindex="-1"></a>                model.train()</span>
<span id="cb19-123"><a href="#cb19-123" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb19-124"><a href="#cb19-124" aria-hidden="true" tabindex="-1"></a>                model.<span class="bu">eval</span>()</span>
<span id="cb19-125"><a href="#cb19-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-126"><a href="#cb19-126" aria-hidden="true" tabindex="-1"></a>            running_loss <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb19-127"><a href="#cb19-127" aria-hidden="true" tabindex="-1"></a>            running_corrects <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb19-128"><a href="#cb19-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-129"><a href="#cb19-129" aria-hidden="true" tabindex="-1"></a>            <span class="co"># è¿›åº¦æ¡</span></span>
<span id="cb19-130"><a href="#cb19-130" aria-hidden="true" tabindex="-1"></a>            pbar <span class="op">=</span> tqdm(dataloaders[phase], desc<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>phase<span class="sc">.</span>capitalize()<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb19-131"><a href="#cb19-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-132"><a href="#cb19-132" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> inputs, labels <span class="kw">in</span> pbar:</span>
<span id="cb19-133"><a href="#cb19-133" aria-hidden="true" tabindex="-1"></a>                inputs <span class="op">=</span> inputs.to(DEVICE)</span>
<span id="cb19-134"><a href="#cb19-134" aria-hidden="true" tabindex="-1"></a>                labels <span class="op">=</span> labels.to(DEVICE)</span>
<span id="cb19-135"><a href="#cb19-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-136"><a href="#cb19-136" aria-hidden="true" tabindex="-1"></a>                optimizer.zero_grad()</span>
<span id="cb19-137"><a href="#cb19-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-138"><a href="#cb19-138" aria-hidden="true" tabindex="-1"></a>                <span class="co"># å‰å‘ä¼ æ’­</span></span>
<span id="cb19-139"><a href="#cb19-139" aria-hidden="true" tabindex="-1"></a>                <span class="cf">with</span> torch.set_grad_enabled(phase <span class="op">==</span> <span class="st">'train'</span>):</span>
<span id="cb19-140"><a href="#cb19-140" aria-hidden="true" tabindex="-1"></a>                    outputs <span class="op">=</span> model(inputs)</span>
<span id="cb19-141"><a href="#cb19-141" aria-hidden="true" tabindex="-1"></a>                    _, preds <span class="op">=</span> torch.<span class="bu">max</span>(outputs, <span class="dv">1</span>)</span>
<span id="cb19-142"><a href="#cb19-142" aria-hidden="true" tabindex="-1"></a>                    loss <span class="op">=</span> criterion(outputs, labels)</span>
<span id="cb19-143"><a href="#cb19-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-144"><a href="#cb19-144" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># åå‘ä¼ æ’­</span></span>
<span id="cb19-145"><a href="#cb19-145" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> phase <span class="op">==</span> <span class="st">'train'</span>:</span>
<span id="cb19-146"><a href="#cb19-146" aria-hidden="true" tabindex="-1"></a>                        loss.backward()</span>
<span id="cb19-147"><a href="#cb19-147" aria-hidden="true" tabindex="-1"></a>                        optimizer.step()</span>
<span id="cb19-148"><a href="#cb19-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-149"><a href="#cb19-149" aria-hidden="true" tabindex="-1"></a>                <span class="co"># ç»Ÿè®¡</span></span>
<span id="cb19-150"><a href="#cb19-150" aria-hidden="true" tabindex="-1"></a>                running_loss <span class="op">+=</span> loss.item() <span class="op">*</span> inputs.size(<span class="dv">0</span>)</span>
<span id="cb19-151"><a href="#cb19-151" aria-hidden="true" tabindex="-1"></a>                running_corrects <span class="op">+=</span> torch.<span class="bu">sum</span>(preds <span class="op">==</span> labels.data)</span>
<span id="cb19-152"><a href="#cb19-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-153"><a href="#cb19-153" aria-hidden="true" tabindex="-1"></a>                <span class="co"># æ›´æ–°è¿›åº¦æ¡</span></span>
<span id="cb19-154"><a href="#cb19-154" aria-hidden="true" tabindex="-1"></a>                pbar.set_postfix({</span>
<span id="cb19-155"><a href="#cb19-155" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'loss'</span>: <span class="ss">f'</span><span class="sc">{</span>loss<span class="sc">.</span>item()<span class="sc">:.4f}</span><span class="ss">'</span>,</span>
<span id="cb19-156"><a href="#cb19-156" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'acc'</span>: <span class="ss">f'</span><span class="sc">{</span>torch<span class="sc">.</span><span class="bu">sum</span>(preds <span class="op">==</span> labels.data)<span class="sc">.</span>item() <span class="op">/</span> <span class="bu">len</span>(labels)<span class="sc">:.4f}</span><span class="ss">'</span></span>
<span id="cb19-157"><a href="#cb19-157" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb19-158"><a href="#cb19-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-159"><a href="#cb19-159" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Epoch ç»Ÿè®¡</span></span>
<span id="cb19-160"><a href="#cb19-160" aria-hidden="true" tabindex="-1"></a>            epoch_loss <span class="op">=</span> running_loss <span class="op">/</span> dataset_sizes[phase]</span>
<span id="cb19-161"><a href="#cb19-161" aria-hidden="true" tabindex="-1"></a>            epoch_acc <span class="op">=</span> running_corrects.double() <span class="op">/</span> dataset_sizes[phase]</span>
<span id="cb19-162"><a href="#cb19-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-163"><a href="#cb19-163" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>phase<span class="sc">.</span>capitalize()<span class="sc">}</span><span class="ss"> Loss: </span><span class="sc">{</span>epoch_loss<span class="sc">:.4f}</span><span class="ss"> Acc: </span><span class="sc">{</span>epoch_acc<span class="sc">:.4f}</span><span class="ss">'</span>)</span>
<span id="cb19-164"><a href="#cb19-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-165"><a href="#cb19-165" aria-hidden="true" tabindex="-1"></a>            <span class="co"># è®°å½•å†å²</span></span>
<span id="cb19-166"><a href="#cb19-166" aria-hidden="true" tabindex="-1"></a>            history[<span class="ss">f'</span><span class="sc">{</span>phase<span class="sc">}</span><span class="ss">_loss'</span>].append(epoch_loss)</span>
<span id="cb19-167"><a href="#cb19-167" aria-hidden="true" tabindex="-1"></a>            history[<span class="ss">f'</span><span class="sc">{</span>phase<span class="sc">}</span><span class="ss">_acc'</span>].append(epoch_acc.item())</span>
<span id="cb19-168"><a href="#cb19-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-169"><a href="#cb19-169" aria-hidden="true" tabindex="-1"></a>            <span class="co"># ä¿å­˜æœ€ä½³æ¨¡å‹</span></span>
<span id="cb19-170"><a href="#cb19-170" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> phase <span class="op">==</span> <span class="st">'val'</span> <span class="kw">and</span> epoch_acc <span class="op">&gt;</span> best_acc:</span>
<span id="cb19-171"><a href="#cb19-171" aria-hidden="true" tabindex="-1"></a>                best_acc <span class="op">=</span> epoch_acc</span>
<span id="cb19-172"><a href="#cb19-172" aria-hidden="true" tabindex="-1"></a>                torch.save(model.state_dict(), <span class="st">'best_model.pth'</span>)</span>
<span id="cb19-173"><a href="#cb19-173" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f'âœ“ ä¿å­˜æœ€ä½³æ¨¡å‹ (Acc: </span><span class="sc">{</span>best_acc<span class="sc">:.4f}</span><span class="ss">)'</span>)</span>
<span id="cb19-174"><a href="#cb19-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-175"><a href="#cb19-175" aria-hidden="true" tabindex="-1"></a>        <span class="co"># å­¦ä¹ ç‡è°ƒåº¦</span></span>
<span id="cb19-176"><a href="#cb19-176" aria-hidden="true" tabindex="-1"></a>        scheduler.step()</span>
<span id="cb19-177"><a href="#cb19-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-178"><a href="#cb19-178" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'</span><span class="ch">\n</span><span class="ss">æœ€ä½³éªŒè¯å‡†ç¡®ç‡: </span><span class="sc">{</span>best_acc<span class="sc">:.4f}</span><span class="ss">'</span>)</span>
<span id="cb19-179"><a href="#cb19-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-180"><a href="#cb19-180" aria-hidden="true" tabindex="-1"></a>    <span class="co"># åŠ è½½æœ€ä½³æ¨¡å‹</span></span>
<span id="cb19-181"><a href="#cb19-181" aria-hidden="true" tabindex="-1"></a>    model.load_state_dict(torch.load(<span class="st">'best_model.pth'</span>))</span>
<span id="cb19-182"><a href="#cb19-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-183"><a href="#cb19-183" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model, history</span>
<span id="cb19-184"><a href="#cb19-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-185"><a href="#cb19-185" aria-hidden="true" tabindex="-1"></a><span class="co"># ==================== å¯¹æ¯”å®éªŒ ====================</span></span>
<span id="cb19-186"><a href="#cb19-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-187"><a href="#cb19-187" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compare_strategies():</span>
<span id="cb19-188"><a href="#cb19-188" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""å¯¹æ¯”ä¸åŒè¿ç§»å­¦ä¹ ç­–ç•¥"""</span></span>
<span id="cb19-189"><a href="#cb19-189" aria-hidden="true" tabindex="-1"></a>    strategies <span class="op">=</span> {</span>
<span id="cb19-190"><a href="#cb19-190" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Feature Extraction'</span>: {</span>
<span id="cb19-191"><a href="#cb19-191" aria-hidden="true" tabindex="-1"></a>            <span class="st">'model'</span>: create_model(<span class="st">'resnet50'</span>, NUM_CLASSES, feature_extract<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb19-192"><a href="#cb19-192" aria-hidden="true" tabindex="-1"></a>            <span class="st">'lr'</span>: <span class="fl">0.001</span>,</span>
<span id="cb19-193"><a href="#cb19-193" aria-hidden="true" tabindex="-1"></a>            <span class="st">'color'</span>: <span class="st">'blue'</span></span>
<span id="cb19-194"><a href="#cb19-194" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb19-195"><a href="#cb19-195" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Fine-tuning (å…¨å±€)'</span>: {</span>
<span id="cb19-196"><a href="#cb19-196" aria-hidden="true" tabindex="-1"></a>            <span class="st">'model'</span>:</span>
<span id="cb19-197"><a href="#cb19-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-198"><a href="#cb19-198" aria-hidden="true" tabindex="-1"></a><span class="op">-----</span></span>
<span id="cb19-199"><a href="#cb19-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-200"><a href="#cb19-200" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> contonue</span>
<span id="cb19-201"><a href="#cb19-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-202"><a href="#cb19-202" aria-hidden="true" tabindex="-1"></a>create_model(<span class="st">'resnet50'</span>, NUM_CLASSES, feature_extract<span class="op">=</span><span class="va">False</span>),</span>
<span id="cb19-203"><a href="#cb19-203" aria-hidden="true" tabindex="-1"></a>            <span class="st">'lr'</span>: <span class="fl">0.0001</span>,</span>
<span id="cb19-204"><a href="#cb19-204" aria-hidden="true" tabindex="-1"></a>            <span class="st">'color'</span>: <span class="st">'red'</span></span>
<span id="cb19-205"><a href="#cb19-205" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb19-206"><a href="#cb19-206" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-207"><a href="#cb19-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-208"><a href="#cb19-208" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> {}</span>
<span id="cb19-209"><a href="#cb19-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-210"><a href="#cb19-210" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> strategy_name, config <span class="kw">in</span> strategies.items():</span>
<span id="cb19-211"><a href="#cb19-211" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'</span><span class="ch">\n</span><span class="sc">{</span><span class="st">"="</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb19-212"><a href="#cb19-212" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'ç­–ç•¥: </span><span class="sc">{</span>strategy_name<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb19-213"><a href="#cb19-213" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span><span class="st">"="</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb19-214"><a href="#cb19-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-215"><a href="#cb19-215" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> config[<span class="st">'model'</span>].to(DEVICE)</span>
<span id="cb19-216"><a href="#cb19-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-217"><a href="#cb19-217" aria-hidden="true" tabindex="-1"></a>        <span class="co"># æŸå¤±å‡½æ•°å’Œä¼˜åŒ–å™¨</span></span>
<span id="cb19-218"><a href="#cb19-218" aria-hidden="true" tabindex="-1"></a>        criterion <span class="op">=</span> nn.CrossEntropyLoss()</span>
<span id="cb19-219"><a href="#cb19-219" aria-hidden="true" tabindex="-1"></a>        optimizer <span class="op">=</span> optim.Adam(</span>
<span id="cb19-220"><a href="#cb19-220" aria-hidden="true" tabindex="-1"></a>            <span class="bu">filter</span>(<span class="kw">lambda</span> p: p.requires_grad, model.parameters()),</span>
<span id="cb19-221"><a href="#cb19-221" aria-hidden="true" tabindex="-1"></a>            lr<span class="op">=</span>config[<span class="st">'lr'</span>]</span>
<span id="cb19-222"><a href="#cb19-222" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb19-223"><a href="#cb19-223" aria-hidden="true" tabindex="-1"></a>        scheduler <span class="op">=</span> optim.lr_scheduler.StepLR(optimizer, step_size<span class="op">=</span><span class="dv">7</span>, gamma<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb19-224"><a href="#cb19-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-225"><a href="#cb19-225" aria-hidden="true" tabindex="-1"></a>        <span class="co"># è®­ç»ƒ</span></span>
<span id="cb19-226"><a href="#cb19-226" aria-hidden="true" tabindex="-1"></a>        model, history <span class="op">=</span> train_model(model, criterion, optimizer, scheduler, EPOCHS)</span>
<span id="cb19-227"><a href="#cb19-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-228"><a href="#cb19-228" aria-hidden="true" tabindex="-1"></a>        results[strategy_name] <span class="op">=</span> {</span>
<span id="cb19-229"><a href="#cb19-229" aria-hidden="true" tabindex="-1"></a>            <span class="st">'model'</span>: model,</span>
<span id="cb19-230"><a href="#cb19-230" aria-hidden="true" tabindex="-1"></a>            <span class="st">'history'</span>: history,</span>
<span id="cb19-231"><a href="#cb19-231" aria-hidden="true" tabindex="-1"></a>            <span class="st">'color'</span>: config[<span class="st">'color'</span>]</span>
<span id="cb19-232"><a href="#cb19-232" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb19-233"><a href="#cb19-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-234"><a href="#cb19-234" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==================== å¯è§†åŒ–å¯¹æ¯” ====================</span></span>
<span id="cb19-235"><a href="#cb19-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-236"><a href="#cb19-236" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">5</span>))</span>
<span id="cb19-237"><a href="#cb19-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-238"><a href="#cb19-238" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loss å¯¹æ¯”</span></span>
<span id="cb19-239"><a href="#cb19-239" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> strategy_name, data <span class="kw">in</span> results.items():</span>
<span id="cb19-240"><a href="#cb19-240" aria-hidden="true" tabindex="-1"></a>        epochs_range <span class="op">=</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(data[<span class="st">'history'</span>][<span class="st">'train_loss'</span>]) <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb19-241"><a href="#cb19-241" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>].plot(epochs_range, data[<span class="st">'history'</span>][<span class="st">'train_loss'</span>],</span>
<span id="cb19-242"><a href="#cb19-242" aria-hidden="true" tabindex="-1"></a>                    label<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>strategy_name<span class="sc">}</span><span class="ss"> (Train)'</span>,</span>
<span id="cb19-243"><a href="#cb19-243" aria-hidden="true" tabindex="-1"></a>                    linestyle<span class="op">=</span><span class="st">'--'</span>, color<span class="op">=</span>data[<span class="st">'color'</span>])</span>
<span id="cb19-244"><a href="#cb19-244" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>].plot(epochs_range, data[<span class="st">'history'</span>][<span class="st">'val_loss'</span>],</span>
<span id="cb19-245"><a href="#cb19-245" aria-hidden="true" tabindex="-1"></a>                    label<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>strategy_name<span class="sc">}</span><span class="ss"> (Val)'</span>,</span>
<span id="cb19-246"><a href="#cb19-246" aria-hidden="true" tabindex="-1"></a>                    linestyle<span class="op">=</span><span class="st">'-'</span>, color<span class="op">=</span>data[<span class="st">'color'</span>])</span>
<span id="cb19-247"><a href="#cb19-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-248"><a href="#cb19-248" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_xlabel(<span class="st">'Epoch'</span>)</span>
<span id="cb19-249"><a href="#cb19-249" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Loss'</span>)</span>
<span id="cb19-250"><a href="#cb19-250" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_title(<span class="st">'Loss Comparison'</span>)</span>
<span id="cb19-251"><a href="#cb19-251" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].legend()</span>
<span id="cb19-252"><a href="#cb19-252" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb19-253"><a href="#cb19-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-254"><a href="#cb19-254" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Accuracy å¯¹æ¯”</span></span>
<span id="cb19-255"><a href="#cb19-255" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> strategy_name, data <span class="kw">in</span> results.items():</span>
<span id="cb19-256"><a href="#cb19-256" aria-hidden="true" tabindex="-1"></a>        epochs_range <span class="op">=</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(data[<span class="st">'history'</span>][<span class="st">'train_acc'</span>]) <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb19-257"><a href="#cb19-257" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>].plot(epochs_range, data[<span class="st">'history'</span>][<span class="st">'train_acc'</span>],</span>
<span id="cb19-258"><a href="#cb19-258" aria-hidden="true" tabindex="-1"></a>                    label<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>strategy_name<span class="sc">}</span><span class="ss"> (Train)'</span>,</span>
<span id="cb19-259"><a href="#cb19-259" aria-hidden="true" tabindex="-1"></a>                    linestyle<span class="op">=</span><span class="st">'--'</span>, color<span class="op">=</span>data[<span class="st">'color'</span>])</span>
<span id="cb19-260"><a href="#cb19-260" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>].plot(epochs_range, data[<span class="st">'history'</span>][<span class="st">'val_acc'</span>],</span>
<span id="cb19-261"><a href="#cb19-261" aria-hidden="true" tabindex="-1"></a>                    label<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>strategy_name<span class="sc">}</span><span class="ss"> (Val)'</span>,</span>
<span id="cb19-262"><a href="#cb19-262" aria-hidden="true" tabindex="-1"></a>                    linestyle<span class="op">=</span><span class="st">'-'</span>, color<span class="op">=</span>data[<span class="st">'color'</span>])</span>
<span id="cb19-263"><a href="#cb19-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-264"><a href="#cb19-264" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Epoch'</span>)</span>
<span id="cb19-265"><a href="#cb19-265" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Accuracy'</span>)</span>
<span id="cb19-266"><a href="#cb19-266" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_title(<span class="st">'Accuracy Comparison'</span>)</span>
<span id="cb19-267"><a href="#cb19-267" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].legend()</span>
<span id="cb19-268"><a href="#cb19-268" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb19-269"><a href="#cb19-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-270"><a href="#cb19-270" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb19-271"><a href="#cb19-271" aria-hidden="true" tabindex="-1"></a>    plt.savefig(<span class="st">'transfer_learning_comparison.png'</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb19-272"><a href="#cb19-272" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb19-273"><a href="#cb19-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-274"><a href="#cb19-274" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb19-275"><a href="#cb19-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-276"><a href="#cb19-276" aria-hidden="true" tabindex="-1"></a><span class="co"># ==================== å¯è§†åŒ–é¢„æµ‹ ====================</span></span>
<span id="cb19-277"><a href="#cb19-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-278"><a href="#cb19-278" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> visualize_predictions(model, num_images<span class="op">=</span><span class="dv">16</span>):</span>
<span id="cb19-279"><a href="#cb19-279" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""å¯è§†åŒ–æ¨¡å‹é¢„æµ‹"""</span></span>
<span id="cb19-280"><a href="#cb19-280" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="cb19-281"><a href="#cb19-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-282"><a href="#cb19-282" aria-hidden="true" tabindex="-1"></a>    images_so_far <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb19-283"><a href="#cb19-283" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">12</span>))</span>
<span id="cb19-284"><a href="#cb19-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-285"><a href="#cb19-285" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb19-286"><a href="#cb19-286" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> inputs, labels <span class="kw">in</span> dataloaders[<span class="st">'val'</span>]:</span>
<span id="cb19-287"><a href="#cb19-287" aria-hidden="true" tabindex="-1"></a>            inputs <span class="op">=</span> inputs.to(DEVICE)</span>
<span id="cb19-288"><a href="#cb19-288" aria-hidden="true" tabindex="-1"></a>            labels <span class="op">=</span> labels.to(DEVICE)</span>
<span id="cb19-289"><a href="#cb19-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-290"><a href="#cb19-290" aria-hidden="true" tabindex="-1"></a>            outputs <span class="op">=</span> model(inputs)</span>
<span id="cb19-291"><a href="#cb19-291" aria-hidden="true" tabindex="-1"></a>            _, preds <span class="op">=</span> torch.<span class="bu">max</span>(outputs, <span class="dv">1</span>)</span>
<span id="cb19-292"><a href="#cb19-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-293"><a href="#cb19-293" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(inputs.size()[<span class="dv">0</span>]):</span>
<span id="cb19-294"><a href="#cb19-294" aria-hidden="true" tabindex="-1"></a>                images_so_far <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb19-295"><a href="#cb19-295" aria-hidden="true" tabindex="-1"></a>                ax <span class="op">=</span> plt.subplot(<span class="dv">4</span>, <span class="dv">4</span>, images_so_far)</span>
<span id="cb19-296"><a href="#cb19-296" aria-hidden="true" tabindex="-1"></a>                ax.axis(<span class="st">'off'</span>)</span>
<span id="cb19-297"><a href="#cb19-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-298"><a href="#cb19-298" aria-hidden="true" tabindex="-1"></a>                <span class="co"># åå½’ä¸€åŒ–æ˜¾ç¤º</span></span>
<span id="cb19-299"><a href="#cb19-299" aria-hidden="true" tabindex="-1"></a>                img <span class="op">=</span> inputs.cpu().data[j]</span>
<span id="cb19-300"><a href="#cb19-300" aria-hidden="true" tabindex="-1"></a>                img <span class="op">=</span> img.numpy().transpose((<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>))</span>
<span id="cb19-301"><a href="#cb19-301" aria-hidden="true" tabindex="-1"></a>                mean <span class="op">=</span> np.array([<span class="fl">0.485</span>, <span class="fl">0.456</span>, <span class="fl">0.406</span>])</span>
<span id="cb19-302"><a href="#cb19-302" aria-hidden="true" tabindex="-1"></a>                std <span class="op">=</span> np.array([<span class="fl">0.229</span>, <span class="fl">0.224</span>, <span class="fl">0.225</span>])</span>
<span id="cb19-303"><a href="#cb19-303" aria-hidden="true" tabindex="-1"></a>                img <span class="op">=</span> std <span class="op">*</span> img <span class="op">+</span> mean</span>
<span id="cb19-304"><a href="#cb19-304" aria-hidden="true" tabindex="-1"></a>                img <span class="op">=</span> np.clip(img, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb19-305"><a href="#cb19-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-306"><a href="#cb19-306" aria-hidden="true" tabindex="-1"></a>                ax.imshow(img)</span>
<span id="cb19-307"><a href="#cb19-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-308"><a href="#cb19-308" aria-hidden="true" tabindex="-1"></a>                <span class="co"># æ ‡é¢˜ï¼šé¢„æµ‹ vs çœŸå®</span></span>
<span id="cb19-309"><a href="#cb19-309" aria-hidden="true" tabindex="-1"></a>                color <span class="op">=</span> <span class="st">'green'</span> <span class="cf">if</span> preds[j] <span class="op">==</span> labels[j] <span class="cf">else</span> <span class="st">'red'</span></span>
<span id="cb19-310"><a href="#cb19-310" aria-hidden="true" tabindex="-1"></a>                ax.set_title(<span class="ss">f'Pred: </span><span class="sc">{</span>class_names[preds[j]]<span class="sc">}</span><span class="ch">\n</span><span class="ss">True: </span><span class="sc">{</span>class_names[labels[j]]<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb19-311"><a href="#cb19-311" aria-hidden="true" tabindex="-1"></a>                           color<span class="op">=</span>color, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb19-312"><a href="#cb19-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-313"><a href="#cb19-313" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> images_so_far <span class="op">==</span> num_images:</span>
<span id="cb19-314"><a href="#cb19-314" aria-hidden="true" tabindex="-1"></a>                    plt.tight_layout()</span>
<span id="cb19-315"><a href="#cb19-315" aria-hidden="true" tabindex="-1"></a>                    plt.savefig(<span class="st">'predictions.png'</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb19-316"><a href="#cb19-316" aria-hidden="true" tabindex="-1"></a>                    plt.show()</span>
<span id="cb19-317"><a href="#cb19-317" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span></span>
<span id="cb19-318"><a href="#cb19-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-319"><a href="#cb19-319" aria-hidden="true" tabindex="-1"></a><span class="co"># ==================== ä¸»ç¨‹åº ====================</span></span>
<span id="cb19-320"><a href="#cb19-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-321"><a href="#cb19-321" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb19-322"><a href="#cb19-322" aria-hidden="true" tabindex="-1"></a>    <span class="co"># å¯¹æ¯”ä¸åŒç­–ç•¥</span></span>
<span id="cb19-323"><a href="#cb19-323" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> compare_strategies()</span>
<span id="cb19-324"><a href="#cb19-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-325"><a href="#cb19-325" aria-hidden="true" tabindex="-1"></a>    <span class="co"># å¯è§†åŒ–æœ€ä½³æ¨¡å‹çš„é¢„æµ‹</span></span>
<span id="cb19-326"><a href="#cb19-326" aria-hidden="true" tabindex="-1"></a>    best_strategy <span class="op">=</span> <span class="bu">max</span>(results.items(),</span>
<span id="cb19-327"><a href="#cb19-327" aria-hidden="true" tabindex="-1"></a>                       key<span class="op">=</span><span class="kw">lambda</span> x: <span class="bu">max</span>(x[<span class="dv">1</span>][<span class="st">'history'</span>][<span class="st">'val_acc'</span>]))</span>
<span id="cb19-328"><a href="#cb19-328" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'</span><span class="ch">\n</span><span class="ss">æœ€ä½³ç­–ç•¥: </span><span class="sc">{</span>best_strategy[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb19-329"><a href="#cb19-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-330"><a href="#cb19-330" aria-hidden="true" tabindex="-1"></a>    visualize_predictions(best_strategy[<span class="dv">1</span>][<span class="st">'model'</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
</section>
</section>
<section id="è‡ªç„¶è¯­è¨€å¤„ç†ä¸­çš„è¿ç§»å­¦ä¹ " class="level2">
<h2 class="anchored" data-anchor-id="è‡ªç„¶è¯­è¨€å¤„ç†ä¸­çš„è¿ç§»å­¦ä¹ ">9.4 è‡ªç„¶è¯­è¨€å¤„ç†ä¸­çš„è¿ç§»å­¦ä¹ </h2>
<section id="é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹" class="level3">
<h3 class="anchored" data-anchor-id="é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹">ğŸ“ é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹</h3>
<p><strong>å‘å±•å†ç¨‹</strong>ï¼š</p>
<pre><code>2013: Word2Vec, GloVe
      â†“
2018: ELMo (åŠ¨æ€è¯å‘é‡)
      â†“
2018: BERT (åŒå‘é¢„è®­ç»ƒ)
      â†“
2019: GPT-2 (å¤§è§„æ¨¡ç”Ÿæˆ)
      â†“
2020: GPT-3 (è¶…å¤§è§„æ¨¡)
      â†“
2023: ChatGPT, GPT-4</code></pre>
</section>
<section id="ä½¿ç”¨-hugging-face-transformers" class="level3">
<h3 class="anchored" data-anchor-id="ä½¿ç”¨-hugging-face-transformers">ğŸ”¹ ä½¿ç”¨ Hugging Face Transformers</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> (</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    BertTokenizer, BertForSequenceClassification,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    GPT2Tokenizer, GPT2LMHeadModel,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    AutoTokenizer, AutoModelForSequenceClassification,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    Trainer, TrainingArguments</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="co"># ==================== æ•°æ®é›†å®šä¹‰ ====================</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TextClassificationDataset(Dataset):</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, texts, labels, tokenizer, max_length<span class="op">=</span><span class="dv">128</span>):</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.texts <span class="op">=</span> texts</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.labels <span class="op">=</span> labels</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.tokenizer <span class="op">=</span> tokenizer</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.max_length <span class="op">=</span> max_length</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.texts)</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx):</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>        text <span class="op">=</span> <span class="va">self</span>.texts[idx]</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>        label <span class="op">=</span> <span class="va">self</span>.labels[idx]</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>        encoding <span class="op">=</span> <span class="va">self</span>.tokenizer(</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>            text,</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>            max_length<span class="op">=</span><span class="va">self</span>.max_length,</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>            padding<span class="op">=</span><span class="st">'max_length'</span>,</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>            truncation<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>            return_tensors<span class="op">=</span><span class="st">'pt'</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>            <span class="st">'input_ids'</span>: encoding[<span class="st">'input_ids'</span>].squeeze(),</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>            <span class="st">'attention_mask'</span>: encoding[<span class="st">'attention_mask'</span>].squeeze(),</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>            <span class="st">'labels'</span>: torch.tensor(label, dtype<span class="op">=</span>torch.<span class="bu">long</span>)</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a><span class="co"># ==================== BERT å¾®è°ƒ ====================</span></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fine_tune_bert(train_texts, train_labels, val_texts, val_labels,</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>                   num_labels<span class="op">=</span><span class="dv">2</span>, epochs<span class="op">=</span><span class="dv">3</span>):</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a><span class="co">    BERT å¾®è°ƒç”¨äºæ–‡æœ¬åˆ†ç±»</span></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># åŠ è½½é¢„è®­ç»ƒæ¨¡å‹å’Œåˆ†è¯å™¨</span></span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>    model_name <span class="op">=</span> <span class="st">'bert-base-uncased'</span></span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>    tokenizer <span class="op">=</span> BertTokenizer.from_pretrained(model_name)</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> BertForSequenceClassification.from_pretrained(</span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>        model_name,</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>        num_labels<span class="op">=</span>num_labels</span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># åˆ›å»ºæ•°æ®é›†</span></span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>    train_dataset <span class="op">=</span> TextClassificationDataset(</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>        train_texts, train_labels, tokenizer</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>    val_dataset <span class="op">=</span> TextClassificationDataset(</span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>        val_texts, val_labels, tokenizer</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># è®­ç»ƒå‚æ•°</span></span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>    training_args <span class="op">=</span> TrainingArguments(</span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>        output_dir<span class="op">=</span><span class="st">'./results'</span>,</span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>        num_train_epochs<span class="op">=</span>epochs,</span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>        per_device_train_batch_size<span class="op">=</span><span class="dv">16</span>,</span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>        per_device_eval_batch_size<span class="op">=</span><span class="dv">64</span>,</span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a>        warmup_steps<span class="op">=</span><span class="dv">500</span>,</span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>        weight_decay<span class="op">=</span><span class="fl">0.01</span>,</span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>        logging_dir<span class="op">=</span><span class="st">'./logs'</span>,</span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a>        logging_steps<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>        evaluation_strategy<span class="op">=</span><span class="st">'epoch'</span>,</span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a>        save_strategy<span class="op">=</span><span class="st">'epoch'</span>,</span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a>        load_best_model_at_end<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a>        learning_rate<span class="op">=</span><span class="fl">2e-5</span>,</span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># å®šä¹‰è¯„ä¼°æŒ‡æ ‡</span></span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> compute_metrics(eval_pred):</span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a>        predictions, labels <span class="op">=</span> eval_pred</span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a>        predictions <span class="op">=</span> np.argmax(predictions, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a>        accuracy <span class="op">=</span> (predictions <span class="op">==</span> labels).mean()</span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">'accuracy'</span>: accuracy}</span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a>    <span class="co"># è®­ç»ƒå™¨</span></span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a>    trainer <span class="op">=</span> Trainer(</span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a>        model<span class="op">=</span>model,</span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true" tabindex="-1"></a>        args<span class="op">=</span>training_args,</span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true" tabindex="-1"></a>        train_dataset<span class="op">=</span>train_dataset,</span>
<span id="cb21-92"><a href="#cb21-92" aria-hidden="true" tabindex="-1"></a>        eval_dataset<span class="op">=</span>val_dataset,</span>
<span id="cb21-93"><a href="#cb21-93" aria-hidden="true" tabindex="-1"></a>        compute_metrics<span class="op">=</span>compute_metrics</span>
<span id="cb21-94"><a href="#cb21-94" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-95"><a href="#cb21-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-96"><a href="#cb21-96" aria-hidden="true" tabindex="-1"></a>    <span class="co"># è®­ç»ƒ</span></span>
<span id="cb21-97"><a href="#cb21-97" aria-hidden="true" tabindex="-1"></a>    trainer.train()</span>
<span id="cb21-98"><a href="#cb21-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-99"><a href="#cb21-99" aria-hidden="true" tabindex="-1"></a>    <span class="co"># è¯„ä¼°</span></span>
<span id="cb21-100"><a href="#cb21-100" aria-hidden="true" tabindex="-1"></a>    eval_results <span class="op">=</span> trainer.evaluate()</span>
<span id="cb21-101"><a href="#cb21-101" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">è¯„ä¼°ç»“æœ: </span><span class="sc">{</span>eval_results<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-102"><a href="#cb21-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-103"><a href="#cb21-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model, tokenizer</span>
<span id="cb21-104"><a href="#cb21-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-105"><a href="#cb21-105" aria-hidden="true" tabindex="-1"></a><span class="co"># ==================== å®æˆ˜ç¤ºä¾‹ï¼šæƒ…æ„Ÿåˆ†æ ====================</span></span>
<span id="cb21-106"><a href="#cb21-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-107"><a href="#cb21-107" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sentiment_analysis_example():</span>
<span id="cb21-108"><a href="#cb21-108" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""æƒ…æ„Ÿåˆ†æå®Œæ•´ç¤ºä¾‹"""</span></span>
<span id="cb21-109"><a href="#cb21-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-110"><a href="#cb21-110" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ç¤ºä¾‹æ•°æ®ï¼ˆå®é™…åº”ä½¿ç”¨ IMDB ç­‰æ•°æ®é›†ï¼‰</span></span>
<span id="cb21-111"><a href="#cb21-111" aria-hidden="true" tabindex="-1"></a>    train_texts <span class="op">=</span> [</span>
<span id="cb21-112"><a href="#cb21-112" aria-hidden="true" tabindex="-1"></a>        <span class="st">"This movie is fantastic! I loved it."</span>,</span>
<span id="cb21-113"><a href="#cb21-113" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Great film, highly recommended."</span>,</span>
<span id="cb21-114"><a href="#cb21-114" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Amazing performance by the actors."</span>,</span>
<span id="cb21-115"><a href="#cb21-115" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Terrible waste of time."</span>,</span>
<span id="cb21-116"><a href="#cb21-116" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Boring and predictable plot."</span>,</span>
<span id="cb21-117"><a href="#cb21-117" aria-hidden="true" tabindex="-1"></a>        <span class="st">"I hated every minute of it."</span></span>
<span id="cb21-118"><a href="#cb21-118" aria-hidden="true" tabindex="-1"></a>    ] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb21-119"><a href="#cb21-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-120"><a href="#cb21-120" aria-hidden="true" tabindex="-1"></a>    train_labels <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>] <span class="op">*</span> <span class="dv">100</span>  <span class="co"># 1=æ­£é¢, 0=è´Ÿé¢</span></span>
<span id="cb21-121"><a href="#cb21-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-122"><a href="#cb21-122" aria-hidden="true" tabindex="-1"></a>    val_texts <span class="op">=</span> [</span>
<span id="cb21-123"><a href="#cb21-123" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Excellent movie!"</span>,</span>
<span id="cb21-124"><a href="#cb21-124" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Not worth watching."</span>,</span>
<span id="cb21-125"><a href="#cb21-125" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Pretty good film."</span>,</span>
<span id="cb21-126"><a href="#cb21-126" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Absolutely awful."</span></span>
<span id="cb21-127"><a href="#cb21-127" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb21-128"><a href="#cb21-128" aria-hidden="true" tabindex="-1"></a>    val_labels <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>]</span>
<span id="cb21-129"><a href="#cb21-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-130"><a href="#cb21-130" aria-hidden="true" tabindex="-1"></a>    <span class="co"># å¾®è°ƒ BERT</span></span>
<span id="cb21-131"><a href="#cb21-131" aria-hidden="true" tabindex="-1"></a>    model, tokenizer <span class="op">=</span> fine_tune_bert(</span>
<span id="cb21-132"><a href="#cb21-132" aria-hidden="true" tabindex="-1"></a>        train_texts, train_labels,</span>
<span id="cb21-133"><a href="#cb21-133" aria-hidden="true" tabindex="-1"></a>        val_texts, val_labels,</span>
<span id="cb21-134"><a href="#cb21-134" aria-hidden="true" tabindex="-1"></a>        num_labels<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb21-135"><a href="#cb21-135" aria-hidden="true" tabindex="-1"></a>        epochs<span class="op">=</span><span class="dv">3</span></span>
<span id="cb21-136"><a href="#cb21-136" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-137"><a href="#cb21-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-138"><a href="#cb21-138" aria-hidden="true" tabindex="-1"></a>    <span class="co"># é¢„æµ‹å‡½æ•°</span></span>
<span id="cb21-139"><a href="#cb21-139" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict(text):</span>
<span id="cb21-140"><a href="#cb21-140" aria-hidden="true" tabindex="-1"></a>        encoding <span class="op">=</span> tokenizer(</span>
<span id="cb21-141"><a href="#cb21-141" aria-hidden="true" tabindex="-1"></a>            text,</span>
<span id="cb21-142"><a href="#cb21-142" aria-hidden="true" tabindex="-1"></a>            max_length<span class="op">=</span><span class="dv">128</span>,</span>
<span id="cb21-143"><a href="#cb21-143" aria-hidden="true" tabindex="-1"></a>            padding<span class="op">=</span><span class="st">'max_length'</span>,</span>
<span id="cb21-144"><a href="#cb21-144" aria-hidden="true" tabindex="-1"></a>            truncation<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb21-145"><a href="#cb21-145" aria-hidden="true" tabindex="-1"></a>            return_tensors<span class="op">=</span><span class="st">'pt'</span></span>
<span id="cb21-146"><a href="#cb21-146" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb21-147"><a href="#cb21-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-148"><a href="#cb21-148" aria-hidden="true" tabindex="-1"></a>        model.<span class="bu">eval</span>()</span>
<span id="cb21-149"><a href="#cb21-149" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb21-150"><a href="#cb21-150" aria-hidden="true" tabindex="-1"></a>            outputs <span class="op">=</span> model(<span class="op">**</span>encoding)</span>
<span id="cb21-151"><a href="#cb21-151" aria-hidden="true" tabindex="-1"></a>            predictions <span class="op">=</span> torch.softmax(outputs.logits, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb21-152"><a href="#cb21-152" aria-hidden="true" tabindex="-1"></a>            label <span class="op">=</span> torch.argmax(predictions, dim<span class="op">=</span><span class="dv">1</span>).item()</span>
<span id="cb21-153"><a href="#cb21-153" aria-hidden="true" tabindex="-1"></a>            confidence <span class="op">=</span> predictions[<span class="dv">0</span>][label].item()</span>
<span id="cb21-154"><a href="#cb21-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-155"><a href="#cb21-155" aria-hidden="true" tabindex="-1"></a>        sentiment <span class="op">=</span> <span class="st">"æ­£é¢"</span> <span class="cf">if</span> label <span class="op">==</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">"è´Ÿé¢"</span></span>
<span id="cb21-156"><a href="#cb21-156" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> sentiment, confidence</span>
<span id="cb21-157"><a href="#cb21-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-158"><a href="#cb21-158" aria-hidden="true" tabindex="-1"></a>    <span class="co"># æµ‹è¯•</span></span>
<span id="cb21-159"><a href="#cb21-159" aria-hidden="true" tabindex="-1"></a>    test_texts <span class="op">=</span> [</span>
<span id="cb21-160"><a href="#cb21-160" aria-hidden="true" tabindex="-1"></a>        <span class="st">"This is an amazing movie!"</span>,</span>
<span id="cb21-161"><a href="#cb21-161" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Worst film I've ever seen."</span>,</span>
<span id="cb21-162"><a href="#cb21-162" aria-hidden="true" tabindex="-1"></a>        <span class="st">"It was okay, nothing special."</span></span>
<span id="cb21-163"><a href="#cb21-163" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb21-164"><a href="#cb21-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-165"><a href="#cb21-165" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">é¢„æµ‹ç»“æœ:"</span>)</span>
<span id="cb21-166"><a href="#cb21-166" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> text <span class="kw">in</span> test_texts:</span>
<span id="cb21-167"><a href="#cb21-167" aria-hidden="true" tabindex="-1"></a>        sentiment, confidence <span class="op">=</span> predict(text)</span>
<span id="cb21-168"><a href="#cb21-168" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">æ–‡æœ¬: </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-169"><a href="#cb21-169" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"æƒ…æ„Ÿ: </span><span class="sc">{</span>sentiment<span class="sc">}</span><span class="ss"> (ç½®ä¿¡åº¦: </span><span class="sc">{</span>confidence<span class="sc">:.4f}</span><span class="ss">)"</span>)</span>
<span id="cb21-170"><a href="#cb21-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-171"><a href="#cb21-171" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model, tokenizer</span>
<span id="cb21-172"><a href="#cb21-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-173"><a href="#cb21-173" aria-hidden="true" tabindex="-1"></a><span class="co"># è¿è¡Œç¤ºä¾‹</span></span>
<span id="cb21-174"><a href="#cb21-174" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb21-175"><a href="#cb21-175" aria-hidden="true" tabindex="-1"></a>    model, tokenizer <span class="op">=</span> sentiment_analysis_example()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
</section>
</section>
<section id="é¢†åŸŸè‡ªé€‚åº”-domain-adaptation" class="level2">
<h2 class="anchored" data-anchor-id="é¢†åŸŸè‡ªé€‚åº”-domain-adaptation">9.5 é¢†åŸŸè‡ªé€‚åº” (Domain Adaptation)</h2>
<section id="é—®é¢˜è®¾å®š" class="level3">
<h3 class="anchored" data-anchor-id="é—®é¢˜è®¾å®š">ğŸ¯ é—®é¢˜è®¾å®š</h3>
<pre><code>æºé¢†åŸŸï¼šæœ‰å¤§é‡æ ‡æ³¨æ•°æ®
ç›®æ ‡é¢†åŸŸï¼šæ•°æ®åˆ†å¸ƒä¸åŒï¼Œæ ‡æ³¨å°‘æˆ–æ— 

ä¾‹å­ï¼š
  æºï¼šæ–°é—»æ–‡æœ¬åˆ†ç±»
  ç›®æ ‡ï¼šç¤¾äº¤åª’ä½“æ–‡æœ¬åˆ†ç±»</code></pre>
</section>
<section id="æ–¹æ³•åˆ†ç±»" class="level3">
<h3 class="anchored" data-anchor-id="æ–¹æ³•åˆ†ç±»">ğŸ“ æ–¹æ³•åˆ†ç±»</h3>
<section id="åŸºäºå®ä¾‹çš„æ–¹æ³•" class="level4">
<h4 class="anchored" data-anchor-id="åŸºäºå®ä¾‹çš„æ–¹æ³•"><strong>1. åŸºäºå®ä¾‹çš„æ–¹æ³•</strong></h4>
<p><strong>é‡è¦æ€§åŠ æƒ</strong>ï¼š</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ImportanceWeightedLoss(nn.Module):</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""æ ¹æ®æ ·æœ¬ç›¸ä¼¼åº¦åŠ æƒæŸå¤±"""</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, base_criterion):</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.base_criterion <span class="op">=</span> base_criterion</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> compute_weights(<span class="va">self</span>, source_features, target_features):</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co">        è®¡ç®—æºåŸŸæ ·æœ¬çš„é‡è¦æ€§æƒé‡</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co">        ä½¿å¾—æºåŸŸåˆ†å¸ƒæ¥è¿‘ç›®æ ‡åŸŸ</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ç®€åŒ–ç‰ˆï¼šåŸºäºç‰¹å¾è·ç¦»</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>        distances <span class="op">=</span> torch.cdist(source_features, target_features)</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>        min_distances <span class="op">=</span> distances.<span class="bu">min</span>(dim<span class="op">=</span><span class="dv">1</span>)[<span class="dv">0</span>]</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">=</span> torch.exp(<span class="op">-</span>min_distances)</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">=</span> weights <span class="op">/</span> weights.<span class="bu">sum</span>()</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> weights</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, outputs, targets, weights):</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> <span class="va">self</span>.base_criterion(outputs, targets)</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>        weighted_loss <span class="op">=</span> (loss <span class="op">*</span> weights).mean()</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> weighted_loss</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
</section>
<section id="åŸºäºç‰¹å¾çš„æ–¹æ³•" class="level4">
<h4 class="anchored" data-anchor-id="åŸºäºç‰¹å¾çš„æ–¹æ³•"><strong>2. åŸºäºç‰¹å¾çš„æ–¹æ³•</strong></h4>
<p><strong>é¢†åŸŸå¯¹æŠ—è®­ç»ƒ (Domain Adversarial Training)</strong>ï¼š</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GradientReversalLayer(torch.autograd.Function):</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""æ¢¯åº¦åè½¬å±‚"""</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(ctx, x, alpha):</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>        ctx.alpha <span class="op">=</span> alpha</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x.view_as(x)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> backward(ctx, grad_output):</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> grad_output.neg() <span class="op">*</span> ctx.alpha</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> output, <span class="va">None</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DomainAdversarialNetwork(nn.Module):</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""é¢†åŸŸå¯¹æŠ—ç½‘ç»œ"""</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, input_size, hidden_size, num_classes):</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ç‰¹å¾æå–å™¨ï¼ˆå…±äº«ï¼‰</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.feature_extractor <span class="op">=</span> nn.Sequential(</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>            nn.Linear(input_size, hidden_size),</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(<span class="fl">0.5</span>),</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>            nn.Linear(hidden_size, hidden_size),</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>            nn.ReLU()</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># æ ‡ç­¾é¢„æµ‹å™¨</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.label_predictor <span class="op">=</span> nn.Sequential(</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(<span class="fl">0.5</span>),</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>            nn.Linear(hidden_size, num_classes)</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># åŸŸåˆ†ç±»å™¨</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.domain_classifier <span class="op">=</span> nn.Sequential(</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>            nn.Linear(hidden_size, hidden_size),</span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(<span class="fl">0.5</span>),</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>            nn.Linear(hidden_size, <span class="dv">2</span>)  <span class="co"># 2ä¸ªåŸŸ</span></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x, alpha<span class="op">=</span><span class="fl">1.0</span>):</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ç‰¹å¾æå–</span></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>        features <span class="op">=</span> <span class="va">self</span>.feature_extractor(x)</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># æ ‡ç­¾é¢„æµ‹</span></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>        class_output <span class="op">=</span> <span class="va">self</span>.label_predictor(features)</span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>        <span class="co"># åŸŸåˆ†ç±»ï¼ˆæ¢¯åº¦åè½¬ï¼‰</span></span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>        reverse_features <span class="op">=</span> GradientReversalLayer.<span class="bu">apply</span>(features, alpha)</span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>        domain_output <span class="op">=</span> <span class="va">self</span>.domain_classifier(reverse_features)</span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> class_output, domain_output</span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a><span class="co"># è®­ç»ƒ</span></span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_domain_adaptation(model, source_loader, target_loader,</span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a>                            num_epochs<span class="op">=</span><span class="dv">50</span>):</span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""é¢†åŸŸè‡ªé€‚åº”è®­ç»ƒ"""</span></span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span><span class="fl">0.001</span>)</span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a>    class_criterion <span class="op">=</span> nn.CrossEntropyLoss()</span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a>    domain_criterion <span class="op">=</span> nn.CrossEntropyLoss()</span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(num_epochs):</span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a>        model.train()</span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (source_data, source_labels), (target_data, _) <span class="kw">in</span> <span class="bu">zip</span>(source_loader, target_loader):</span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Alpha éšç€è®­ç»ƒå¢åŠ ï¼ˆä» 0 åˆ° 1ï¼‰</span></span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a>            p <span class="op">=</span> <span class="bu">float</span>(epoch) <span class="op">/</span> num_epochs</span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a>            alpha <span class="op">=</span> <span class="fl">2.</span> <span class="op">/</span> (<span class="fl">1.</span> <span class="op">+</span> np.exp(<span class="op">-</span><span class="dv">10</span> <span class="op">*</span> p)) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a>            <span class="co"># æºåŸŸæ•°æ®</span></span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a>            class_output_s, domain_output_s <span class="op">=</span> model(source_data, alpha)</span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a>            <span class="co"># ç›®æ ‡åŸŸæ•°æ®</span></span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a>            _, domain_output_t <span class="op">=</span> model(target_data, alpha)</span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-80"><a href="#cb24-80" aria-hidden="true" tabindex="-1"></a>            <span class="co"># åŸŸæ ‡ç­¾ï¼šæº=0ï¼Œç›®æ ‡=1</span></span>
<span id="cb24-81"><a href="#cb24-81" aria-hidden="true" tabindex="-1"></a>            domain_label_s <span class="op">=</span> torch.zeros(<span class="bu">len</span>(source_data)).<span class="bu">long</span>()</span>
<span id="cb24-82"><a href="#cb24-82" aria-hidden="true" tabindex="-1"></a>            domain_label_t <span class="op">=</span> torch.ones(<span class="bu">len</span>(target_data)).<span class="bu">long</span>()</span>
<span id="cb24-83"><a href="#cb24-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-84"><a href="#cb24-84" aria-hidden="true" tabindex="-1"></a>            <span class="co"># è®¡ç®—æŸå¤±</span></span>
<span id="cb24-85"><a href="#cb24-85" aria-hidden="true" tabindex="-1"></a>            class_loss <span class="op">=</span> class_criterion(class_output_s, source_labels)</span>
<span id="cb24-86"><a href="#cb24-86" aria-hidden="true" tabindex="-1"></a>            domain_loss_s <span class="op">=</span> domain_criterion(domain_output_s, domain_label_s)</span>
<span id="cb24-87"><a href="#cb24-87" aria-hidden="true" tabindex="-1"></a>            domain_loss_t <span class="op">=</span> domain_criterion(domain_output_t, domain_label_t)</span>
<span id="cb24-88"><a href="#cb24-88" aria-hidden="true" tabindex="-1"></a>            domain_loss <span class="op">=</span> domain_loss_s <span class="op">+</span> domain_loss_t</span>
<span id="cb24-89"><a href="#cb24-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-90"><a href="#cb24-90" aria-hidden="true" tabindex="-1"></a>            total_loss <span class="op">=</span> class_loss <span class="op">+</span> domain_loss</span>
<span id="cb24-91"><a href="#cb24-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-92"><a href="#cb24-92" aria-hidden="true" tabindex="-1"></a>            <span class="co"># åå‘ä¼ æ’­</span></span>
<span id="cb24-93"><a href="#cb24-93" aria-hidden="true" tabindex="-1"></a>            optimizer.zero_grad()</span>
<span id="cb24-94"><a href="#cb24-94" aria-hidden="true" tabindex="-1"></a>            total_loss.backward()</span>
<span id="cb24-95"><a href="#cb24-95" aria-hidden="true" tabindex="-1"></a>            optimizer.step()</span>
<span id="cb24-96"><a href="#cb24-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-97"><a href="#cb24-97" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> epoch <span class="op">%</span> <span class="dv">10</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb24-98"><a href="#cb24-98" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f'Epoch </span><span class="sc">{</span>epoch<span class="sc">}</span><span class="ss">: Class Loss=</span><span class="sc">{</span>class_loss<span class="sc">.</span>item()<span class="sc">:.4f}</span><span class="ss">, '</span></span>
<span id="cb24-99"><a href="#cb24-99" aria-hidden="true" tabindex="-1"></a>                      <span class="ss">f'Domain Loss=</span><span class="sc">{</span>domain_loss<span class="sc">.</span>item()<span class="sc">:.4f}</span><span class="ss">'</span>)</span>
<span id="cb24-100"><a href="#cb24-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-101"><a href="#cb24-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
</section>
<section id="è‡ªè®­ç»ƒ-self-training" class="level4">
<h4 class="anchored" data-anchor-id="è‡ªè®­ç»ƒ-self-training"><strong>3. è‡ªè®­ç»ƒ (Self-Training)</strong></h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SelfTraining:</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""è‡ªè®­ç»ƒ/ä¼ªæ ‡ç­¾æ–¹æ³•"""</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, model, confidence_threshold<span class="op">=</span><span class="fl">0.9</span>):</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> model</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.threshold <span class="op">=</span> confidence_threshold</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> generate_pseudo_labels(<span class="va">self</span>, unlabeled_loader):</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""ç”Ÿæˆä¼ªæ ‡ç­¾"""</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model.<span class="bu">eval</span>()</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>        pseudo_data <span class="op">=</span> []</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>        pseudo_labels <span class="op">=</span> []</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> data <span class="kw">in</span> unlabeled_loader:</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>                outputs <span class="op">=</span> <span class="va">self</span>.model(data)</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>                probs <span class="op">=</span> torch.softmax(outputs, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>                <span class="co"># åªé€‰æ‹©é«˜ç½®ä¿¡åº¦æ ·æœ¬</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>                max_probs, predictions <span class="op">=</span> torch.<span class="bu">max</span>(probs, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>                mask <span class="op">=</span> max_probs <span class="op">&gt;</span> <span class="va">self</span>.threshold</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>                pseudo_data.append(data[mask])</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>                pseudo_labels.append(predictions[mask])</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> torch.cat(pseudo_data), torch.cat(pseudo_labels)</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> train(<span class="va">self</span>, labeled_loader, unlabeled_loader, num_iterations<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""è¿­ä»£è®­ç»ƒ"""</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>        optimizer <span class="op">=</span> torch.optim.Adam(<span class="va">self</span>.model.parameters(), lr<span class="op">=</span><span class="fl">0.001</span>)</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>        criterion <span class="op">=</span> nn.CrossEntropyLoss()</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> iteration <span class="kw">in</span> <span class="bu">range</span>(num_iterations):</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f'</span><span class="ch">\n</span><span class="ss">=== Iteration </span><span class="sc">{</span>iteration<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>num_iterations<span class="sc">}</span><span class="ss"> ==='</span>)</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>            <span class="co"># åœ¨æ ‡æ³¨æ•°æ®ä¸Šè®­ç»ƒ</span></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.model.train()</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> data, labels <span class="kw">in</span> labeled_loader:</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>                outputs <span class="op">=</span> <span class="va">self</span>.model(data)</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>                loss <span class="op">=</span> criterion(outputs, labels)</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>                optimizer.zero_grad()</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>                loss.backward()</span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>                optimizer.step()</span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a>            <span class="co"># ç”Ÿæˆä¼ªæ ‡ç­¾</span></span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>            pseudo_data, pseudo_labels <span class="op">=</span> <span class="va">self</span>.generate_pseudo_labels(unlabeled_loader)</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(pseudo_data) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f'ç”Ÿæˆäº† </span><span class="sc">{</span><span class="bu">len</span>(pseudo_data)<span class="sc">}</span><span class="ss"> ä¸ªä¼ªæ ‡ç­¾'</span>)</span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>                <span class="co"># åœ¨ä¼ªæ ‡ç­¾æ•°æ®ä¸Šè®­ç»ƒ</span></span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>                pseudo_dataset <span class="op">=</span> torch.utils.data.TensorDataset(</span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>                    pseudo_data, pseudo_labels</span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a>                pseudo_loader <span class="op">=</span> torch.utils.data.DataLoader(</span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>                    pseudo_dataset, batch_size<span class="op">=</span><span class="dv">32</span>, shuffle<span class="op">=</span><span class="va">True</span></span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.model.train()</span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> data, labels <span class="kw">in</span> pseudo_loader:</span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a>                    outputs <span class="op">=</span> <span class="va">self</span>.model(data)</span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a>                    loss <span class="op">=</span> criterion(outputs, labels)</span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a>                    optimizer.zero_grad()</span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a>                    loss.backward()</span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a>                    optimizer.step()</span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.model</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
</section>
</section>
</section>
<section id="å°‘æ ·æœ¬å­¦ä¹ -few-shot-learning" class="level2">
<h2 class="anchored" data-anchor-id="å°‘æ ·æœ¬å­¦ä¹ -few-shot-learning">9.6 å°‘æ ·æœ¬å­¦ä¹  (Few-Shot Learning)</h2>
<section id="é—®é¢˜å®šä¹‰" class="level3">
<h3 class="anchored" data-anchor-id="é—®é¢˜å®šä¹‰">ğŸ¯ é—®é¢˜å®šä¹‰</h3>
<pre><code>N-way K-shot åˆ†ç±»ï¼š
  N: ç±»åˆ«æ•°
  K: æ¯ç±»çš„æ ·æœ¬æ•°

ä¾‹ï¼š5-way 1-shot
  5ä¸ªç±»åˆ«ï¼Œæ¯ç±»åªæœ‰1ä¸ªæ ·æœ¬</code></pre>
</section>
<section id="å…ƒå­¦ä¹ -meta-learning" class="level3">
<h3 class="anchored" data-anchor-id="å…ƒå­¦ä¹ -meta-learning">ğŸ“ å…ƒå­¦ä¹  (Meta-Learning)</h3>
<p><strong>MAML (Model-Agnostic Meta-Learning)</strong>ï¼š</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MAML:</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""æ¨¡å‹æ— å…³çš„å…ƒå­¦ä¹ """</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, model, inner_lr<span class="op">=</span><span class="fl">0.01</span>, outer_lr<span class="op">=</span><span class="fl">0.001</span>):</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> model</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.inner_lr <span class="op">=</span> inner_lr  <span class="co"># ä»»åŠ¡å†…å­¦ä¹ ç‡</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.outer_lr <span class="op">=</span> outer_lr  <span class="co"># è·¨ä»»åŠ¡å­¦ä¹ ç‡</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.meta_optimizer <span class="op">=</span> torch.optim.Adam(</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>            model.parameters(), lr<span class="op">=</span>outer_lr</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> inner_loop(<span class="va">self</span>, support_x, support_y, num_steps<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="co">        ä»»åŠ¡å†…é€‚åº”ï¼ˆå¿«é€Ÿå­¦ä¹ ï¼‰</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="co">        å‚æ•°ï¼š</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="co">            support_x: æ”¯æŒé›†è¾“å…¥</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a><span class="co">            support_y: æ”¯æŒé›†æ ‡ç­¾</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a><span class="co">            num_steps: å†…å¾ªç¯æ­¥æ•°</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># å¤åˆ¶æ¨¡å‹å‚æ•°</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>        fast_weights <span class="op">=</span> [p.clone() <span class="cf">for</span> p <span class="kw">in</span> <span class="va">self</span>.model.parameters()]</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> step <span class="kw">in</span> <span class="bu">range</span>(num_steps):</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>            <span class="co"># å‰å‘ä¼ æ’­</span></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>            outputs <span class="op">=</span> <span class="va">self</span>.model(support_x)</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> nn.CrossEntropyLoss()(outputs, support_y)</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>            <span class="co"># è®¡ç®—æ¢¯åº¦</span></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>            grads <span class="op">=</span> torch.autograd.grad(</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>                loss, fast_weights, create_graph<span class="op">=</span><span class="va">True</span></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>            <span class="co"># æ›´æ–°å‚æ•°ï¼ˆä¸€æ­¥æ¢¯åº¦ä¸‹é™ï¼‰</span></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>            fast_weights <span class="op">=</span> [</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>                w <span class="op">-</span> <span class="va">self</span>.inner_lr <span class="op">*</span> g</span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> w, g <span class="kw">in</span> <span class="bu">zip</span>(fast_weights, grads)</span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> fast_weights</span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> outer_loop(<span class="va">self</span>, tasks, num_epochs<span class="op">=</span><span class="dv">1000</span>):</span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a><span class="co">        è·¨ä»»åŠ¡å­¦ä¹ ï¼ˆå…ƒå­¦ä¹ ï¼‰</span></span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a><span class="co">        å‚æ•°ï¼š</span></span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a><span class="co">            tasks: ä»»åŠ¡åˆ—è¡¨ï¼Œæ¯ä¸ªä»»åŠ¡åŒ…å« (support_set, query_set)</span></span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(num_epochs):</span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a>            meta_loss <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> task <span class="kw">in</span> tasks:</span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true" tabindex="-1"></a>                support_x, support_y <span class="op">=</span> task[<span class="st">'support'</span>]</span>
<span id="cb27-54"><a href="#cb27-54" aria-hidden="true" tabindex="-1"></a>                query_x, query_y <span class="op">=</span> task[<span class="st">'query'</span>]</span>
<span id="cb27-55"><a href="#cb27-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-56"><a href="#cb27-56" aria-hidden="true" tabindex="-1"></a>                <span class="co"># å†…å¾ªç¯ï¼šåœ¨æ”¯æŒé›†ä¸Šå¿«é€Ÿé€‚åº”</span></span>
<span id="cb27-57"><a href="#cb27-57" aria-hidden="true" tabindex="-1"></a>                fast_weights <span class="op">=</span> <span class="va">self</span>.inner_loop(support_x, support_y)</span>
<span id="cb27-58"><a href="#cb27-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-59"><a href="#cb27-59" aria-hidden="true" tabindex="-1"></a>                <span class="co"># åœ¨æŸ¥è¯¢é›†ä¸Šè¯„ä¼°</span></span>
<span id="cb27-60"><a href="#cb27-60" aria-hidden="true" tabindex="-1"></a>                <span class="co"># ä½¿ç”¨æ›´æ–°åçš„å‚æ•°</span></span>
<span id="cb27-61"><a href="#cb27-61" aria-hidden="true" tabindex="-1"></a>                outputs <span class="op">=</span> <span class="va">self</span>.model(query_x, weights<span class="op">=</span>fast_weights)</span>
<span id="cb27-62"><a href="#cb27-62" aria-hidden="true" tabindex="-1"></a>                loss <span class="op">=</span> nn.CrossEntropyLoss()(outputs, query_y)</span>
<span id="cb27-63"><a href="#cb27-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-64"><a href="#cb27-64" aria-hidden="true" tabindex="-1"></a>                meta_loss <span class="op">+=</span> loss</span>
<span id="cb27-65"><a href="#cb27-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-66"><a href="#cb27-66" aria-hidden="true" tabindex="-1"></a>            <span class="co"># å¤–å¾ªç¯ï¼šæ›´æ–°å…ƒå‚æ•°</span></span>
<span id="cb27-67"><a href="#cb27-67" aria-hidden="true" tabindex="-1"></a>            meta_loss <span class="op">=</span> meta_loss <span class="op">/</span> <span class="bu">len</span>(tasks)</span>
<span id="cb27-68"><a href="#cb27-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-69"><a href="#cb27-69" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.meta_optimizer.zero_grad()</span>
<span id="cb27-70"><a href="#cb27-70" aria-hidden="true" tabindex="-1"></a>            meta_loss.backward()</span>
<span id="cb27-71"><a href="#cb27-71" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.meta_optimizer.step()</span>
<span id="cb27-72"><a href="#cb27-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-73"><a href="#cb27-73" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> epoch <span class="op">%</span> <span class="dv">100</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb27-74"><a href="#cb27-74" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f'Epoch </span><span class="sc">{</span>epoch<span class="sc">}</span><span class="ss">: Meta Loss = </span><span class="sc">{</span>meta_loss<span class="sc">.</span>item()<span class="sc">:.4f}</span><span class="ss">'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
</section>
<section id="åŸå‹ç½‘ç»œ-prototypical-networks" class="level3">
<h3 class="anchored" data-anchor-id="åŸå‹ç½‘ç»œ-prototypical-networks">ğŸ“ åŸå‹ç½‘ç»œ (Prototypical Networks)</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PrototypicalNetwork(nn.Module):</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""åŸå‹ç½‘ç»œ"""</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, encoder):</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.encoder <span class="op">=</span> encoder</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> compute_prototypes(<span class="va">self</span>, support_x, support_y, n_way):</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="co">        è®¡ç®—æ¯ä¸ªç±»çš„åŸå‹ï¼ˆå‡å€¼ï¼‰</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="co">        å‚æ•°ï¼š</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="co">            support_x: (n_way * n_support, *)</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="co">            support_y: (n_way * n_support,)</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="co">            n_way: ç±»åˆ«æ•°</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ç¼–ç </span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>        embeddings <span class="op">=</span> <span class="va">self</span>.encoder(support_x)  <span class="co"># (n_way*n_support, d)</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># è®¡ç®—åŸå‹</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>        prototypes <span class="op">=</span> []</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> c <span class="kw">in</span> <span class="bu">range</span>(n_way):</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>            mask <span class="op">=</span> (support_y <span class="op">==</span> c)</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>            class_embeddings <span class="op">=</span> embeddings[mask]</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>            prototype <span class="op">=</span> class_embeddings.mean(dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>            prototypes.append(prototype)</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>        prototypes <span class="op">=</span> torch.stack(prototypes)  <span class="co"># (n_way, d)</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> prototypes</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, support_x, support_y, query_x, n_way):</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a><span class="co">        å‚æ•°ï¼š</span></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a><span class="co">            support_x: æ”¯æŒé›†è¾“å…¥</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a><span class="co">            support_y: æ”¯æŒé›†æ ‡ç­¾</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a><span class="co">            query_x: æŸ¥è¯¢é›†è¾“å…¥</span></span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a><span class="co">            n_way: ç±»åˆ«æ•°</span></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># è®¡ç®—åŸå‹</span></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>        prototypes <span class="op">=</span> <span class="va">self</span>.compute_prototypes(support_x, support_y, n_way)</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ç¼–ç æŸ¥è¯¢é›†</span></span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>        query_embeddings <span class="op">=</span> <span class="va">self</span>.encoder(query_x)  <span class="co"># (n_query, d)</span></span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># è®¡ç®—è·ç¦»ï¼ˆæ¬§æ°è·ç¦»ï¼‰</span></span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>        distances <span class="op">=</span> torch.cdist(query_embeddings, prototypes)  <span class="co"># (n_query, n_way)</span></span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># è½¬æ¢ä¸ºæ¦‚ç‡ï¼ˆè´Ÿè·ç¦»çš„ softmaxï¼‰</span></span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>        logits <span class="op">=</span> <span class="op">-</span>distances</span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> logits</span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a><span class="co"># è®­ç»ƒ</span></span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_prototypical_network(model, tasks, num_epochs<span class="op">=</span><span class="dv">1000</span>):</span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""è®­ç»ƒåŸå‹ç½‘ç»œ"""</span></span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span><span class="fl">0.001</span>)</span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a>    criterion <span class="op">=</span> nn.CrossEntropyLoss()</span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(num_epochs):</span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a>        total_loss <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a>        total_acc <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> task <span class="kw">in</span> tasks:</span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a>            support_x, support_y <span class="op">=</span> task[<span class="st">'support'</span>]</span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a>            query_x, query_y <span class="op">=</span> task[<span class="st">'query'</span>]</span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a>            n_way <span class="op">=</span> <span class="bu">len</span>(torch.unique(support_y))</span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a>            <span class="co"># å‰å‘ä¼ æ’­</span></span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a>            logits <span class="op">=</span> model(support_x, support_y, query_x, n_way)</span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a>            <span class="co"># è®¡ç®—æŸå¤±</span></span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> criterion(logits, query_y)</span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a>            <span class="co"># åå‘ä¼ æ’­</span></span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a>            optimizer.zero_grad()</span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a>            loss.backward()</span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a>            optimizer.step()</span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-80"><a href="#cb28-80" aria-hidden="true" tabindex="-1"></a>            <span class="co"># ç»Ÿè®¡</span></span>
<span id="cb28-81"><a href="#cb28-81" aria-hidden="true" tabindex="-1"></a>            total_loss <span class="op">+=</span> loss.item()</span>
<span id="cb28-82"><a href="#cb28-82" aria-hidden="true" tabindex="-1"></a>            preds <span class="op">=</span> torch.argmax(logits, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb28-83"><a href="#cb28-83" aria-hidden="true" tabindex="-1"></a>            total_acc <span class="op">+=</span> (preds <span class="op">==</span> query_y).<span class="bu">float</span>().mean().item()</span>
<span id="cb28-84"><a href="#cb28-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-85"><a href="#cb28-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> epoch <span class="op">%</span> <span class="dv">100</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb28-86"><a href="#cb28-86" aria-hidden="true" tabindex="-1"></a>            avg_loss <span class="op">=</span> total_loss <span class="op">/</span> <span class="bu">len</span>(tasks)</span>
<span id="cb28-87"><a href="#cb28-87" aria-hidden="true" tabindex="-1"></a>            avg_acc <span class="op">=</span> total_acc <span class="op">/</span> <span class="bu">len</span>(tasks)</span>
<span id="cb28-88"><a href="#cb28-88" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f'Epoch </span><span class="sc">{</span>epoch<span class="sc">}</span><span class="ss">: Loss=</span><span class="sc">{</span>avg_loss<span class="sc">:.4f}</span><span class="ss">, Acc=</span><span class="sc">{</span>avg_acc<span class="sc">:.4f}</span><span class="ss">'</span>)</span>
<span id="cb28-89"><a href="#cb28-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-90"><a href="#cb28-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
</section>
</section>
<section id="çŸ¥è¯†è’¸é¦-knowledge-distillation" class="level2">
<h2 class="anchored" data-anchor-id="çŸ¥è¯†è’¸é¦-knowledge-distillation">9.7 çŸ¥è¯†è’¸é¦ (Knowledge Distillation)</h2>
<section id="æ ¸å¿ƒæ€æƒ³" class="level3">
<h3 class="anchored" data-anchor-id="æ ¸å¿ƒæ€æƒ³">ğŸ¯ æ ¸å¿ƒæ€æƒ³</h3>
<pre><code>æ•™å¸ˆæ¨¡å‹ï¼ˆå¤§ï¼‰â†’ çŸ¥è¯† â†’ å­¦ç”Ÿæ¨¡å‹ï¼ˆå°ï¼‰

ç›®æ ‡ï¼š
  ç”¨å¤§æ¨¡å‹çš„"è½¯æ ‡ç­¾"è®­ç»ƒå°æ¨¡å‹
  å°æ¨¡å‹è·å¾—å¤§æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›</code></pre>
</section>
<section id="æ¸©åº¦-softmax" class="level3">
<h3 class="anchored" data-anchor-id="æ¸©åº¦-softmax">ğŸ“ æ¸©åº¦ Softmax</h3>
<pre><code>æ ‡å‡† Softmaxï¼š
  p_i = exp(z_i) / Î£_j exp(z_j)

æ¸©åº¦ Softmaxï¼š
  p_i = exp(z_i/T) / Î£_j exp(z_j/T)

T &gt; 1: è¾“å‡ºæ›´å¹³æ»‘ï¼ˆ"è½¯"æ ‡ç­¾ï¼‰
T = 1: æ ‡å‡† softmax
T â†’ âˆ: å‡åŒ€åˆ†å¸ƒ</code></pre>
</section>
<section id="å®ç°" class="level3">
<h3 class="anchored" data-anchor-id="å®ç°">ğŸ’» å®ç°</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DistillationLoss(nn.Module):</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""çŸ¥è¯†è’¸é¦æŸå¤±"""</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, temperature<span class="op">=</span><span class="fl">3.0</span>, alpha<span class="op">=</span><span class="fl">0.5</span>):</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.temperature <span class="op">=</span> temperature</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.alpha <span class="op">=</span> alpha</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.criterion <span class="op">=</span> nn.CrossEntropyLoss()</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.kl_div <span class="op">=</span> nn.KLDivLoss(reduction<span class="op">=</span><span class="st">'batchmean'</span>)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, student_logits, teacher_logits, targets):</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="co">        å‚æ•°ï¼š</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="co">            student_logits: å­¦ç”Ÿæ¨¡å‹è¾“å‡º</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="co">            teacher_logits: æ•™å¸ˆæ¨¡å‹è¾“å‡º</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="co">            targets: çœŸå®æ ‡ç­¾</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ç¡¬æ ‡ç­¾æŸå¤±</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>        hard_loss <span class="op">=</span> <span class="va">self</span>.criterion(student_logits, targets)</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># è½¯æ ‡ç­¾æŸå¤±ï¼ˆKL æ•£åº¦ï¼‰</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>        student_soft <span class="op">=</span> F.log_softmax(student_logits <span class="op">/</span> <span class="va">self</span>.temperature, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>        teacher_soft <span class="op">=</span> F.softmax(teacher_logits <span class="op">/</span> <span class="va">self</span>.temperature, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>        soft_loss <span class="op">=</span> <span class="va">self</span>.kl_div(student_soft, teacher_soft) <span class="op">*</span> (<span class="va">self</span>.temperature <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ç»„åˆæŸå¤±</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>        total_loss <span class="op">=</span> <span class="va">self</span>.alpha <span class="op">*</span> hard_loss <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> <span class="va">self</span>.alpha) <span class="op">*</span> soft_loss</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> total_loss</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> knowledge_distillation(teacher_model, student_model, train_loader,</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>                           num_epochs<span class="op">=</span><span class="dv">50</span>, temperature<span class="op">=</span><span class="fl">3.0</span>):</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a><span class="co">    çŸ¥è¯†è’¸é¦è®­ç»ƒ</span></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a><span class="co">    å‚æ•°ï¼š</span></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a><span class="co">        teacher_model: é¢„è®­ç»ƒçš„å¤§æ¨¡å‹</span></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a><span class="co">        student_model: å¾…è®­ç»ƒçš„å°æ¨¡å‹</span></span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a><span class="co">        train_loader: æ•°æ®åŠ è½½å™¨</span></span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a><span class="co">        num_epochs: è®­ç»ƒè½®æ•°</span></span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a><span class="co">        temperature: æ¸©åº¦å‚æ•°</span></span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>    device <span class="op">=</span> torch.device(<span class="st">'cuda'</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">'cpu'</span>)</span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a>    teacher_model.to(device)</span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>    student_model.to(device)</span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>    teacher_model.<span class="bu">eval</span>()  <span class="co"># æ•™å¸ˆæ¨¡å‹ä¸è®­ç»ƒ</span></span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> torch.optim.Adam(student_model.parameters(), lr<span class="op">=</span><span class="fl">0.001</span>)</span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a>    distillation_loss <span class="op">=</span> DistillationLoss(temperature<span class="op">=</span>temperature, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(num_epochs):</span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a>        student_model.train()</span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a>        total_loss <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a>        correct <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a>        total <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> inputs, targets <span class="kw">in</span> train_loader:</span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a>            inputs, targets <span class="op">=</span> inputs.to(device), targets.to(device)</span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a>            <span class="co"># æ•™å¸ˆæ¨¡å‹è¾“å‡ºï¼ˆä¸éœ€è¦æ¢¯åº¦ï¼‰</span></span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> torch.no_grad():</span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a>                teacher_logits <span class="op">=</span> teacher_model(inputs)</span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-67"><a href="#cb31-67" aria-hidden="true" tabindex="-1"></a>            <span class="co"># å­¦ç”Ÿæ¨¡å‹è¾“å‡º</span></span>
<span id="cb31-68"><a href="#cb31-68" aria-hidden="true" tabindex="-1"></a>            student_logits <span class="op">=</span> student_model(inputs)</span>
<span id="cb31-69"><a href="#cb31-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-70"><a href="#cb31-70" aria-hidden="true" tabindex="-1"></a>            <span class="co"># è®¡ç®—è’¸é¦æŸå¤±</span></span>
<span id="cb31-71"><a href="#cb31-71" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> distillation_loss(student_logits, teacher_logits, targets)</span>
<span id="cb31-72"><a href="#cb31-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-73"><a href="#cb31-73" aria-hidden="true" tabindex="-1"></a>            <span class="co"># åå‘ä¼ æ’­</span></span>
<span id="cb31-74"><a href="#cb31-74" aria-hidden="true" tabindex="-1"></a>            optimizer.zero_grad()</span>
<span id="cb31-75"><a href="#cb31-75" aria-hidden="true" tabindex="-1"></a>            loss.backward()</span>
<span id="cb31-76"><a href="#cb31-76" aria-hidden="true" tabindex="-1"></a>            optimizer.step()</span>
<span id="cb31-77"><a href="#cb31-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-78"><a href="#cb31-78" aria-hidden="true" tabindex="-1"></a>            <span class="co"># ç»Ÿè®¡</span></span>
<span id="cb31-79"><a href="#cb31-79" aria-hidden="true" tabindex="-1"></a>            total_loss <span class="op">+=</span> loss.item()</span>
<span id="cb31-80"><a href="#cb31-80" aria-hidden="true" tabindex="-1"></a>            _, predicted <span class="op">=</span> student_logits.<span class="bu">max</span>(<span class="dv">1</span>)</span>
<span id="cb31-81"><a href="#cb31-81" aria-hidden="true" tabindex="-1"></a>            total <span class="op">+=</span> targets.size(<span class="dv">0</span>)</span>
<span id="cb31-82"><a href="#cb31-82" aria-hidden="true" tabindex="-1"></a>            correct <span class="op">+=</span> predicted.eq(targets).<span class="bu">sum</span>().item()</span>
<span id="cb31-83"><a href="#cb31-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-84"><a href="#cb31-84" aria-hidden="true" tabindex="-1"></a>        accuracy <span class="op">=</span> <span class="fl">100.</span> <span class="op">*</span> correct <span class="op">/</span> total</span>
<span id="cb31-85"><a href="#cb31-85" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Epoch </span><span class="sc">{</span>epoch<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">: Loss=</span><span class="sc">{</span>total_loss<span class="op">/</span><span class="bu">len</span>(train_loader)<span class="sc">:.4f}</span><span class="ss">, '</span></span>
<span id="cb31-86"><a href="#cb31-86" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f'Acc=</span><span class="sc">{</span>accuracy<span class="sc">:.2f}</span><span class="ss">%'</span>)</span>
<span id="cb31-87"><a href="#cb31-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-88"><a href="#cb31-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> student_model</span>
<span id="cb31-89"><a href="#cb31-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-90"><a href="#cb31-90" aria-hidden="true" tabindex="-1"></a><span class="co"># ä½¿ç”¨ç¤ºä¾‹</span></span>
<span id="cb31-91"><a href="#cb31-91" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb31-92"><a href="#cb31-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># æ•™å¸ˆæ¨¡å‹ï¼ˆå¤§ï¼‰</span></span>
<span id="cb31-93"><a href="#cb31-93" aria-hidden="true" tabindex="-1"></a>    teacher <span class="op">=</span> models.resnet50(pretrained<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-94"><a href="#cb31-94" aria-hidden="true" tabindex="-1"></a>    teacher.fc <span class="op">=</span> nn.Linear(teacher.fc.in_features, <span class="dv">10</span>)</span>
<span id="cb31-95"><a href="#cb31-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-96"><a href="#cb31-96" aria-hidden="true" tabindex="-1"></a>    <span class="co"># å­¦ç”Ÿæ¨¡å‹ï¼ˆå°ï¼‰</span></span>
<span id="cb31-97"><a href="#cb31-97" aria-hidden="true" tabindex="-1"></a>    student <span class="op">=</span> models.resnet18(pretraine</span>
<span id="cb31-98"><a href="#cb31-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-99"><a href="#cb31-99" aria-hidden="true" tabindex="-1"></a><span class="op">-----</span></span>
<span id="cb31-100"><a href="#cb31-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-101"><a href="#cb31-101" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> Continue</span>
<span id="cb31-102"><a href="#cb31-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-103"><a href="#cb31-103" aria-hidden="true" tabindex="-1"></a>d<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb31-104"><a href="#cb31-104" aria-hidden="true" tabindex="-1"></a>    student.fc <span class="op">=</span> nn.Linear(student.fc.in_features, <span class="dv">10</span>)</span>
<span id="cb31-105"><a href="#cb31-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-106"><a href="#cb31-106" aria-hidden="true" tabindex="-1"></a>    <span class="co"># çŸ¥è¯†è’¸é¦</span></span>
<span id="cb31-107"><a href="#cb31-107" aria-hidden="true" tabindex="-1"></a>    student <span class="op">=</span> knowledge_distillation(</span>
<span id="cb31-108"><a href="#cb31-108" aria-hidden="true" tabindex="-1"></a>        teacher, student, train_loader,</span>
<span id="cb31-109"><a href="#cb31-109" aria-hidden="true" tabindex="-1"></a>        num_epochs<span class="op">=</span><span class="dv">50</span>, temperature<span class="op">=</span><span class="fl">3.0</span></span>
<span id="cb31-110"><a href="#cb31-110" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
</section>
</section>
<section id="å®æˆ˜å®Œæ•´è¿ç§»å­¦ä¹ é¡¹ç›®" class="level2">
<h2 class="anchored" data-anchor-id="å®æˆ˜å®Œæ•´è¿ç§»å­¦ä¹ é¡¹ç›®">9.8 å®æˆ˜ï¼šå®Œæ•´è¿ç§»å­¦ä¹ é¡¹ç›®</h2>
<section id="ä»»åŠ¡åŒ»å­¦å›¾åƒåˆ†ç±»" class="level3">
<h3 class="anchored" data-anchor-id="ä»»åŠ¡åŒ»å­¦å›¾åƒåˆ†ç±»">ğŸ“‹ ä»»åŠ¡ï¼šåŒ»å­¦å›¾åƒåˆ†ç±»</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.optim <span class="im">as</span> optim</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> DataLoader, Dataset</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision <span class="im">import</span> transforms, models</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> classification_report, confusion_matrix</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="co"># ==================== è‡ªå®šä¹‰æ•°æ®é›† ====================</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MedicalImageDataset(Dataset):</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""åŒ»å­¦å›¾åƒæ•°æ®é›†"""</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, root_dir, transform<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.root_dir <span class="op">=</span> root_dir</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.transform <span class="op">=</span> transform</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.classes <span class="op">=</span> os.listdir(root_dir)</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.class_to_idx <span class="op">=</span> {cls: idx <span class="cf">for</span> idx, cls <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>.classes)}</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># æ”¶é›†æ‰€æœ‰å›¾åƒè·¯å¾„</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.images <span class="op">=</span> []</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.labels <span class="op">=</span> []</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> class_name <span class="kw">in</span> <span class="va">self</span>.classes:</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>            class_dir <span class="op">=</span> os.path.join(root_dir, class_name)</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> img_name <span class="kw">in</span> os.listdir(class_dir):</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>                img_path <span class="op">=</span> os.path.join(class_dir, img_name)</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.images.append(img_path)</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.labels.append(<span class="va">self</span>.class_to_idx[class_name])</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.images)</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx):</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>        img_path <span class="op">=</span> <span class="va">self</span>.images[idx]</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>        image <span class="op">=</span> Image.<span class="bu">open</span>(img_path).convert(<span class="st">'RGB'</span>)</span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>        label <span class="op">=</span> <span class="va">self</span>.labels[idx]</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.transform:</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>            image <span class="op">=</span> <span class="va">self</span>.transform(image)</span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> image, label</span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a><span class="co"># ==================== æ•°æ®å¢å¼ºç­–ç•¥ ====================</span></span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_transforms(phase<span class="op">=</span><span class="st">'train'</span>):</span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""è·å–æ•°æ®å˜æ¢"""</span></span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> phase <span class="op">==</span> <span class="st">'train'</span>:</span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> transforms.Compose([</span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a>            transforms.Resize((<span class="dv">256</span>, <span class="dv">256</span>)),</span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a>            transforms.RandomCrop(<span class="dv">224</span>),</span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a>            transforms.RandomHorizontalFlip(),</span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a>            transforms.RandomVerticalFlip(),</span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a>            transforms.RandomRotation(<span class="dv">20</span>),</span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a>            transforms.ColorJitter(brightness<span class="op">=</span><span class="fl">0.2</span>, contrast<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a>                                 saturation<span class="op">=</span><span class="fl">0.2</span>, hue<span class="op">=</span><span class="fl">0.1</span>),</span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a>            transforms.ToTensor(),</span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a>            transforms.Normalize([<span class="fl">0.485</span>, <span class="fl">0.456</span>, <span class="fl">0.406</span>],</span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a>                               [<span class="fl">0.229</span>, <span class="fl">0.224</span>, <span class="fl">0.225</span>])</span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a>        ])</span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> transforms.Compose([</span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a>            transforms.Resize((<span class="dv">256</span>, <span class="dv">256</span>)),</span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a>            transforms.CenterCrop(<span class="dv">224</span>),</span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a>            transforms.ToTensor(),</span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a>            transforms.Normalize([<span class="fl">0.485</span>, <span class="fl">0.456</span>, <span class="fl">0.406</span>],</span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a>                               [<span class="fl">0.229</span>, <span class="fl">0.224</span>, <span class="fl">0.225</span>])</span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a>        ])</span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a><span class="co"># ==================== æ¨¡å‹æ„å»º ====================</span></span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TransferLearningModel(nn.Module):</span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""è¿ç§»å­¦ä¹ æ¨¡å‹"""</span></span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, model_name<span class="op">=</span><span class="st">'resnet50'</span>, num_classes<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a>                 pretrained<span class="op">=</span><span class="va">True</span>, freeze_backbone<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb32-82"><a href="#cb32-82" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb32-83"><a href="#cb32-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-84"><a href="#cb32-84" aria-hidden="true" tabindex="-1"></a>        <span class="co"># åŠ è½½é¢„è®­ç»ƒæ¨¡å‹</span></span>
<span id="cb32-85"><a href="#cb32-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> model_name <span class="op">==</span> <span class="st">'resnet50'</span>:</span>
<span id="cb32-86"><a href="#cb32-86" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.backbone <span class="op">=</span> models.resnet50(pretrained<span class="op">=</span>pretrained)</span>
<span id="cb32-87"><a href="#cb32-87" aria-hidden="true" tabindex="-1"></a>            num_features <span class="op">=</span> <span class="va">self</span>.backbone.fc.in_features</span>
<span id="cb32-88"><a href="#cb32-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-89"><a href="#cb32-89" aria-hidden="true" tabindex="-1"></a>            <span class="co"># å†»ç»“éª¨å¹²ç½‘ç»œ</span></span>
<span id="cb32-90"><a href="#cb32-90" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> freeze_backbone:</span>
<span id="cb32-91"><a href="#cb32-91" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> param <span class="kw">in</span> <span class="va">self</span>.backbone.parameters():</span>
<span id="cb32-92"><a href="#cb32-92" aria-hidden="true" tabindex="-1"></a>                    param.requires_grad <span class="op">=</span> <span class="va">False</span></span>
<span id="cb32-93"><a href="#cb32-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-94"><a href="#cb32-94" aria-hidden="true" tabindex="-1"></a>            <span class="co"># æ›¿æ¢åˆ†ç±»å™¨</span></span>
<span id="cb32-95"><a href="#cb32-95" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.backbone.fc <span class="op">=</span> nn.Sequential(</span>
<span id="cb32-96"><a href="#cb32-96" aria-hidden="true" tabindex="-1"></a>                nn.Dropout(<span class="fl">0.5</span>),</span>
<span id="cb32-97"><a href="#cb32-97" aria-hidden="true" tabindex="-1"></a>                nn.Linear(num_features, <span class="dv">512</span>),</span>
<span id="cb32-98"><a href="#cb32-98" aria-hidden="true" tabindex="-1"></a>                nn.ReLU(),</span>
<span id="cb32-99"><a href="#cb32-99" aria-hidden="true" tabindex="-1"></a>                nn.BatchNorm1d(<span class="dv">512</span>),</span>
<span id="cb32-100"><a href="#cb32-100" aria-hidden="true" tabindex="-1"></a>                nn.Dropout(<span class="fl">0.3</span>),</span>
<span id="cb32-101"><a href="#cb32-101" aria-hidden="true" tabindex="-1"></a>                nn.Linear(<span class="dv">512</span>, num_classes)</span>
<span id="cb32-102"><a href="#cb32-102" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb32-103"><a href="#cb32-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-104"><a href="#cb32-104" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> model_name <span class="op">==</span> <span class="st">'efficientnet_b3'</span>:</span>
<span id="cb32-105"><a href="#cb32-105" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.backbone <span class="op">=</span> models.efficientnet_b3(pretrained<span class="op">=</span>pretrained)</span>
<span id="cb32-106"><a href="#cb32-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-107"><a href="#cb32-107" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> freeze_backbone:</span>
<span id="cb32-108"><a href="#cb32-108" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> param <span class="kw">in</span> <span class="va">self</span>.backbone.parameters():</span>
<span id="cb32-109"><a href="#cb32-109" aria-hidden="true" tabindex="-1"></a>                    param.requires_grad <span class="op">=</span> <span class="va">False</span></span>
<span id="cb32-110"><a href="#cb32-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-111"><a href="#cb32-111" aria-hidden="true" tabindex="-1"></a>            num_features <span class="op">=</span> <span class="va">self</span>.backbone.classifier[<span class="dv">1</span>].in_features</span>
<span id="cb32-112"><a href="#cb32-112" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.backbone.classifier <span class="op">=</span> nn.Sequential(</span>
<span id="cb32-113"><a href="#cb32-113" aria-hidden="true" tabindex="-1"></a>                nn.Dropout(<span class="fl">0.3</span>),</span>
<span id="cb32-114"><a href="#cb32-114" aria-hidden="true" tabindex="-1"></a>                nn.Linear(num_features, num_classes)</span>
<span id="cb32-115"><a href="#cb32-115" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb32-116"><a href="#cb32-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-117"><a href="#cb32-117" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> model_name <span class="op">==</span> <span class="st">'vit_b_16'</span>:</span>
<span id="cb32-118"><a href="#cb32-118" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.backbone <span class="op">=</span> models.vit_b_16(pretrained<span class="op">=</span>pretrained)</span>
<span id="cb32-119"><a href="#cb32-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-120"><a href="#cb32-120" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> freeze_backbone:</span>
<span id="cb32-121"><a href="#cb32-121" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> param <span class="kw">in</span> <span class="va">self</span>.backbone.parameters():</span>
<span id="cb32-122"><a href="#cb32-122" aria-hidden="true" tabindex="-1"></a>                    param.requires_grad <span class="op">=</span> <span class="va">False</span></span>
<span id="cb32-123"><a href="#cb32-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-124"><a href="#cb32-124" aria-hidden="true" tabindex="-1"></a>            num_features <span class="op">=</span> <span class="va">self</span>.backbone.heads.head.in_features</span>
<span id="cb32-125"><a href="#cb32-125" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.backbone.heads.head <span class="op">=</span> nn.Linear(num_features, num_classes)</span>
<span id="cb32-126"><a href="#cb32-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-127"><a href="#cb32-127" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb32-128"><a href="#cb32-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.backbone(x)</span>
<span id="cb32-129"><a href="#cb32-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-130"><a href="#cb32-130" aria-hidden="true" tabindex="-1"></a><span class="co"># ==================== è®­ç»ƒå™¨ç±» ====================</span></span>
<span id="cb32-131"><a href="#cb32-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-132"><a href="#cb32-132" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Trainer:</span>
<span id="cb32-133"><a href="#cb32-133" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""è®­ç»ƒå™¨"""</span></span>
<span id="cb32-134"><a href="#cb32-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-135"><a href="#cb32-135" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, model, train_loader, val_loader,</span>
<span id="cb32-136"><a href="#cb32-136" aria-hidden="true" tabindex="-1"></a>                 criterion, optimizer, scheduler, device,</span>
<span id="cb32-137"><a href="#cb32-137" aria-hidden="true" tabindex="-1"></a>                 num_epochs<span class="op">=</span><span class="dv">50</span>, early_stopping_patience<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb32-138"><a href="#cb32-138" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> model</span>
<span id="cb32-139"><a href="#cb32-139" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.train_loader <span class="op">=</span> train_loader</span>
<span id="cb32-140"><a href="#cb32-140" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.val_loader <span class="op">=</span> val_loader</span>
<span id="cb32-141"><a href="#cb32-141" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.criterion <span class="op">=</span> criterion</span>
<span id="cb32-142"><a href="#cb32-142" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.optimizer <span class="op">=</span> optimizer</span>
<span id="cb32-143"><a href="#cb32-143" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.scheduler <span class="op">=</span> scheduler</span>
<span id="cb32-144"><a href="#cb32-144" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.device <span class="op">=</span> device</span>
<span id="cb32-145"><a href="#cb32-145" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.num_epochs <span class="op">=</span> num_epochs</span>
<span id="cb32-146"><a href="#cb32-146" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.early_stopping_patience <span class="op">=</span> early_stopping_patience</span>
<span id="cb32-147"><a href="#cb32-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-148"><a href="#cb32-148" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.best_val_acc <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb32-149"><a href="#cb32-149" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.patience_counter <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb32-150"><a href="#cb32-150" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.history <span class="op">=</span> {</span>
<span id="cb32-151"><a href="#cb32-151" aria-hidden="true" tabindex="-1"></a>            <span class="st">'train_loss'</span>: [], <span class="st">'train_acc'</span>: [],</span>
<span id="cb32-152"><a href="#cb32-152" aria-hidden="true" tabindex="-1"></a>            <span class="st">'val_loss'</span>: [], <span class="st">'val_acc'</span>: []</span>
<span id="cb32-153"><a href="#cb32-153" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb32-154"><a href="#cb32-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-155"><a href="#cb32-155" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> train_epoch(<span class="va">self</span>):</span>
<span id="cb32-156"><a href="#cb32-156" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""è®­ç»ƒä¸€ä¸ª epoch"""</span></span>
<span id="cb32-157"><a href="#cb32-157" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model.train()</span>
<span id="cb32-158"><a href="#cb32-158" aria-hidden="true" tabindex="-1"></a>        running_loss <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb32-159"><a href="#cb32-159" aria-hidden="true" tabindex="-1"></a>        correct <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb32-160"><a href="#cb32-160" aria-hidden="true" tabindex="-1"></a>        total <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb32-161"><a href="#cb32-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-162"><a href="#cb32-162" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> inputs, labels <span class="kw">in</span> <span class="va">self</span>.train_loader:</span>
<span id="cb32-163"><a href="#cb32-163" aria-hidden="true" tabindex="-1"></a>            inputs, labels <span class="op">=</span> inputs.to(<span class="va">self</span>.device), labels.to(<span class="va">self</span>.device)</span>
<span id="cb32-164"><a href="#cb32-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-165"><a href="#cb32-165" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.optimizer.zero_grad()</span>
<span id="cb32-166"><a href="#cb32-166" aria-hidden="true" tabindex="-1"></a>            outputs <span class="op">=</span> <span class="va">self</span>.model(inputs)</span>
<span id="cb32-167"><a href="#cb32-167" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> <span class="va">self</span>.criterion(outputs, labels)</span>
<span id="cb32-168"><a href="#cb32-168" aria-hidden="true" tabindex="-1"></a>            loss.backward()</span>
<span id="cb32-169"><a href="#cb32-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-170"><a href="#cb32-170" aria-hidden="true" tabindex="-1"></a>            <span class="co"># æ¢¯åº¦è£å‰ª</span></span>
<span id="cb32-171"><a href="#cb32-171" aria-hidden="true" tabindex="-1"></a>            torch.nn.utils.clip_grad_norm_(<span class="va">self</span>.model.parameters(), max_norm<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb32-172"><a href="#cb32-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-173"><a href="#cb32-173" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.optimizer.step()</span>
<span id="cb32-174"><a href="#cb32-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-175"><a href="#cb32-175" aria-hidden="true" tabindex="-1"></a>            running_loss <span class="op">+=</span> loss.item() <span class="op">*</span> inputs.size(<span class="dv">0</span>)</span>
<span id="cb32-176"><a href="#cb32-176" aria-hidden="true" tabindex="-1"></a>            _, predicted <span class="op">=</span> outputs.<span class="bu">max</span>(<span class="dv">1</span>)</span>
<span id="cb32-177"><a href="#cb32-177" aria-hidden="true" tabindex="-1"></a>            total <span class="op">+=</span> labels.size(<span class="dv">0</span>)</span>
<span id="cb32-178"><a href="#cb32-178" aria-hidden="true" tabindex="-1"></a>            correct <span class="op">+=</span> predicted.eq(labels).<span class="bu">sum</span>().item()</span>
<span id="cb32-179"><a href="#cb32-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-180"><a href="#cb32-180" aria-hidden="true" tabindex="-1"></a>        epoch_loss <span class="op">=</span> running_loss <span class="op">/</span> total</span>
<span id="cb32-181"><a href="#cb32-181" aria-hidden="true" tabindex="-1"></a>        epoch_acc <span class="op">=</span> <span class="fl">100.</span> <span class="op">*</span> correct <span class="op">/</span> total</span>
<span id="cb32-182"><a href="#cb32-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-183"><a href="#cb32-183" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> epoch_loss, epoch_acc</span>
<span id="cb32-184"><a href="#cb32-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-185"><a href="#cb32-185" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> validate(<span class="va">self</span>):</span>
<span id="cb32-186"><a href="#cb32-186" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""éªŒè¯"""</span></span>
<span id="cb32-187"><a href="#cb32-187" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model.<span class="bu">eval</span>()</span>
<span id="cb32-188"><a href="#cb32-188" aria-hidden="true" tabindex="-1"></a>        running_loss <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb32-189"><a href="#cb32-189" aria-hidden="true" tabindex="-1"></a>        correct <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb32-190"><a href="#cb32-190" aria-hidden="true" tabindex="-1"></a>        total <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb32-191"><a href="#cb32-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-192"><a href="#cb32-192" aria-hidden="true" tabindex="-1"></a>        all_preds <span class="op">=</span> []</span>
<span id="cb32-193"><a href="#cb32-193" aria-hidden="true" tabindex="-1"></a>        all_labels <span class="op">=</span> []</span>
<span id="cb32-194"><a href="#cb32-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-195"><a href="#cb32-195" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb32-196"><a href="#cb32-196" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> inputs, labels <span class="kw">in</span> <span class="va">self</span>.val_loader:</span>
<span id="cb32-197"><a href="#cb32-197" aria-hidden="true" tabindex="-1"></a>                inputs, labels <span class="op">=</span> inputs.to(<span class="va">self</span>.device), labels.to(<span class="va">self</span>.device)</span>
<span id="cb32-198"><a href="#cb32-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-199"><a href="#cb32-199" aria-hidden="true" tabindex="-1"></a>                outputs <span class="op">=</span> <span class="va">self</span>.model(inputs)</span>
<span id="cb32-200"><a href="#cb32-200" aria-hidden="true" tabindex="-1"></a>                loss <span class="op">=</span> <span class="va">self</span>.criterion(outputs, labels)</span>
<span id="cb32-201"><a href="#cb32-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-202"><a href="#cb32-202" aria-hidden="true" tabindex="-1"></a>                running_loss <span class="op">+=</span> loss.item() <span class="op">*</span> inputs.size(<span class="dv">0</span>)</span>
<span id="cb32-203"><a href="#cb32-203" aria-hidden="true" tabindex="-1"></a>                _, predicted <span class="op">=</span> outputs.<span class="bu">max</span>(<span class="dv">1</span>)</span>
<span id="cb32-204"><a href="#cb32-204" aria-hidden="true" tabindex="-1"></a>                total <span class="op">+=</span> labels.size(<span class="dv">0</span>)</span>
<span id="cb32-205"><a href="#cb32-205" aria-hidden="true" tabindex="-1"></a>                correct <span class="op">+=</span> predicted.eq(labels).<span class="bu">sum</span>().item()</span>
<span id="cb32-206"><a href="#cb32-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-207"><a href="#cb32-207" aria-hidden="true" tabindex="-1"></a>                all_preds.extend(predicted.cpu().numpy())</span>
<span id="cb32-208"><a href="#cb32-208" aria-hidden="true" tabindex="-1"></a>                all_labels.extend(labels.cpu().numpy())</span>
<span id="cb32-209"><a href="#cb32-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-210"><a href="#cb32-210" aria-hidden="true" tabindex="-1"></a>        epoch_loss <span class="op">=</span> running_loss <span class="op">/</span> total</span>
<span id="cb32-211"><a href="#cb32-211" aria-hidden="true" tabindex="-1"></a>        epoch_acc <span class="op">=</span> <span class="fl">100.</span> <span class="op">*</span> correct <span class="op">/</span> total</span>
<span id="cb32-212"><a href="#cb32-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-213"><a href="#cb32-213" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> epoch_loss, epoch_acc, all_preds, all_labels</span>
<span id="cb32-214"><a href="#cb32-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-215"><a href="#cb32-215" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> train(<span class="va">self</span>):</span>
<span id="cb32-216"><a href="#cb32-216" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""å®Œæ•´è®­ç»ƒæµç¨‹"""</span></span>
<span id="cb32-217"><a href="#cb32-217" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"å¼€å§‹è®­ç»ƒï¼Œè®¾å¤‡: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>device<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-218"><a href="#cb32-218" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb32-219"><a href="#cb32-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-220"><a href="#cb32-220" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.num_epochs):</span>
<span id="cb32-221"><a href="#cb32-221" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f'</span><span class="ch">\n</span><span class="ss">Epoch </span><span class="sc">{</span>epoch<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>num_epochs<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb32-222"><a href="#cb32-222" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'-'</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb32-223"><a href="#cb32-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-224"><a href="#cb32-224" aria-hidden="true" tabindex="-1"></a>            <span class="co"># è®­ç»ƒ</span></span>
<span id="cb32-225"><a href="#cb32-225" aria-hidden="true" tabindex="-1"></a>            train_loss, train_acc <span class="op">=</span> <span class="va">self</span>.train_epoch()</span>
<span id="cb32-226"><a href="#cb32-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-227"><a href="#cb32-227" aria-hidden="true" tabindex="-1"></a>            <span class="co"># éªŒè¯</span></span>
<span id="cb32-228"><a href="#cb32-228" aria-hidden="true" tabindex="-1"></a>            val_loss, val_acc, _, _ <span class="op">=</span> <span class="va">self</span>.validate()</span>
<span id="cb32-229"><a href="#cb32-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-230"><a href="#cb32-230" aria-hidden="true" tabindex="-1"></a>            <span class="co"># è®°å½•å†å²</span></span>
<span id="cb32-231"><a href="#cb32-231" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.history[<span class="st">'train_loss'</span>].append(train_loss)</span>
<span id="cb32-232"><a href="#cb32-232" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.history[<span class="st">'train_acc'</span>].append(train_acc)</span>
<span id="cb32-233"><a href="#cb32-233" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.history[<span class="st">'val_loss'</span>].append(val_loss)</span>
<span id="cb32-234"><a href="#cb32-234" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.history[<span class="st">'val_acc'</span>].append(val_acc)</span>
<span id="cb32-235"><a href="#cb32-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-236"><a href="#cb32-236" aria-hidden="true" tabindex="-1"></a>            <span class="co"># æ‰“å°ç»“æœ</span></span>
<span id="cb32-237"><a href="#cb32-237" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f'è®­ç»ƒ - Loss: </span><span class="sc">{</span>train_loss<span class="sc">:.4f}</span><span class="ss">, Acc: </span><span class="sc">{</span>train_acc<span class="sc">:.2f}</span><span class="ss">%'</span>)</span>
<span id="cb32-238"><a href="#cb32-238" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f'éªŒè¯ - Loss: </span><span class="sc">{</span>val_loss<span class="sc">:.4f}</span><span class="ss">, Acc: </span><span class="sc">{</span>val_acc<span class="sc">:.2f}</span><span class="ss">%'</span>)</span>
<span id="cb32-239"><a href="#cb32-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-240"><a href="#cb32-240" aria-hidden="true" tabindex="-1"></a>            <span class="co"># å­¦ä¹ ç‡è°ƒåº¦</span></span>
<span id="cb32-241"><a href="#cb32-241" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.scheduler:</span>
<span id="cb32-242"><a href="#cb32-242" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.scheduler.step(val_loss)</span>
<span id="cb32-243"><a href="#cb32-243" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f'å­¦ä¹ ç‡: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>optimizer<span class="sc">.</span>param_groups[<span class="dv">0</span>][<span class="st">"lr"</span>]<span class="sc">:.6f}</span><span class="ss">'</span>)</span>
<span id="cb32-244"><a href="#cb32-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-245"><a href="#cb32-245" aria-hidden="true" tabindex="-1"></a>            <span class="co"># ä¿å­˜æœ€ä½³æ¨¡å‹</span></span>
<span id="cb32-246"><a href="#cb32-246" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> val_acc <span class="op">&gt;</span> <span class="va">self</span>.best_val_acc:</span>
<span id="cb32-247"><a href="#cb32-247" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.best_val_acc <span class="op">=</span> val_acc</span>
<span id="cb32-248"><a href="#cb32-248" aria-hidden="true" tabindex="-1"></a>                torch.save(<span class="va">self</span>.model.state_dict(), <span class="st">'best_model.pth'</span>)</span>
<span id="cb32-249"><a href="#cb32-249" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f'âœ“ ä¿å­˜æœ€ä½³æ¨¡å‹ (Val Acc: </span><span class="sc">{</span>val_acc<span class="sc">:.2f}</span><span class="ss">%)'</span>)</span>
<span id="cb32-250"><a href="#cb32-250" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.patience_counter <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb32-251"><a href="#cb32-251" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb32-252"><a href="#cb32-252" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.patience_counter <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb32-253"><a href="#cb32-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-254"><a href="#cb32-254" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Early Stopping</span></span>
<span id="cb32-255"><a href="#cb32-255" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.patience_counter <span class="op">&gt;=</span> <span class="va">self</span>.early_stopping_patience:</span>
<span id="cb32-256"><a href="#cb32-256" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f'</span><span class="ch">\n</span><span class="ss">Early stopping triggered at epoch </span><span class="sc">{</span>epoch<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb32-257"><a href="#cb32-257" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb32-258"><a href="#cb32-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-259"><a href="#cb32-259" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'</span><span class="ch">\n</span><span class="ss">è®­ç»ƒå®Œæˆï¼æœ€ä½³éªŒè¯å‡†ç¡®ç‡: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>best_val_acc<span class="sc">:.2f}</span><span class="ss">%'</span>)</span>
<span id="cb32-260"><a href="#cb32-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-261"><a href="#cb32-261" aria-hidden="true" tabindex="-1"></a>        <span class="co"># åŠ è½½æœ€ä½³æ¨¡å‹</span></span>
<span id="cb32-262"><a href="#cb32-262" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model.load_state_dict(torch.load(<span class="st">'best_model.pth'</span>))</span>
<span id="cb32-263"><a href="#cb32-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-264"><a href="#cb32-264" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.history</span>
<span id="cb32-265"><a href="#cb32-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-266"><a href="#cb32-266" aria-hidden="true" tabindex="-1"></a><span class="co"># ==================== è¯„ä¼°å’Œå¯è§†åŒ– ====================</span></span>
<span id="cb32-267"><a href="#cb32-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-268"><a href="#cb32-268" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Evaluator:</span>
<span id="cb32-269"><a href="#cb32-269" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""è¯„ä¼°å™¨"""</span></span>
<span id="cb32-270"><a href="#cb32-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-271"><a href="#cb32-271" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, model, test_loader, class_names, device):</span>
<span id="cb32-272"><a href="#cb32-272" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> model</span>
<span id="cb32-273"><a href="#cb32-273" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.test_loader <span class="op">=</span> test_loader</span>
<span id="cb32-274"><a href="#cb32-274" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.class_names <span class="op">=</span> class_names</span>
<span id="cb32-275"><a href="#cb32-275" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.device <span class="op">=</span> device</span>
<span id="cb32-276"><a href="#cb32-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-277"><a href="#cb32-277" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> evaluate(<span class="va">self</span>):</span>
<span id="cb32-278"><a href="#cb32-278" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""å®Œæ•´è¯„ä¼°"""</span></span>
<span id="cb32-279"><a href="#cb32-279" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model.<span class="bu">eval</span>()</span>
<span id="cb32-280"><a href="#cb32-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-281"><a href="#cb32-281" aria-hidden="true" tabindex="-1"></a>        all_preds <span class="op">=</span> []</span>
<span id="cb32-282"><a href="#cb32-282" aria-hidden="true" tabindex="-1"></a>        all_labels <span class="op">=</span> []</span>
<span id="cb32-283"><a href="#cb32-283" aria-hidden="true" tabindex="-1"></a>        all_probs <span class="op">=</span> []</span>
<span id="cb32-284"><a href="#cb32-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-285"><a href="#cb32-285" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb32-286"><a href="#cb32-286" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> inputs, labels <span class="kw">in</span> <span class="va">self</span>.test_loader:</span>
<span id="cb32-287"><a href="#cb32-287" aria-hidden="true" tabindex="-1"></a>                inputs <span class="op">=</span> inputs.to(<span class="va">self</span>.device)</span>
<span id="cb32-288"><a href="#cb32-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-289"><a href="#cb32-289" aria-hidden="true" tabindex="-1"></a>                outputs <span class="op">=</span> <span class="va">self</span>.model(inputs)</span>
<span id="cb32-290"><a href="#cb32-290" aria-hidden="true" tabindex="-1"></a>                probs <span class="op">=</span> torch.softmax(outputs, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb32-291"><a href="#cb32-291" aria-hidden="true" tabindex="-1"></a>                _, predicted <span class="op">=</span> outputs.<span class="bu">max</span>(<span class="dv">1</span>)</span>
<span id="cb32-292"><a href="#cb32-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-293"><a href="#cb32-293" aria-hidden="true" tabindex="-1"></a>                all_preds.extend(predicted.cpu().numpy())</span>
<span id="cb32-294"><a href="#cb32-294" aria-hidden="true" tabindex="-1"></a>                all_labels.extend(labels.numpy())</span>
<span id="cb32-295"><a href="#cb32-295" aria-hidden="true" tabindex="-1"></a>                all_probs.extend(probs.cpu().numpy())</span>
<span id="cb32-296"><a href="#cb32-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-297"><a href="#cb32-297" aria-hidden="true" tabindex="-1"></a>        all_preds <span class="op">=</span> np.array(all_preds)</span>
<span id="cb32-298"><a href="#cb32-298" aria-hidden="true" tabindex="-1"></a>        all_labels <span class="op">=</span> np.array(all_labels)</span>
<span id="cb32-299"><a href="#cb32-299" aria-hidden="true" tabindex="-1"></a>        all_probs <span class="op">=</span> np.array(all_probs)</span>
<span id="cb32-300"><a href="#cb32-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-301"><a href="#cb32-301" aria-hidden="true" tabindex="-1"></a>        <span class="co"># å‡†ç¡®ç‡</span></span>
<span id="cb32-302"><a href="#cb32-302" aria-hidden="true" tabindex="-1"></a>        accuracy <span class="op">=</span> (all_preds <span class="op">==</span> all_labels).mean()</span>
<span id="cb32-303"><a href="#cb32-303" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'</span><span class="ch">\n</span><span class="ss">æµ‹è¯•é›†å‡†ç¡®ç‡: </span><span class="sc">{</span>accuracy<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%</span><span class="ch">\n</span><span class="ss">'</span>)</span>
<span id="cb32-304"><a href="#cb32-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-305"><a href="#cb32-305" aria-hidden="true" tabindex="-1"></a>        <span class="co"># åˆ†ç±»æŠ¥å‘Š</span></span>
<span id="cb32-306"><a href="#cb32-306" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"åˆ†ç±»æŠ¥å‘Š:"</span>)</span>
<span id="cb32-307"><a href="#cb32-307" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(classification_report(all_labels, all_preds,</span>
<span id="cb32-308"><a href="#cb32-308" aria-hidden="true" tabindex="-1"></a>                                   target_names<span class="op">=</span><span class="va">self</span>.class_names))</span>
<span id="cb32-309"><a href="#cb32-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-310"><a href="#cb32-310" aria-hidden="true" tabindex="-1"></a>        <span class="co"># æ··æ·†çŸ©é˜µ</span></span>
<span id="cb32-311"><a href="#cb32-311" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.plot_confusion_matrix(all_labels, all_preds)</span>
<span id="cb32-312"><a href="#cb32-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-313"><a href="#cb32-313" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ROC æ›²çº¿ï¼ˆå¤šåˆ†ç±»ï¼‰</span></span>
<span id="cb32-314"><a href="#cb32-314" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(<span class="va">self</span>.class_names) <span class="op">&lt;=</span> <span class="dv">10</span>:</span>
<span id="cb32-315"><a href="#cb32-315" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.plot_roc_curves(all_labels, all_probs)</span>
<span id="cb32-316"><a href="#cb32-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-317"><a href="#cb32-317" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> all_preds, all_labels, all_probs</span>
<span id="cb32-318"><a href="#cb32-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-319"><a href="#cb32-319" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> plot_confusion_matrix(<span class="va">self</span>, labels, preds):</span>
<span id="cb32-320"><a href="#cb32-320" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""ç»˜åˆ¶æ··æ·†çŸ©é˜µ"""</span></span>
<span id="cb32-321"><a href="#cb32-321" aria-hidden="true" tabindex="-1"></a>        cm <span class="op">=</span> confusion_matrix(labels, preds)</span>
<span id="cb32-322"><a href="#cb32-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-323"><a href="#cb32-323" aria-hidden="true" tabindex="-1"></a>        plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">8</span>))</span>
<span id="cb32-324"><a href="#cb32-324" aria-hidden="true" tabindex="-1"></a>        sns.heatmap(cm, annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">'d'</span>, cmap<span class="op">=</span><span class="st">'Blues'</span>,</span>
<span id="cb32-325"><a href="#cb32-325" aria-hidden="true" tabindex="-1"></a>                   xticklabels<span class="op">=</span><span class="va">self</span>.class_names,</span>
<span id="cb32-326"><a href="#cb32-326" aria-hidden="true" tabindex="-1"></a>                   yticklabels<span class="op">=</span><span class="va">self</span>.class_names)</span>
<span id="cb32-327"><a href="#cb32-327" aria-hidden="true" tabindex="-1"></a>        plt.xlabel(<span class="st">'é¢„æµ‹æ ‡ç­¾'</span>)</span>
<span id="cb32-328"><a href="#cb32-328" aria-hidden="true" tabindex="-1"></a>        plt.ylabel(<span class="st">'çœŸå®æ ‡ç­¾'</span>)</span>
<span id="cb32-329"><a href="#cb32-329" aria-hidden="true" tabindex="-1"></a>        plt.title(<span class="st">'æ··æ·†çŸ©é˜µ'</span>)</span>
<span id="cb32-330"><a href="#cb32-330" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb32-331"><a href="#cb32-331" aria-hidden="true" tabindex="-1"></a>        plt.savefig(<span class="st">'confusion_matrix.png'</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb32-332"><a href="#cb32-332" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb32-333"><a href="#cb32-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-334"><a href="#cb32-334" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> plot_roc_curves(<span class="va">self</span>, labels, probs):</span>
<span id="cb32-335"><a href="#cb32-335" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""ç»˜åˆ¶ ROC æ›²çº¿"""</span></span>
<span id="cb32-336"><a href="#cb32-336" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> sklearn.metrics <span class="im">import</span> roc_curve, auc</span>
<span id="cb32-337"><a href="#cb32-337" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> sklearn.preprocessing <span class="im">import</span> label_binarize</span>
<span id="cb32-338"><a href="#cb32-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-339"><a href="#cb32-339" aria-hidden="true" tabindex="-1"></a>        <span class="co"># äºŒå€¼åŒ–æ ‡ç­¾</span></span>
<span id="cb32-340"><a href="#cb32-340" aria-hidden="true" tabindex="-1"></a>        labels_bin <span class="op">=</span> label_binarize(labels, classes<span class="op">=</span><span class="bu">range</span>(<span class="bu">len</span>(<span class="va">self</span>.class_names)))</span>
<span id="cb32-341"><a href="#cb32-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-342"><a href="#cb32-342" aria-hidden="true" tabindex="-1"></a>        plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">8</span>))</span>
<span id="cb32-343"><a href="#cb32-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-344"><a href="#cb32-344" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, class_name <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>.class_names):</span>
<span id="cb32-345"><a href="#cb32-345" aria-hidden="true" tabindex="-1"></a>            fpr, tpr, _ <span class="op">=</span> roc_curve(labels_bin[:, i], probs[:, i])</span>
<span id="cb32-346"><a href="#cb32-346" aria-hidden="true" tabindex="-1"></a>            roc_auc <span class="op">=</span> auc(fpr, tpr)</span>
<span id="cb32-347"><a href="#cb32-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-348"><a href="#cb32-348" aria-hidden="true" tabindex="-1"></a>            plt.plot(fpr, tpr, label<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>class_name<span class="sc">}</span><span class="ss"> (AUC = </span><span class="sc">{</span>roc_auc<span class="sc">:.2f}</span><span class="ss">)'</span>)</span>
<span id="cb32-349"><a href="#cb32-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-350"><a href="#cb32-350" aria-hidden="true" tabindex="-1"></a>        plt.plot([<span class="dv">0</span>, <span class="dv">1</span>], [<span class="dv">0</span>, <span class="dv">1</span>], <span class="st">'k--'</span>, label<span class="op">=</span><span class="st">'éšæœºçŒœæµ‹'</span>)</span>
<span id="cb32-351"><a href="#cb32-351" aria-hidden="true" tabindex="-1"></a>        plt.xlabel(<span class="st">'False Positive Rate'</span>)</span>
<span id="cb32-352"><a href="#cb32-352" aria-hidden="true" tabindex="-1"></a>        plt.ylabel(<span class="st">'True Positive Rate'</span>)</span>
<span id="cb32-353"><a href="#cb32-353" aria-hidden="true" tabindex="-1"></a>        plt.title(<span class="st">'ROC æ›²çº¿'</span>)</span>
<span id="cb32-354"><a href="#cb32-354" aria-hidden="true" tabindex="-1"></a>        plt.legend()</span>
<span id="cb32-355"><a href="#cb32-355" aria-hidden="true" tabindex="-1"></a>        plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb32-356"><a href="#cb32-356" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb32-357"><a href="#cb32-357" aria-hidden="true" tabindex="-1"></a>        plt.savefig(<span class="st">'roc_curves.png'</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb32-358"><a href="#cb32-358" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb32-359"><a href="#cb32-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-360"><a href="#cb32-360" aria-hidden="true" tabindex="-1"></a><span class="co"># ==================== ä¸»ç¨‹åº ====================</span></span>
<span id="cb32-361"><a href="#cb32-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-362"><a href="#cb32-362" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb32-363"><a href="#cb32-363" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""ä¸»å‡½æ•°"""</span></span>
<span id="cb32-364"><a href="#cb32-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-365"><a href="#cb32-365" aria-hidden="true" tabindex="-1"></a>    <span class="co"># è¶…å‚æ•°</span></span>
<span id="cb32-366"><a href="#cb32-366" aria-hidden="true" tabindex="-1"></a>    DATA_DIR <span class="op">=</span> <span class="st">'./data/medical_images'</span></span>
<span id="cb32-367"><a href="#cb32-367" aria-hidden="true" tabindex="-1"></a>    BATCH_SIZE <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb32-368"><a href="#cb32-368" aria-hidden="true" tabindex="-1"></a>    NUM_EPOCHS <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb32-369"><a href="#cb32-369" aria-hidden="true" tabindex="-1"></a>    LEARNING_RATE <span class="op">=</span> <span class="fl">0.001</span></span>
<span id="cb32-370"><a href="#cb32-370" aria-hidden="true" tabindex="-1"></a>    NUM_CLASSES <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb32-371"><a href="#cb32-371" aria-hidden="true" tabindex="-1"></a>    MODEL_NAME <span class="op">=</span> <span class="st">'resnet50'</span>  <span class="co"># 'resnet50', 'efficientnet_b3', 'vit_b_16'</span></span>
<span id="cb32-372"><a href="#cb32-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-373"><a href="#cb32-373" aria-hidden="true" tabindex="-1"></a>    device <span class="op">=</span> torch.device(<span class="st">'cuda'</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">'cpu'</span>)</span>
<span id="cb32-374"><a href="#cb32-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-375"><a href="#cb32-375" aria-hidden="true" tabindex="-1"></a>    <span class="co"># æ•°æ®åŠ è½½</span></span>
<span id="cb32-376"><a href="#cb32-376" aria-hidden="true" tabindex="-1"></a>    train_dataset <span class="op">=</span> MedicalImageDataset(</span>
<span id="cb32-377"><a href="#cb32-377" aria-hidden="true" tabindex="-1"></a>        os.path.join(DATA_DIR, <span class="st">'train'</span>),</span>
<span id="cb32-378"><a href="#cb32-378" aria-hidden="true" tabindex="-1"></a>        transform<span class="op">=</span>get_transforms(<span class="st">'train'</span>)</span>
<span id="cb32-379"><a href="#cb32-379" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-380"><a href="#cb32-380" aria-hidden="true" tabindex="-1"></a>    val_dataset <span class="op">=</span> MedicalImageDataset(</span>
<span id="cb32-381"><a href="#cb32-381" aria-hidden="true" tabindex="-1"></a>        os.path.join(DATA_DIR, <span class="st">'val'</span>),</span>
<span id="cb32-382"><a href="#cb32-382" aria-hidden="true" tabindex="-1"></a>        transform<span class="op">=</span>get_transforms(<span class="st">'val'</span>)</span>
<span id="cb32-383"><a href="#cb32-383" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-384"><a href="#cb32-384" aria-hidden="true" tabindex="-1"></a>    test_dataset <span class="op">=</span> MedicalImageDataset(</span>
<span id="cb32-385"><a href="#cb32-385" aria-hidden="true" tabindex="-1"></a>        os.path.join(DATA_DIR, <span class="st">'test'</span>),</span>
<span id="cb32-386"><a href="#cb32-386" aria-hidden="true" tabindex="-1"></a>        transform<span class="op">=</span>get_transforms(<span class="st">'test'</span>)</span>
<span id="cb32-387"><a href="#cb32-387" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-388"><a href="#cb32-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-389"><a href="#cb32-389" aria-hidden="true" tabindex="-1"></a>    train_loader <span class="op">=</span> DataLoader(train_dataset, batch_size<span class="op">=</span>BATCH_SIZE,</span>
<span id="cb32-390"><a href="#cb32-390" aria-hidden="true" tabindex="-1"></a>                             shuffle<span class="op">=</span><span class="va">True</span>, num_workers<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb32-391"><a href="#cb32-391" aria-hidden="true" tabindex="-1"></a>    val_loader <span class="op">=</span> DataLoader(val_dataset, batch_size<span class="op">=</span>BATCH_SIZE,</span>
<span id="cb32-392"><a href="#cb32-392" aria-hidden="true" tabindex="-1"></a>                           shuffle<span class="op">=</span><span class="va">False</span>, num_workers<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb32-393"><a href="#cb32-393" aria-hidden="true" tabindex="-1"></a>    test_loader <span class="op">=</span> DataLoader(test_dataset, batch_size<span class="op">=</span>BATCH_SIZE,</span>
<span id="cb32-394"><a href="#cb32-394" aria-hidden="true" tabindex="-1"></a>                            shuffle<span class="op">=</span><span class="va">False</span>, num_workers<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb32-395"><a href="#cb32-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-396"><a href="#cb32-396" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"è®­ç»ƒé›†: </span><span class="sc">{</span><span class="bu">len</span>(train_dataset)<span class="sc">}</span><span class="ss"> å¼ "</span>)</span>
<span id="cb32-397"><a href="#cb32-397" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"éªŒè¯é›†: </span><span class="sc">{</span><span class="bu">len</span>(val_dataset)<span class="sc">}</span><span class="ss"> å¼ "</span>)</span>
<span id="cb32-398"><a href="#cb32-398" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"æµ‹è¯•é›†: </span><span class="sc">{</span><span class="bu">len</span>(test_dataset)<span class="sc">}</span><span class="ss"> å¼ "</span>)</span>
<span id="cb32-399"><a href="#cb32-399" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"ç±»åˆ«: </span><span class="sc">{</span>train_dataset<span class="sc">.</span>classes<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-400"><a href="#cb32-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-401"><a href="#cb32-401" aria-hidden="true" tabindex="-1"></a>    <span class="co"># åˆ›å»ºæ¨¡å‹</span></span>
<span id="cb32-402"><a href="#cb32-402" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> TransferLearningModel(</span>
<span id="cb32-403"><a href="#cb32-403" aria-hidden="true" tabindex="-1"></a>        model_name<span class="op">=</span>MODEL_NAME,</span>
<span id="cb32-404"><a href="#cb32-404" aria-hidden="true" tabindex="-1"></a>        num_classes<span class="op">=</span>NUM_CLASSES,</span>
<span id="cb32-405"><a href="#cb32-405" aria-hidden="true" tabindex="-1"></a>        pretrained<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb32-406"><a href="#cb32-406" aria-hidden="true" tabindex="-1"></a>        freeze_backbone<span class="op">=</span><span class="va">False</span>  <span class="co"># å…ˆå…¨å±€å¾®è°ƒ</span></span>
<span id="cb32-407"><a href="#cb32-407" aria-hidden="true" tabindex="-1"></a>    ).to(device)</span>
<span id="cb32-408"><a href="#cb32-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-409"><a href="#cb32-409" aria-hidden="true" tabindex="-1"></a>    <span class="co"># æŸå¤±å’Œä¼˜åŒ–å™¨</span></span>
<span id="cb32-410"><a href="#cb32-410" aria-hidden="true" tabindex="-1"></a>    criterion <span class="op">=</span> nn.CrossEntropyLoss()</span>
<span id="cb32-411"><a href="#cb32-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-412"><a href="#cb32-412" aria-hidden="true" tabindex="-1"></a>    <span class="co"># åˆ†å±‚å­¦ä¹ ç‡</span></span>
<span id="cb32-413"><a href="#cb32-413" aria-hidden="true" tabindex="-1"></a>    backbone_params <span class="op">=</span> []</span>
<span id="cb32-414"><a href="#cb32-414" aria-hidden="true" tabindex="-1"></a>    classifier_params <span class="op">=</span> []</span>
<span id="cb32-415"><a href="#cb32-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-416"><a href="#cb32-416" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, param <span class="kw">in</span> model.named_parameters():</span>
<span id="cb32-417"><a href="#cb32-417" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'fc'</span> <span class="kw">in</span> name <span class="kw">or</span> <span class="st">'classifier'</span> <span class="kw">in</span> name <span class="kw">or</span> <span class="st">'head'</span> <span class="kw">in</span> name:</span>
<span id="cb32-418"><a href="#cb32-418" aria-hidden="true" tabindex="-1"></a>            classifier_params.append(param)</span>
<span id="cb32-419"><a href="#cb32-419" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb32-420"><a href="#cb32-420" aria-hidden="true" tabindex="-1"></a>            backbone_params.append(param)</span>
<span id="cb32-421"><a href="#cb32-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-422"><a href="#cb32-422" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> optim.Adam([</span>
<span id="cb32-423"><a href="#cb32-423" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'params'</span>: backbone_params, <span class="st">'lr'</span>: LEARNING_RATE <span class="op">*</span> <span class="fl">0.1</span>},</span>
<span id="cb32-424"><a href="#cb32-424" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'params'</span>: classifier_params, <span class="st">'lr'</span>: LEARNING_RATE}</span>
<span id="cb32-425"><a href="#cb32-425" aria-hidden="true" tabindex="-1"></a>    ], weight_decay<span class="op">=</span><span class="fl">1e-4</span>)</span>
<span id="cb32-426"><a href="#cb32-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-427"><a href="#cb32-427" aria-hidden="true" tabindex="-1"></a>    <span class="co"># å­¦ä¹ ç‡è°ƒåº¦</span></span>
<span id="cb32-428"><a href="#cb32-428" aria-hidden="true" tabindex="-1"></a>    scheduler <span class="op">=</span> optim.lr_scheduler.ReduceLROnPlateau(</span>
<span id="cb32-429"><a href="#cb32-429" aria-hidden="true" tabindex="-1"></a>        optimizer, mode<span class="op">=</span><span class="st">'min'</span>, patience<span class="op">=</span><span class="dv">5</span>, factor<span class="op">=</span><span class="fl">0.5</span>, verbose<span class="op">=</span><span class="va">True</span></span>
<span id="cb32-430"><a href="#cb32-430" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-431"><a href="#cb32-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-432"><a href="#cb32-432" aria-hidden="true" tabindex="-1"></a>    <span class="co"># è®­ç»ƒ</span></span>
<span id="cb32-433"><a href="#cb32-433" aria-hidden="true" tabindex="-1"></a>    trainer <span class="op">=</span> Trainer(</span>
<span id="cb32-434"><a href="#cb32-434" aria-hidden="true" tabindex="-1"></a>        model<span class="op">=</span>model,</span>
<span id="cb32-435"><a href="#cb32-435" aria-hidden="true" tabindex="-1"></a>        train_loader<span class="op">=</span>train_loader,</span>
<span id="cb32-436"><a href="#cb32-436" aria-hidden="true" tabindex="-1"></a>        val_loader<span class="op">=</span>val_loader,</span>
<span id="cb32-437"><a href="#cb32-437" aria-hidden="true" tabindex="-1"></a>        criterion<span class="op">=</span>criterion,</span>
<span id="cb32-438"><a href="#cb32-438" aria-hidden="true" tabindex="-1"></a>        optimizer<span class="op">=</span>optimizer,</span>
<span id="cb32-439"><a href="#cb32-439" aria-hidden="true" tabindex="-1"></a>        scheduler<span class="op">=</span>scheduler,</span>
<span id="cb32-440"><a href="#cb32-440" aria-hidden="true" tabindex="-1"></a>        device<span class="op">=</span>device,</span>
<span id="cb32-441"><a href="#cb32-441" aria-hidden="true" tabindex="-1"></a>        num_epochs<span class="op">=</span>NUM_EPOCHS,</span>
<span id="cb32-442"><a href="#cb32-442" aria-hidden="true" tabindex="-1"></a>        early_stopping_patience<span class="op">=</span><span class="dv">10</span></span>
<span id="cb32-443"><a href="#cb32-443" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-444"><a href="#cb32-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-445"><a href="#cb32-445" aria-hidden="true" tabindex="-1"></a>    history <span class="op">=</span> trainer.train()</span>
<span id="cb32-446"><a href="#cb32-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-447"><a href="#cb32-447" aria-hidden="true" tabindex="-1"></a>    <span class="co"># å¯è§†åŒ–è®­ç»ƒè¿‡ç¨‹</span></span>
<span id="cb32-448"><a href="#cb32-448" aria-hidden="true" tabindex="-1"></a>    plot_training_history(history)</span>
<span id="cb32-449"><a href="#cb32-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-450"><a href="#cb32-450" aria-hidden="true" tabindex="-1"></a>    <span class="co"># è¯„ä¼°</span></span>
<span id="cb32-451"><a href="#cb32-451" aria-hidden="true" tabindex="-1"></a>    evaluator <span class="op">=</span> Evaluator(</span>
<span id="cb32-452"><a href="#cb32-452" aria-hidden="true" tabindex="-1"></a>        model<span class="op">=</span>model,</span>
<span id="cb32-453"><a href="#cb32-453" aria-hidden="true" tabindex="-1"></a>        test_loader<span class="op">=</span>test_loader,</span>
<span id="cb32-454"><a href="#cb32-454" aria-hidden="true" tabindex="-1"></a>        class_names<span class="op">=</span>train_dataset.classes,</span>
<span id="cb32-455"><a href="#cb32-455" aria-hidden="true" tabindex="-1"></a>        device<span class="op">=</span>device</span>
<span id="cb32-456"><a href="#cb32-456" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-457"><a href="#cb32-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-458"><a href="#cb32-458" aria-hidden="true" tabindex="-1"></a>    preds, labels, probs <span class="op">=</span> evaluator.evaluate()</span>
<span id="cb32-459"><a href="#cb32-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-460"><a href="#cb32-460" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Grad-CAM å¯è§†åŒ–</span></span>
<span id="cb32-461"><a href="#cb32-461" aria-hidden="true" tabindex="-1"></a>    visualize_gradcam(model, test_loader, device, num_images<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb32-462"><a href="#cb32-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-463"><a href="#cb32-463" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model, history</span>
<span id="cb32-464"><a href="#cb32-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-465"><a href="#cb32-465" aria-hidden="true" tabindex="-1"></a><span class="co"># ==================== å¯è§†åŒ–å‡½æ•° ====================</span></span>
<span id="cb32-466"><a href="#cb32-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-467"><a href="#cb32-467" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_training_history(history):</span>
<span id="cb32-468"><a href="#cb32-468" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""ç»˜åˆ¶è®­ç»ƒå†å²"""</span></span>
<span id="cb32-469"><a href="#cb32-469" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">5</span>))</span>
<span id="cb32-470"><a href="#cb32-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-471"><a href="#cb32-471" aria-hidden="true" tabindex="-1"></a>    epochs <span class="op">=</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(history[<span class="st">'train_loss'</span>]) <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb32-472"><a href="#cb32-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-473"><a href="#cb32-473" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loss</span></span>
<span id="cb32-474"><a href="#cb32-474" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].plot(epochs, history[<span class="st">'train_loss'</span>], <span class="st">'b-'</span>, label<span class="op">=</span><span class="st">'è®­ç»ƒ Loss'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb32-475"><a href="#cb32-475" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].plot(epochs, history[<span class="st">'val_loss'</span>], <span class="st">'r-'</span>, label<span class="op">=</span><span class="st">'éªŒè¯ Loss'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb32-476"><a href="#cb32-476" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_xlabel(<span class="st">'Epoch'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb32-477"><a href="#cb32-477" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Loss'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb32-478"><a href="#cb32-478" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_title(<span class="st">'è®­ç»ƒå’ŒéªŒè¯ Loss'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb32-479"><a href="#cb32-479" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].legend(fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb32-480"><a href="#cb32-480" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb32-481"><a href="#cb32-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-482"><a href="#cb32-482" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Accuracy</span></span>
<span id="cb32-483"><a href="#cb32-483" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].plot(epochs, history[<span class="st">'train_acc'</span>], <span class="st">'b-'</span>, label<span class="op">=</span><span class="st">'è®­ç»ƒå‡†ç¡®ç‡'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb32-484"><a href="#cb32-484" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].plot(epochs, history[<span class="st">'val_acc'</span>], <span class="st">'r-'</span>, label<span class="op">=</span><span class="st">'éªŒè¯å‡†ç¡®ç‡'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb32-485"><a href="#cb32-485" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Epoch'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb32-486"><a href="#cb32-486" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_ylabel(<span class="st">'å‡†ç¡®ç‡ (%)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb32-487"><a href="#cb32-487" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_title(<span class="st">'è®­ç»ƒå’ŒéªŒè¯å‡†ç¡®ç‡'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb32-488"><a href="#cb32-488" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].legend(fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb32-489"><a href="#cb32-489" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb32-490"><a href="#cb32-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-491"><a href="#cb32-491" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb32-492"><a href="#cb32-492" aria-hidden="true" tabindex="-1"></a>    plt.savefig(<span class="st">'training_history.png'</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb32-493"><a href="#cb32-493" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb32-494"><a href="#cb32-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-495"><a href="#cb32-495" aria-hidden="true" tabindex="-1"></a><span class="co"># ==================== Grad-CAM å¯è§†åŒ– ====================</span></span>
<span id="cb32-496"><a href="#cb32-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-497"><a href="#cb32-497" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GradCAM:</span>
<span id="cb32-498"><a href="#cb32-498" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Grad-CAM ç±»æ¿€æ´»æ˜ å°„"""</span></span>
<span id="cb32-499"><a href="#cb32-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-500"><a href="#cb32-500" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, model, target_layer):</span>
<span id="cb32-501"><a href="#cb32-501" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> model</span>
<span id="cb32-502"><a href="#cb32-502" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.target_layer <span class="op">=</span> target_layer</span>
<span id="cb32-503"><a href="#cb32-503" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.gradients <span class="op">=</span> <span class="va">None</span></span>
<span id="cb32-504"><a href="#cb32-504" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.activations <span class="op">=</span> <span class="va">None</span></span>
<span id="cb32-505"><a href="#cb32-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-506"><a href="#cb32-506" aria-hidden="true" tabindex="-1"></a>        <span class="co"># æ³¨å†Œé’©å­</span></span>
<span id="cb32-507"><a href="#cb32-507" aria-hidden="true" tabindex="-1"></a>        target_layer.register_forward_hook(<span class="va">self</span>.save_activation)</span>
<span id="cb32-508"><a href="#cb32-508" aria-hidden="true" tabindex="-1"></a>        target_layer.register_backward_hook(<span class="va">self</span>.save_gradient)</span>
<span id="cb32-509"><a href="#cb32-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-510"><a href="#cb32-510" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> save_activation(<span class="va">self</span>, module, <span class="bu">input</span>, output):</span>
<span id="cb32-511"><a href="#cb32-511" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.activations <span class="op">=</span> output.detach()</span>
<span id="cb32-512"><a href="#cb32-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-513"><a href="#cb32-513" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> save_gradient(<span class="va">self</span>, module, grad_input, grad_output):</span>
<span id="cb32-514"><a href="#cb32-514" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.gradients <span class="op">=</span> grad_output[<span class="dv">0</span>].detach()</span>
<span id="cb32-515"><a href="#cb32-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-516"><a href="#cb32-516" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> generate_cam(<span class="va">self</span>, input_image, target_class<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb32-517"><a href="#cb32-517" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""ç”Ÿæˆ CAM"""</span></span>
<span id="cb32-518"><a href="#cb32-518" aria-hidden="true" tabindex="-1"></a>        <span class="co"># å‰å‘ä¼ æ’­</span></span>
<span id="cb32-519"><a href="#cb32-519" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> <span class="va">self</span>.model(input_image)</span>
<span id="cb32-520"><a href="#cb32-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-521"><a href="#cb32-521" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> target_class <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb32-522"><a href="#cb32-522" aria-hidden="true" tabindex="-1"></a>            target_class <span class="op">=</span> output.argmax(dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb32-523"><a href="#cb32-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-524"><a href="#cb32-524" aria-hidden="true" tabindex="-1"></a>        <span class="co"># åå‘ä¼ æ’­</span></span>
<span id="cb32-525"><a href="#cb32-525" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model.zero_grad()</span>
<span id="cb32-526"><a href="#cb32-526" aria-hidden="true" tabindex="-1"></a>        class_score <span class="op">=</span> output[:, target_class]</span>
<span id="cb32-527"><a href="#cb32-527" aria-hidden="true" tabindex="-1"></a>        class_score.backward()</span>
<span id="cb32-528"><a href="#cb32-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-529"><a href="#cb32-529" aria-hidden="true" tabindex="-1"></a>        <span class="co"># è®¡ç®—æƒé‡</span></span>
<span id="cb32-530"><a href="#cb32-530" aria-hidden="true" tabindex="-1"></a>        pooled_gradients <span class="op">=</span> torch.mean(<span class="va">self</span>.gradients, dim<span class="op">=</span>[<span class="dv">2</span>, <span class="dv">3</span>])</span>
<span id="cb32-531"><a href="#cb32-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-532"><a href="#cb32-532" aria-hidden="true" tabindex="-1"></a>        <span class="co"># åŠ æƒæ±‚å’Œ</span></span>
<span id="cb32-533"><a href="#cb32-533" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.activations.size(<span class="dv">1</span>)):</span>
<span id="cb32-534"><a href="#cb32-534" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.activations[:, i, :, :] <span class="op">*=</span> pooled_gradients[:, i].view(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb32-535"><a href="#cb32-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-536"><a href="#cb32-536" aria-hidden="true" tabindex="-1"></a>        <span class="co"># CAM</span></span>
<span id="cb32-537"><a href="#cb32-537" aria-hidden="true" tabindex="-1"></a>        cam <span class="op">=</span> torch.mean(<span class="va">self</span>.activations, dim<span class="op">=</span><span class="dv">1</span>).squeeze()</span>
<span id="cb32-538"><a href="#cb32-538" aria-hidden="true" tabindex="-1"></a>        cam <span class="op">=</span> F.relu(cam)</span>
<span id="cb32-539"><a href="#cb32-539" aria-hidden="true" tabindex="-1"></a>        cam <span class="op">=</span> cam <span class="op">-</span> cam.<span class="bu">min</span>()</span>
<span id="cb32-540"><a href="#cb32-540" aria-hidden="true" tabindex="-1"></a>        cam <span class="op">=</span> cam <span class="op">/</span> cam.<span class="bu">max</span>()</span>
<span id="cb32-541"><a href="#cb32-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-542"><a href="#cb32-542" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> cam.cpu().numpy()</span>
<span id="cb32-543"><a href="#cb32-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-544"><a href="#cb32-544" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> visualize_gradcam(model, test_loader, device, num_images<span class="op">=</span><span class="dv">8</span>):</span>
<span id="cb32-545"><a href="#cb32-545" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""å¯è§†åŒ– Grad-CAM"""</span></span>
<span id="cb32-546"><a href="#cb32-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-547"><a href="#cb32-547" aria-hidden="true" tabindex="-1"></a>    <span class="co"># è·å–ç›®æ ‡å±‚</span></span>
<span id="cb32-548"><a href="#cb32-548" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(model.backbone, <span class="st">'layer4'</span>):</span>
<span id="cb32-549"><a href="#cb32-549" aria-hidden="true" tabindex="-1"></a>        target_layer <span class="op">=</span> model.backbone.layer4[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb32-550"><a href="#cb32-550" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">hasattr</span>(model.backbone, <span class="st">'features'</span>):</span>
<span id="cb32-551"><a href="#cb32-551" aria-hidden="true" tabindex="-1"></a>        target_layer <span class="op">=</span> model.backbone.features[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb32-552"><a href="#cb32-552" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb32-553"><a href="#cb32-553" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"æ— æ³•æ‰¾åˆ°ç›®æ ‡å±‚ï¼Œè·³è¿‡ Grad-CAM"</span>)</span>
<span id="cb32-554"><a href="#cb32-554" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb32-555"><a href="#cb32-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-556"><a href="#cb32-556" aria-hidden="true" tabindex="-1"></a>    gradcam <span class="op">=</span> GradCAM(model, target_layer)</span>
<span id="cb32-557"><a href="#cb32-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-558"><a href="#cb32-558" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="cb32-559"><a href="#cb32-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-560"><a href="#cb32-560" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">4</span>, <span class="dv">4</span>, figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">16</span>))</span>
<span id="cb32-561"><a href="#cb32-561" aria-hidden="true" tabindex="-1"></a>    axes <span class="op">=</span> axes.flatten()</span>
<span id="cb32-562"><a href="#cb32-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-563"><a href="#cb32-563" aria-hidden="true" tabindex="-1"></a>    images_shown <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb32-564"><a href="#cb32-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-565"><a href="#cb32-565" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> images, labels <span class="kw">in</span> test_loader:</span>
<span id="cb32-566"><a href="#cb32-566" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> images_shown <span class="op">&gt;=</span> num_images:</span>
<span id="cb32-567"><a href="#cb32-567" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb32-568"><a href="#cb32-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-569"><a href="#cb32-569" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">min</span>(<span class="bu">len</span>(images), num_images <span class="op">-</span> images_shown)):</span>
<span id="cb32-570"><a href="#cb32-570" aria-hidden="true" tabindex="-1"></a>            image <span class="op">=</span> images[i:i<span class="op">+</span><span class="dv">1</span>].to(device)</span>
<span id="cb32-571"><a href="#cb32-571" aria-hidden="true" tabindex="-1"></a>            label <span class="op">=</span> labels[i].item()</span>
<span id="cb32-572"><a href="#cb32-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-573"><a href="#cb32-573" aria-hidden="true" tabindex="-1"></a>            <span class="co"># ç”Ÿæˆ CAM</span></span>
<span id="cb32-574"><a href="#cb32-574" aria-hidden="true" tabindex="-1"></a>            cam <span class="op">=</span> gradcam.generate_cam(image)</span>
<span id="cb32-575"><a href="#cb32-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-576"><a href="#cb32-576" aria-hidden="true" tabindex="-1"></a>            <span class="co"># åå½’ä¸€åŒ–å›¾åƒ</span></span>
<span id="cb32-577"><a href="#cb32-577" aria-hidden="true" tabindex="-1"></a>            img <span class="op">=</span> images[i].cpu().numpy().transpose(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>)</span>
<span id="cb32-578"><a href="#cb32-578" aria-hidden="true" tabindex="-1"></a>            mean <span class="op">=</span> np.array([<span class="fl">0.485</span>, <span class="fl">0.456</span>, <span class="fl">0.406</span>])</span>
<span id="cb32-579"><a href="#cb32-579" aria-hidden="true" tabindex="-1"></a>            std <span class="op">=</span> np.array([<span class="fl">0.229</span>, <span class="fl">0.224</span>, <span class="fl">0.225</span>])</span>
<span id="cb32-580"><a href="#cb32-580" aria-hidden="true" tabindex="-1"></a>            img <span class="op">=</span> std <span class="op">*</span> img <span class="op">+</span> mean</span>
<span id="cb32-581"><a href="#cb32-581" aria-hidden="true" tabindex="-1"></a>            img <span class="op">=</span> np.clip(img, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb32-582"><a href="#cb32-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-583"><a href="#cb32-583" aria-hidden="true" tabindex="-1"></a>            <span class="co"># è°ƒæ•´ CAM å¤§å°</span></span>
<span id="cb32-584"><a href="#cb32-584" aria-hidden="true" tabindex="-1"></a>            <span class="im">import</span> cv2</span>
<span id="cb32-585"><a href="#cb32-585" aria-hidden="true" tabindex="-1"></a>            cam_resized <span class="op">=</span> cv2.resize(cam, (<span class="dv">224</span>, <span class="dv">224</span>))</span>
<span id="cb32-586"><a href="#cb32-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-587"><a href="#cb32-587" aria-hidden="true" tabindex="-1"></a>            <span class="co"># å åŠ æ˜¾ç¤º</span></span>
<span id="cb32-588"><a href="#cb32-588" aria-hidden="true" tabindex="-1"></a>            ax <span class="op">=</span> axes[images_shown <span class="op">*</span> <span class="dv">2</span>]</span>
<span id="cb32-589"><a href="#cb32-589" aria-hidden="true" tabindex="-1"></a>            ax.imshow(img)</span>
<span id="cb32-590"><a href="#cb32-590" aria-hidden="true" tabindex="-1"></a>            ax.set_title(<span class="ss">f'åŸå›¾ (æ ‡ç­¾: </span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">)'</span>)</span>
<span id="cb32-591"><a href="#cb32-591" aria-hidden="true" tabindex="-1"></a>            ax.axis(<span class="st">'off'</span>)</span>
<span id="cb32-592"><a href="#cb32-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-593"><a href="#cb32-593" aria-hidden="true" tabindex="-1"></a>            ax <span class="op">=</span> axes[images_shown <span class="op">*</span> <span class="dv">2</span> <span class="op">+</span> <span class="dv">1</span>]</span>
<span id="cb32-594"><a href="#cb32-594" aria-hidden="true" tabindex="-1"></a>            ax.imshow(img)</span>
<span id="cb32-595"><a href="#cb32-595" aria-hidden="true" tabindex="-1"></a>            ax.imshow(cam_resized, cmap<span class="op">=</span><span class="st">'jet'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb32-596"><a href="#cb32-596" aria-hidden="true" tabindex="-1"></a>            ax.set_title(<span class="st">'Grad-CAM'</span>)</span>
<span id="cb32-597"><a href="#cb32-597" aria-hidden="true" tabindex="-1"></a>            ax.axis(<span class="st">'off'</span>)</span>
<span id="cb32-598"><a href="#cb32-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-599"><a href="#cb32-599" aria-hidden="true" tabindex="-1"></a>            images_shown <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb32-600"><a href="#cb32-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-601"><a href="#cb32-601" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> images_shown <span class="op">&gt;=</span> num_images:</span>
<span id="cb32-602"><a href="#cb32-602" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb32-603"><a href="#cb32-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-604"><a href="#cb32-604" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb32-605"><a href="#cb32-605" aria-hidden="true" tabindex="-1"></a>    plt.savefig(<span class="st">'gradcam_visualization.png'</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb32-606"><a href="#cb32-606" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb32-607"><a href="#cb32-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-608"><a href="#cb32-608" aria-hidden="true" tabindex="-1"></a><span class="co"># ==================== è¿è¡Œ ====================</span></span>
<span id="cb32-609"><a href="#cb32-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-610"><a href="#cb32-610" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb32-611"><a href="#cb32-611" aria-hidden="true" tabindex="-1"></a>    model, history <span class="op">=</span> main()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
</section>
</section>
<section id="è¿ç§»å­¦ä¹ æœ€ä½³å®è·µ" class="level2">
<h2 class="anchored" data-anchor-id="è¿ç§»å­¦ä¹ æœ€ä½³å®è·µ">9.9 è¿ç§»å­¦ä¹ æœ€ä½³å®è·µ</h2>
<section id="æ•°æ®é›†å¤§å°ç­–ç•¥" class="level3">
<h3 class="anchored" data-anchor-id="æ•°æ®é›†å¤§å°ç­–ç•¥">âœ… æ•°æ®é›†å¤§å°ç­–ç•¥</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> choose_strategy(dataset_size, similarity_to_pretrain):</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co">    æ ¹æ®æ•°æ®é›†å¤§å°å’Œç›¸ä¼¼åº¦é€‰æ‹©ç­–ç•¥</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co">    å‚æ•°ï¼š</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="co">        dataset_size: æ•°æ®é›†å¤§å°</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="co">        similarity_to_pretrain: ä¸é¢„è®­ç»ƒæ•°æ®çš„ç›¸ä¼¼åº¦</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> dataset_size <span class="op">&lt;</span> <span class="dv">1000</span>:</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> similarity_to_pretrain <span class="op">==</span> <span class="st">'high'</span>:</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"ç‰¹å¾æå–ï¼ˆå†»ç»“éª¨å¹²ç½‘ç»œï¼‰"</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"æ•°æ®å¢å¼º + è½»å¾®å¾®è°ƒï¼ˆå°å­¦ä¹ ç‡ï¼‰"</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="dv">1000</span> <span class="op">&lt;=</span> dataset_size <span class="op">&lt;</span> <span class="dv">10000</span>:</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> similarity_to_pretrain <span class="op">==</span> <span class="st">'high'</span>:</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"å¾®è°ƒé¡¶å±‚ï¼ˆè§£å†»åå‡ å±‚ï¼‰"</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"å…¨å±€å¾®è°ƒï¼ˆå°å­¦ä¹ ç‡ + æ•°æ®å¢å¼ºï¼‰"</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:  <span class="co"># &gt; 10000</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> similarity_to_pretrain <span class="op">==</span> <span class="st">'high'</span>:</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"å…¨å±€å¾®è°ƒ"</span></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"å…¨å±€å¾®è°ƒ æˆ– ä»å¤´è®­ç»ƒ"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="å­¦ä¹ ç‡ç­–ç•¥" class="level3">
<h3 class="anchored" data-anchor-id="å­¦ä¹ ç‡ç­–ç•¥">ğŸ“Š å­¦ä¹ ç‡ç­–ç•¥</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ç­–ç•¥1ï¼šåˆ¤åˆ«å¼å­¦ä¹ ç‡</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> optim.Adam([</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'params'</span>: model.layer1.parameters(), <span class="st">'lr'</span>: <span class="fl">1e-5</span>},</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'params'</span>: model.layer2.parameters(), <span class="st">'lr'</span>: <span class="fl">1e-4</span>},</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'params'</span>: model.layer3.parameters(), <span class="st">'lr'</span>: <span class="fl">1e-3</span>},</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'params'</span>: model.fc.parameters(), <span class="st">'lr'</span>: <span class="fl">1e-2</span>}</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ç­–ç•¥2ï¼šæ¸è¿›å¼è§£å†»</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> progressive_unfreezing(model, epoch, unfreeze_schedule):</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="co">    æ¸è¿›å¼è§£å†»</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a><span class="co">    unfreeze_schedule: {epoch: [layer_names]}</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> epoch <span class="kw">in</span> unfreeze_schedule:</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> layer_name <span class="kw">in</span> unfreeze_schedule[epoch]:</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>            layer <span class="op">=</span> <span class="bu">getattr</span>(model, layer_name)</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> param <span class="kw">in</span> layer.parameters():</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>                param.requires_grad <span class="op">=</span> <span class="va">True</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Epoch </span><span class="sc">{</span>epoch<span class="sc">}</span><span class="ss">: è§£å†» </span><span class="sc">{</span>unfreeze_schedule[epoch]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a><span class="co"># ä½¿ç”¨</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>unfreeze_schedule <span class="op">=</span> {</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>: [<span class="st">'fc'</span>],           <span class="co"># epoch 0: åªè®­ç»ƒåˆ†ç±»å™¨</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>    <span class="dv">5</span>: [<span class="st">'layer4'</span>],       <span class="co"># epoch 5: è§£å†» layer4</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>    <span class="dv">10</span>: [<span class="st">'layer3'</span>],      <span class="co"># epoch 10: è§£å†» layer3</span></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>    <span class="dv">15</span>: [<span class="st">'layer2'</span>],      <span class="co"># epoch 15: è§£å†» layer2</span></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="æ•°æ®å¢å¼ºæŠ€å·§" class="level3">
<h3 class="anchored" data-anchor-id="æ•°æ®å¢å¼ºæŠ€å·§">ğŸ¯ æ•°æ®å¢å¼ºæŠ€å·§</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># é«˜çº§æ•°æ®å¢å¼º</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision.transforms <span class="im">import</span> autoaugment, v2</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>advanced_transforms <span class="op">=</span> transforms.Compose([</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    transforms.Resize((<span class="dv">256</span>, <span class="dv">256</span>)),</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    transforms.RandomCrop(<span class="dv">224</span>),</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># AutoAugment</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    autoaugment.AutoAugment(</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>        autoaugment.AutoAugmentPolicy.IMAGENET</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># RandAugment</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># autoaugment.RandAugment(),</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mixup / CutMix (éœ€è¦ç‰¹æ®Šå¤„ç†)</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    transforms.ToTensor(),</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>    transforms.Normalize([<span class="fl">0.485</span>, <span class="fl">0.456</span>, <span class="fl">0.406</span>],</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>                        [<span class="fl">0.229</span>, <span class="fl">0.224</span>, <span class="fl">0.225</span>])</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Mixup</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MixupDataset(Dataset):</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, dataset, alpha<span class="op">=</span><span class="fl">0.2</span>):</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dataset <span class="op">=</span> dataset</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.alpha <span class="op">=</span> alpha</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.dataset)</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx):</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>        img1, label1 <span class="op">=</span> <span class="va">self</span>.dataset[idx]</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># éšæœºé€‰æ‹©å¦ä¸€ä¸ªæ ·æœ¬</span></span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>        idx2 <span class="op">=</span> np.random.randint(<span class="dv">0</span>, <span class="bu">len</span>(<span class="va">self</span>.dataset))</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>        img2, label2 <span class="op">=</span> <span class="va">self</span>.dataset[idx2]</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Mixup</span></span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>        lam <span class="op">=</span> np.random.beta(<span class="va">self</span>.alpha, <span class="va">self</span>.alpha)</span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>        mixed_img <span class="op">=</span> lam <span class="op">*</span> img1 <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> lam) <span class="op">*</span> img2</span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> mixed_img, (label1, label2, lam)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
</section>
</section>
<section id="æœ¬ç« ä½œä¸š" class="level2">
<h2 class="anchored" data-anchor-id="æœ¬ç« ä½œä¸š">ğŸ“ æœ¬ç« ä½œä¸š</h2>
<section id="ä½œä¸š-1å¯¹æ¯”å®éªŒ" class="level3">
<h3 class="anchored" data-anchor-id="ä½œä¸š-1å¯¹æ¯”å®éªŒ">ä½œä¸š 1ï¼šå¯¹æ¯”å®éªŒ</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># åœ¨åŒä¸€ä¸ªæ•°æ®é›†ä¸Šå¯¹æ¯”ï¼š</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. ä»é›¶è®­ç»ƒ</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. ç‰¹å¾æå–</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. å¾®è°ƒï¼ˆå†»ç»“éƒ¨åˆ†å±‚ï¼‰</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. å¾®è°ƒï¼ˆå…¨å±€ï¼‰</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. çŸ¥è¯†è’¸é¦</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="co"># è®°å½•ï¼š</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   - è®­ç»ƒæ—¶é—´</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="co">#   - æœ€ç»ˆå‡†ç¡®ç‡</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="co">#   - å‚æ•°é‡</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="co">#   - æ”¶æ•›æ›²çº¿</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="co"># åˆ†æï¼šå“ªç§ç­–ç•¥æœ€é€‚åˆä½ çš„æ•°æ®é›†ï¼Ÿ</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="ä½œä¸š-2åŒ»å­¦å›¾åƒåˆ†ç±»" class="level3">
<h3 class="anchored" data-anchor-id="ä½œä¸š-2åŒ»å­¦å›¾åƒåˆ†ç±»">ä½œä¸š 2ï¼šåŒ»å­¦å›¾åƒåˆ†ç±»</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ä½¿ç”¨çœŸå®åŒ»å­¦å›¾åƒæ•°æ®é›†ï¼ˆå¦‚ Chest X-Rayï¼‰</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="co"># è¦æ±‚ï¼š</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. EDA å’Œæ•°æ®é¢„å¤„ç†</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. å°è¯•è‡³å°‘ 3 ç§é¢„è®­ç»ƒæ¨¡å‹</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. å®ç°æ•°æ®å¢å¼º</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. ä½¿ç”¨ Grad-CAM å¯è§†åŒ–</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. è¯„ä¼°æ¨¡å‹æ€§èƒ½ï¼ˆå‡†ç¡®ç‡ã€F1ã€AUCï¼‰</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. åˆ†æé”™è¯¯æ¡ˆä¾‹</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. ç¼–å†™å®Œæ•´æŠ¥å‘Š</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="ä½œä¸š-3å°‘æ ·æœ¬å­¦ä¹ " class="level3">
<h3 class="anchored" data-anchor-id="ä½œä¸š-3å°‘æ ·æœ¬å­¦ä¹ ">ä½œä¸š 3ï¼šå°‘æ ·æœ¬å­¦ä¹ </h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># å®ç°å°‘æ ·æœ¬å­¦ä¹ </span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ä»»åŠ¡ï¼š5-way 1-shot / 5-shot åˆ†ç±»</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="co"># æ–¹æ³•ï¼š</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. åŸå‹ç½‘ç»œ</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. MAML</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. å¯¹æ¯”å­¦ä¹ ï¼ˆSimCLRï¼‰</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="co"># åœ¨ Omniglot æˆ– Mini-ImageNet ä¸Šæµ‹è¯•</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="ä½œä¸š-4é¢†åŸŸè‡ªé€‚åº”" class="level3">
<h3 class="anchored" data-anchor-id="ä½œä¸š-4é¢†åŸŸè‡ªé€‚åº”">ä½œä¸š 4ï¼šé¢†åŸŸè‡ªé€‚åº”</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># å®ç°é¢†åŸŸè‡ªé€‚åº”</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="co"># æºåŸŸï¼šMNIST</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ç›®æ ‡åŸŸï¼šSVHN æˆ– USPS</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="co"># æ–¹æ³•ï¼š</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. é¢†åŸŸå¯¹æŠ—è®­ç»ƒ</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. è‡ªè®­ç»ƒ</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. å¯¹æ¯”ä¸¤ç§æ–¹æ³•çš„æ•ˆæœ</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
</section>
</section>
<section id="æœ¬ç« å…³é”®æ¦‚å¿µ" class="level2">
<h2 class="anchored" data-anchor-id="æœ¬ç« å…³é”®æ¦‚å¿µ">ğŸ”‘ æœ¬ç« å…³é”®æ¦‚å¿µ</h2>
<table class="caption-top table">
<thead>
<tr class="header">
<th>æ¦‚å¿µ</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>è¿ç§»å­¦ä¹ </td>
<td>åˆ©ç”¨å·²æœ‰çŸ¥è¯†åŠ é€Ÿæ–°ä»»åŠ¡å­¦ä¹ </td>
</tr>
<tr class="even">
<td>é¢„è®­ç»ƒæ¨¡å‹</td>
<td>åœ¨å¤§æ•°æ®é›†ä¸Šè®­ç»ƒçš„æ¨¡å‹</td>
</tr>
<tr class="odd">
<td>ç‰¹å¾æå–</td>
<td>å†»ç»“éª¨å¹²ç½‘ç»œï¼Œåªè®­ç»ƒåˆ†ç±»å™¨</td>
</tr>
<tr class="even">
<td>å¾®è°ƒ</td>
<td>è§£å†»éƒ¨åˆ†æˆ–å…¨éƒ¨å±‚è¿›è¡Œè®­ç»ƒ</td>
</tr>
<tr class="odd">
<td>åˆ¤åˆ«å¼å­¦ä¹ ç‡</td>
<td>ä¸åŒå±‚ä½¿ç”¨ä¸åŒå­¦ä¹ ç‡</td>
</tr>
<tr class="even">
<td>é¢†åŸŸè‡ªé€‚åº”</td>
<td>å¤„ç†æºåŸŸå’Œç›®æ ‡åŸŸåˆ†å¸ƒä¸åŒ</td>
</tr>
<tr class="odd">
<td>å°‘æ ·æœ¬å­¦ä¹ </td>
<td>ç”¨æå°‘æ ·æœ¬å­¦ä¹ æ–°ä»»åŠ¡</td>
</tr>
<tr class="even">
<td>å…ƒå­¦ä¹ </td>
<td>å­¦ä¹ å¦‚ä½•å­¦ä¹ </td>
</tr>
<tr class="odd">
<td>çŸ¥è¯†è’¸é¦</td>
<td>ç”¨å¤§æ¨¡å‹è®­ç»ƒå°æ¨¡å‹</td>
</tr>
<tr class="even">
<td>MAML</td>
<td>æ¨¡å‹æ— å…³çš„å…ƒå­¦ä¹ </td>
</tr>
<tr class="odd">
<td>åŸå‹ç½‘ç»œ</td>
<td>åŸºäºè·ç¦»çš„å°‘æ ·æœ¬å­¦ä¹ </td>
</tr>
<tr class="even">
<td>Grad-CAM</td>
<td>ç±»æ¿€æ´»æ˜ å°„å¯è§†åŒ–</td>
</tr>
</tbody>
</table>
<hr>
</section>
<section id="è¿›é˜¶è¯é¢˜" class="level2">
<h2 class="anchored" data-anchor-id="è¿›é˜¶è¯é¢˜">9.10 è¿›é˜¶è¯é¢˜</h2>
<section id="å¤šä»»åŠ¡å­¦ä¹ -multi-task-learning" class="level3">
<h3 class="anchored" data-anchor-id="å¤šä»»åŠ¡å­¦ä¹ -multi-task-learning">ğŸ”¹ å¤šä»»åŠ¡å­¦ä¹  (Multi-Task Learning)</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MultiTaskModel(nn.Module):</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""å¤šä»»åŠ¡å­¦ä¹ æ¨¡å‹"""</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, backbone, num_classes_list):</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="co">        å‚æ•°ï¼š</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co">            backbone: å…±äº«çš„ç‰¹å¾æå–å™¨</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="co">            num_classes_list: æ¯ä¸ªä»»åŠ¡çš„ç±»åˆ«æ•°åˆ—è¡¨</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.backbone <span class="op">=</span> backbone</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ä¸ºæ¯ä¸ªä»»åŠ¡åˆ›å»ºç‹¬ç«‹çš„åˆ†ç±»å™¨</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.task_heads <span class="op">=</span> nn.ModuleList([</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>            nn.Linear(backbone.output_dim, num_classes)</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> num_classes <span class="kw">in</span> num_classes_list</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>        ])</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># å…±äº«ç‰¹å¾æå–</span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>        features <span class="op">=</span> <span class="va">self</span>.backbone(x)</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># å¤šä¸ªä»»åŠ¡çš„è¾“å‡º</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>        outputs <span class="op">=</span> [head(features) <span class="cf">for</span> head <span class="kw">in</span> <span class="va">self</span>.task_heads]</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> outputs</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a><span class="co"># å¤šä»»åŠ¡æŸå¤±</span></span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MultiTaskLoss(nn.Module):</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""å¤šä»»åŠ¡æŸå¤±ï¼ˆä¸ç¡®å®šæ€§åŠ æƒï¼‰"""</span></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, num_tasks):</span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># å¯å­¦ä¹ çš„ä»»åŠ¡æƒé‡ï¼ˆlog æ–¹å·®ï¼‰</span></span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.log_vars <span class="op">=</span> nn.Parameter(torch.zeros(num_tasks))</span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, losses):</span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a><span class="co">        å‚æ•°ï¼š</span></span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a><span class="co">            losses: æ¯ä¸ªä»»åŠ¡çš„æŸå¤±åˆ—è¡¨</span></span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a>        weighted_losses <span class="op">=</span> []</span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, loss <span class="kw">in</span> <span class="bu">enumerate</span>(losses):</span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a>            precision <span class="op">=</span> torch.exp(<span class="op">-</span><span class="va">self</span>.log_vars[i])</span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a>            weighted_loss <span class="op">=</span> precision <span class="op">*</span> loss <span class="op">+</span> <span class="va">self</span>.log_vars[i]</span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a>            weighted_losses.append(weighted_loss)</span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">sum</span>(weighted_losses)</span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a><span class="co"># ä½¿ç”¨ç¤ºä¾‹</span></span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_multitask():</span>
<span id="cb40-54"><a href="#cb40-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># åˆ›å»ºæ¨¡å‹</span></span>
<span id="cb40-55"><a href="#cb40-55" aria-hidden="true" tabindex="-1"></a>    backbone <span class="op">=</span> models.resnet50(pretrained<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb40-56"><a href="#cb40-56" aria-hidden="true" tabindex="-1"></a>    backbone.fc <span class="op">=</span> nn.Identity()  <span class="co"># ç§»é™¤æœ€åçš„ FC å±‚</span></span>
<span id="cb40-57"><a href="#cb40-57" aria-hidden="true" tabindex="-1"></a>    backbone.output_dim <span class="op">=</span> <span class="dv">2048</span></span>
<span id="cb40-58"><a href="#cb40-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-59"><a href="#cb40-59" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> MultiTaskModel(</span>
<span id="cb40-60"><a href="#cb40-60" aria-hidden="true" tabindex="-1"></a>        backbone<span class="op">=</span>backbone,</span>
<span id="cb40-61"><a href="#cb40-61" aria-hidden="true" tabindex="-1"></a>        num_classes_list<span class="op">=</span>[<span class="dv">10</span>, <span class="dv">5</span>, <span class="dv">2</span>]  <span class="co"># 3ä¸ªä»»åŠ¡</span></span>
<span id="cb40-62"><a href="#cb40-62" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-63"><a href="#cb40-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-64"><a href="#cb40-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># å¤šä»»åŠ¡æŸå¤±</span></span>
<span id="cb40-65"><a href="#cb40-65" aria-hidden="true" tabindex="-1"></a>    criterion <span class="op">=</span> MultiTaskLoss(num_tasks<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb40-66"><a href="#cb40-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-67"><a href="#cb40-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># è®­ç»ƒå¾ªç¯</span></span>
<span id="cb40-68"><a href="#cb40-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> images, (labels1, labels2, labels3) <span class="kw">in</span> dataloader:</span>
<span id="cb40-69"><a href="#cb40-69" aria-hidden="true" tabindex="-1"></a>        outputs <span class="op">=</span> model(images)</span>
<span id="cb40-70"><a href="#cb40-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-71"><a href="#cb40-71" aria-hidden="true" tabindex="-1"></a>        <span class="co"># è®¡ç®—æ¯ä¸ªä»»åŠ¡çš„æŸå¤±</span></span>
<span id="cb40-72"><a href="#cb40-72" aria-hidden="true" tabindex="-1"></a>        losses <span class="op">=</span> [</span>
<span id="cb40-73"><a href="#cb40-73" aria-hidden="true" tabindex="-1"></a>            nn.CrossEntropyLoss()(outputs[<span class="dv">0</span>], labels1),</span>
<span id="cb40-74"><a href="#cb40-74" aria-hidden="true" tabindex="-1"></a>            nn.CrossEntropyLoss()(outputs[<span class="dv">1</span>], labels2),</span>
<span id="cb40-75"><a href="#cb40-75" aria-hidden="true" tabindex="-1"></a>            nn.CrossEntropyLoss()(outputs[<span class="dv">2</span>], labels3)</span>
<span id="cb40-76"><a href="#cb40-76" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb40-77"><a href="#cb40-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-78"><a href="#cb40-78" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ç»„åˆæŸå¤±</span></span>
<span id="cb40-79"><a href="#cb40-79" aria-hidden="true" tabindex="-1"></a>        total_loss <span class="op">=</span> criterion(losses)</span>
<span id="cb40-80"><a href="#cb40-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-81"><a href="#cb40-81" aria-hidden="true" tabindex="-1"></a>        <span class="co"># åå‘ä¼ æ’­</span></span>
<span id="cb40-82"><a href="#cb40-82" aria-hidden="true" tabindex="-1"></a>        optimizer.zero_grad()</span>
<span id="cb40-83"><a href="#cb40-83" aria-hidden="true" tabindex="-1"></a>        total_loss.backward()</span>
<span id="cb40-84"><a href="#cb40-84" aria-hidden="true" tabindex="-1"></a>        optimizer.step()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
</section>
<section id="æŒç»­å­¦ä¹ -continual-learning" class="level3">
<h3 class="anchored" data-anchor-id="æŒç»­å­¦ä¹ -continual-learning">ğŸ”¹ æŒç»­å­¦ä¹  (Continual Learning)</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ElasticWeightConsolidation:</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""å¼¹æ€§æƒé‡å·©å›º (EWC)"""</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, model, dataloader, lambda_ewc<span class="op">=</span><span class="dv">1000</span>):</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> model</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.lambda_ewc <span class="op">=</span> lambda_ewc</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># è®¡ç®— Fisher ä¿¡æ¯çŸ©é˜µ</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fisher_matrix <span class="op">=</span> <span class="va">self</span>._compute_fisher(dataloader)</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ä¿å­˜å½“å‰å‚æ•°</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.optimal_params <span class="op">=</span> {</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>            name: param.clone().detach()</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> name, param <span class="kw">in</span> model.named_parameters()</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _compute_fisher(<span class="va">self</span>, dataloader):</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""è®¡ç®— Fisher ä¿¡æ¯çŸ©é˜µ"""</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>        fisher <span class="op">=</span> {}</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model.<span class="bu">eval</span>()</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> name, param <span class="kw">in</span> <span class="va">self</span>.model.named_parameters():</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>            fisher[name] <span class="op">=</span> torch.zeros_like(param)</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> inputs, labels <span class="kw">in</span> dataloader:</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.model.zero_grad()</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>            outputs <span class="op">=</span> <span class="va">self</span>.model(inputs)</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> nn.CrossEntropyLoss()(outputs, labels)</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>            loss.backward()</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> name, param <span class="kw">in</span> <span class="va">self</span>.model.named_parameters():</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> param.grad <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>                    fisher[name] <span class="op">+=</span> param.grad.<span class="bu">pow</span>(<span class="dv">2</span>)</span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># å½’ä¸€åŒ–</span></span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>        num_samples <span class="op">=</span> <span class="bu">len</span>(dataloader.dataset)</span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> name <span class="kw">in</span> fisher:</span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a>            fisher[name] <span class="op">/=</span> num_samples</span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> fisher</span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> penalty(<span class="va">self</span>):</span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""EWC æƒ©ç½šé¡¹"""</span></span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> name, param <span class="kw">in</span> <span class="va">self</span>.model.named_parameters():</span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> name <span class="kw">in</span> <span class="va">self</span>.fisher_matrix:</span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true" tabindex="-1"></a>                loss <span class="op">+=</span> (<span class="va">self</span>.fisher_matrix[name] <span class="op">*</span></span>
<span id="cb41-51"><a href="#cb41-51" aria-hidden="true" tabindex="-1"></a>                        (param <span class="op">-</span> <span class="va">self</span>.optimal_params[name]).<span class="bu">pow</span>(<span class="dv">2</span>)).<span class="bu">sum</span>()</span>
<span id="cb41-52"><a href="#cb41-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-53"><a href="#cb41-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.lambda_ewc <span class="op">*</span> loss</span>
<span id="cb41-54"><a href="#cb41-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-55"><a href="#cb41-55" aria-hidden="true" tabindex="-1"></a><span class="co"># ä½¿ç”¨</span></span>
<span id="cb41-56"><a href="#cb41-56" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_with_ewc(model, old_task_loader, new_task_loader):</span>
<span id="cb41-57"><a href="#cb41-57" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""ä½¿ç”¨ EWC è®­ç»ƒæ–°ä»»åŠ¡"""</span></span>
<span id="cb41-58"><a href="#cb41-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-59"><a href="#cb41-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># åœ¨æ—§ä»»åŠ¡ä¸Šè®¡ç®— Fisher çŸ©é˜µ</span></span>
<span id="cb41-60"><a href="#cb41-60" aria-hidden="true" tabindex="-1"></a>    ewc <span class="op">=</span> ElasticWeightConsolidation(model, old_task_loader)</span>
<span id="cb41-61"><a href="#cb41-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-62"><a href="#cb41-62" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span><span class="fl">0.001</span>)</span>
<span id="cb41-63"><a href="#cb41-63" aria-hidden="true" tabindex="-1"></a>    criterion <span class="op">=</span> nn.CrossEntropyLoss()</span>
<span id="cb41-64"><a href="#cb41-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-65"><a href="#cb41-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># åœ¨æ–°ä»»åŠ¡ä¸Šè®­ç»ƒ</span></span>
<span id="cb41-66"><a href="#cb41-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(num_epochs):</span>
<span id="cb41-67"><a href="#cb41-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> inputs, labels <span class="kw">in</span> new_task_loader:</span>
<span id="cb41-68"><a href="#cb41-68" aria-hidden="true" tabindex="-1"></a>            outputs <span class="op">=</span> model(inputs)</span>
<span id="cb41-69"><a href="#cb41-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-70"><a href="#cb41-70" aria-hidden="true" tabindex="-1"></a>            <span class="co"># æ–°ä»»åŠ¡æŸå¤± + EWC æƒ©ç½š</span></span>
<span id="cb41-71"><a href="#cb41-71" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> criterion(outputs, labels) <span class="op">+</span> ewc.penalty()</span>
<span id="cb41-72"><a href="#cb41-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-73"><a href="#cb41-73" aria-hidden="true" tabindex="-1"></a>            optimizer.zero_grad()</span>
<span id="cb41-74"><a href="#cb41-74" aria-hidden="true" tabindex="-1"></a>            loss.backward()</span>
<span id="cb41-75"><a href="#cb41-75" aria-hidden="true" tabindex="-1"></a>            optimizer.step()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
</section>
<section id="å¯¹æ¯”å­¦ä¹ -contrastive-learning" class="level3">
<h3 class="anchored" data-anchor-id="å¯¹æ¯”å­¦ä¹ -contrastive-learning">ğŸ”¹ å¯¹æ¯”å­¦ä¹  (Contrastive Learning)</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SimCLR(nn.Module):</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""SimCLR å¯¹æ¯”å­¦ä¹ """</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, base_encoder, projection_dim<span class="op">=</span><span class="dv">128</span>):</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ç¼–ç å™¨</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.encoder <span class="op">=</span> base_encoder</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># æŠ•å½±å¤´</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.projector <span class="op">=</span> nn.Sequential(</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>            nn.Linear(base_encoder.output_dim, <span class="dv">2048</span>),</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="dv">2048</span>, projection_dim)</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ç¼–ç </span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>        features <span class="op">=</span> <span class="va">self</span>.encoder(x)</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># æŠ•å½±</span></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>        z <span class="op">=</span> <span class="va">self</span>.projector(features)</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># L2 å½’ä¸€åŒ–</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>        z <span class="op">=</span> F.normalize(z, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> z</span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NTXentLoss(nn.Module):</span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""å½’ä¸€åŒ–æ¸©åº¦äº¤å‰ç†µæŸå¤± (NT-Xent)"""</span></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, temperature<span class="op">=</span><span class="fl">0.5</span>):</span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.temperature <span class="op">=</span> temperature</span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, z_i, z_j):</span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a><span class="co">        å‚æ•°ï¼š</span></span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a><span class="co">            z_i, z_j: ä¸¤ä¸ªå¢å¼ºè§†å›¾çš„è¡¨ç¤º (batch_size, projection_dim)</span></span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a>        batch_size <span class="op">=</span> z_i.size(<span class="dv">0</span>)</span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># æ‹¼æ¥</span></span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a>        z <span class="op">=</span> torch.cat([z_i, z_j], dim<span class="op">=</span><span class="dv">0</span>)  <span class="co"># (2*batch_size, dim)</span></span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># è®¡ç®—ç›¸ä¼¼åº¦çŸ©é˜µ</span></span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a>        sim_matrix <span class="op">=</span> torch.mm(z, z.T) <span class="op">/</span> <span class="va">self</span>.temperature</span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># åˆ›å»ºæ ‡ç­¾ï¼šå¯¹è§’çº¿å¤–çš„å¯¹åº”ä½ç½®ä¸ºæ­£æ ·æœ¬</span></span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true" tabindex="-1"></a>        labels <span class="op">=</span> torch.arange(batch_size).to(z.device)</span>
<span id="cb42-51"><a href="#cb42-51" aria-hidden="true" tabindex="-1"></a>        labels <span class="op">=</span> torch.cat([labels <span class="op">+</span> batch_size, labels])</span>
<span id="cb42-52"><a href="#cb42-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-53"><a href="#cb42-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># æ©ç ï¼šå»æ‰è‡ªå·±å’Œè‡ªå·±çš„ç›¸ä¼¼åº¦</span></span>
<span id="cb42-54"><a href="#cb42-54" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> torch.eye(<span class="dv">2</span> <span class="op">*</span> batch_size, dtype<span class="op">=</span>torch.<span class="bu">bool</span>).to(z.device)</span>
<span id="cb42-55"><a href="#cb42-55" aria-hidden="true" tabindex="-1"></a>        sim_matrix <span class="op">=</span> sim_matrix.masked_fill(mask, <span class="op">-</span><span class="fl">1e9</span>)</span>
<span id="cb42-56"><a href="#cb42-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-57"><a href="#cb42-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># è®¡ç®—æŸå¤±</span></span>
<span id="cb42-58"><a href="#cb42-58" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> nn.CrossEntropyLoss()(sim_matrix, labels)</span>
<span id="cb42-59"><a href="#cb42-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-60"><a href="#cb42-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> loss</span>
<span id="cb42-61"><a href="#cb42-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-62"><a href="#cb42-62" aria-hidden="true" tabindex="-1"></a><span class="co"># è®­ç»ƒ SimCLR</span></span>
<span id="cb42-63"><a href="#cb42-63" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_simclr(model, dataloader, num_epochs<span class="op">=</span><span class="dv">100</span>):</span>
<span id="cb42-64"><a href="#cb42-64" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""è®­ç»ƒ SimCLR"""</span></span>
<span id="cb42-65"><a href="#cb42-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-66"><a href="#cb42-66" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span><span class="fl">0.001</span>)</span>
<span id="cb42-67"><a href="#cb42-67" aria-hidden="true" tabindex="-1"></a>    criterion <span class="op">=</span> NTXentLoss(temperature<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb42-68"><a href="#cb42-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-69"><a href="#cb42-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(num_epochs):</span>
<span id="cb42-70"><a href="#cb42-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (x_i, x_j), _ <span class="kw">in</span> dataloader:  <span class="co"># x_i, x_j æ˜¯ä¸¤ä¸ªå¢å¼ºè§†å›¾</span></span>
<span id="cb42-71"><a href="#cb42-71" aria-hidden="true" tabindex="-1"></a>            <span class="co"># å‰å‘ä¼ æ’­</span></span>
<span id="cb42-72"><a href="#cb42-72" aria-hidden="true" tabindex="-1"></a>            z_i <span class="op">=</span> model(x_i)</span>
<span id="cb42-73"><a href="#cb42-73" aria-hidden="true" tabindex="-1"></a>            z_j <span class="op">=</span> model(x_j)</span>
<span id="cb42-74"><a href="#cb42-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-75"><a href="#cb42-75" aria-hidden="true" tabindex="-1"></a>            <span class="co"># è®¡ç®—æŸå¤±</span></span>
<span id="cb42-76"><a href="#cb42-76" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> criterion(z_i, z_j)</span>
<span id="cb42-77"><a href="#cb42-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-78"><a href="#cb42-78" aria-hidden="true" tabindex="-1"></a>            <span class="co"># åå‘ä¼ æ’­</span></span>
<span id="cb42-79"><a href="#cb42-79" aria-hidden="true" tabindex="-1"></a>            optimizer.zero_grad()</span>
<span id="cb42-80"><a href="#cb42-80" aria-hidden="true" tabindex="-1"></a>            loss.backward()</span>
<span id="cb42-81"><a href="#cb42-81" aria-hidden="true" tabindex="-1"></a>            optimizer.step()</span>
<span id="cb42-82"><a href="#cb42-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-83"><a href="#cb42-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> epoch <span class="op">%</span> <span class="dv">10</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb42-84"><a href="#cb42-84" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f'Epoch </span><span class="sc">{</span>epoch<span class="sc">}</span><span class="ss">: Loss = </span><span class="sc">{</span>loss<span class="sc">.</span>item()<span class="sc">:.4f}</span><span class="ss">'</span>)</span>
<span id="cb42-85"><a href="#cb42-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-86"><a href="#cb42-86" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span>
<span id="cb42-87"><a href="#cb42-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-88"><a href="#cb42-88" aria-hidden="true" tabindex="-1"></a><span class="co"># ä½¿ç”¨é¢„è®­ç»ƒçš„ SimCLR è¿›è¡Œä¸‹æ¸¸ä»»åŠ¡</span></span>
<span id="cb42-89"><a href="#cb42-89" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> finetune_simclr(pretrained_encoder, train_loader, num_classes):</span>
<span id="cb42-90"><a href="#cb42-90" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""å¾®è°ƒ SimCLR ç¼–ç å™¨"""</span></span>
<span id="cb42-91"><a href="#cb42-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-92"><a href="#cb42-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># å†»ç»“ç¼–ç å™¨</span></span>
<span id="cb42-93"><a href="#cb42-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> param <span class="kw">in</span> pretrained_encoder.parameters():</span>
<span id="cb42-94"><a href="#cb42-94" aria-hidden="true" tabindex="-1"></a>        param.requires_grad <span class="op">=</span> <span class="va">False</span></span>
<span id="cb42-95"><a href="#cb42-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-96"><a href="#cb42-96" aria-hidden="true" tabindex="-1"></a>    <span class="co"># æ·»åŠ çº¿æ€§åˆ†ç±»å™¨</span></span>
<span id="cb42-97"><a href="#cb42-97" aria-hidden="true" tabindex="-1"></a>    classifier <span class="op">=</span> nn.Linear(pretrained_encoder.output_dim, num_classes)</span>
<span id="cb42-98"><a href="#cb42-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-99"><a href="#cb42-99" aria-hidden="true" tabindex="-1"></a>    <span class="co"># è®­ç»ƒåˆ†ç±»å™¨</span></span>
<span id="cb42-100"><a href="#cb42-100" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> torch.optim.Adam(classifier.parameters(), lr<span class="op">=</span><span class="fl">0.001</span>)</span>
<span id="cb42-101"><a href="#cb42-101" aria-hidden="true" tabindex="-1"></a>    criterion <span class="op">=</span> nn.CrossEntropyLoss()</span>
<span id="cb42-102"><a href="#cb42-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-103"><a href="#cb42-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(num_epochs):</span>
<span id="cb42-104"><a href="#cb42-104" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> inputs, labels <span class="kw">in</span> train_loader:</span>
<span id="cb42-105"><a href="#cb42-105" aria-hidden="true" tabindex="-1"></a>            <span class="co"># æå–ç‰¹å¾ï¼ˆå†»ç»“ï¼‰</span></span>
<span id="cb42-106"><a href="#cb42-106" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> torch.no_grad():</span>
<span id="cb42-107"><a href="#cb42-107" aria-hidden="true" tabindex="-1"></a>                features <span class="op">=</span> pretrained_encoder(inputs)</span>
<span id="cb42-108"><a href="#cb42-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-109"><a href="#cb42-109" aria-hidden="true" tabindex="-1"></a>            <span class="co"># åˆ†ç±»</span></span>
<span id="cb42-110"><a href="#cb42-110" aria-hidden="true" tabindex="-1"></a>            outputs <span class="op">=</span> classifier(features)</span>
<span id="cb42-111"><a href="#cb42-111" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> criterion(outputs, labels)</span>
<span id="cb42-112"><a href="#cb42-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-113"><a href="#cb42-113" aria-hidden="true" tabindex="-1"></a>            optimizer.zero_grad()</span>
<span id="cb42-114"><a href="#cb42-114" aria-hidden="true" tabindex="-1"></a>            loss.backward()</span>
<span id="cb42-115"><a href="#cb42-115" aria-hidden="true" tabindex="-1"></a>            optimizer.step()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
</section>
</section>
<section id="å®ç”¨å·¥å…·å’ŒæŠ€å·§" class="level2">
<h2 class="anchored" data-anchor-id="å®ç”¨å·¥å…·å’ŒæŠ€å·§">9.11 å®ç”¨å·¥å…·å’ŒæŠ€å·§</h2>
<section id="æ¨¡å‹è½¬æ¢å’Œéƒ¨ç½²" class="level3">
<h3 class="anchored" data-anchor-id="æ¨¡å‹è½¬æ¢å’Œéƒ¨ç½²">ğŸ› ï¸ æ¨¡å‹è½¬æ¢å’Œéƒ¨ç½²</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. ONNX å¯¼å‡º</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> export_to_onnx(model, dummy_input, output_path):</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""å¯¼å‡ºä¸º ONNX æ ¼å¼"""</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    torch.onnx.export(</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>        model,</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>        dummy_input,</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>        output_path,</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>        export_params<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>        opset_version<span class="op">=</span><span class="dv">11</span>,</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>        do_constant_folding<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>        input_names<span class="op">=</span>[<span class="st">'input'</span>],</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>        output_names<span class="op">=</span>[<span class="st">'output'</span>],</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>        dynamic_axes<span class="op">=</span>{</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">'input'</span>: {<span class="dv">0</span>: <span class="st">'batch_size'</span>},</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">'output'</span>: {<span class="dv">0</span>: <span class="st">'batch_size'</span>}</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"æ¨¡å‹å·²å¯¼å‡ºåˆ° </span><span class="sc">{</span>output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a><span class="co"># ä½¿ç”¨</span></span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>dummy_input <span class="op">=</span> torch.randn(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">224</span>, <span class="dv">224</span>)</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>export_to_onnx(model, dummy_input, <span class="st">'model.onnx'</span>)</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. TorchScript è½¬æ¢</span></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>scripted_model <span class="op">=</span> torch.jit.script(model)</span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>scripted_model.save(<span class="st">'model_scripted.pt'</span>)</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. é‡åŒ–ï¼ˆå‡å°æ¨¡å‹å¤§å°ï¼‰</span></span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> quantize_model(model):</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""åŠ¨æ€é‡åŒ–"""</span></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>    quantized_model <span class="op">=</span> torch.quantization.quantize_dynamic(</span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>        model,</span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>        {nn.Linear, nn.Conv2d},</span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>        dtype<span class="op">=</span>torch.qint8</span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> quantized_model</span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>quantized <span class="op">=</span> quantize_model(model)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
</section>
<section id="æ¨¡å‹åˆ†æå·¥å…·" class="level3">
<h3 class="anchored" data-anchor-id="æ¨¡å‹åˆ†æå·¥å…·">ğŸ“Š æ¨¡å‹åˆ†æå·¥å…·</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchinfo <span class="im">import</span> summary</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fvcore.nn <span class="im">import</span> FlopCountAnalysis, parameter_count</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> analyze_model(model, input_size<span class="op">=</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">224</span>, <span class="dv">224</span>)):</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""åˆ†ææ¨¡å‹"""</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># æ¨¡å‹æ‘˜è¦</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"æ¨¡å‹ç»“æ„:"</span>)</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>    summary(model, input_size<span class="op">=</span>input_size)</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># å‚æ•°é‡</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>    total_params <span class="op">=</span> <span class="bu">sum</span>(p.numel() <span class="cf">for</span> p <span class="kw">in</span> model.parameters())</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>    trainable_params <span class="op">=</span> <span class="bu">sum</span>(p.numel() <span class="cf">for</span> p <span class="kw">in</span> model.parameters() <span class="cf">if</span> p.requires_grad)</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">æ€»å‚æ•°: </span><span class="sc">{</span>total_params<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"å¯è®­ç»ƒå‚æ•°: </span><span class="sc">{</span>trainable_params<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"ä¸å¯è®­ç»ƒå‚æ•°: </span><span class="sc">{</span>total_params <span class="op">-</span> trainable_params<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># FLOPs</span></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>    dummy_input <span class="op">=</span> torch.randn(input_size)</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>    flops <span class="op">=</span> FlopCountAnalysis(model, dummy_input)</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">FLOPs: </span><span class="sc">{</span>flops<span class="sc">.</span>total()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># å†…å­˜å ç”¨</span></span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"æ¨¡å‹å¤§å°: </span><span class="sc">{</span>total_params <span class="op">*</span> <span class="dv">4</span> <span class="op">/</span> <span class="dv">1024</span> <span class="op">/</span> <span class="dv">1024</span><span class="sc">:.2f}</span><span class="ss"> MB (FP32)"</span>)</span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># æ¨ç†é€Ÿåº¦æµ‹è¯•</span></span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>    device <span class="op">=</span> torch.device(<span class="st">'cuda'</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">'cpu'</span>)</span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>    model.to(device)</span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>    dummy_input <span class="op">=</span> dummy_input.to(device)</span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> time</span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># é¢„çƒ­</span></span>
<span id="cb44-38"><a href="#cb44-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb44-39"><a href="#cb44-39" aria-hidden="true" tabindex="-1"></a>        _ <span class="op">=</span> model(dummy_input)</span>
<span id="cb44-40"><a href="#cb44-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-41"><a href="#cb44-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># æµ‹è¯•</span></span>
<span id="cb44-42"><a href="#cb44-42" aria-hidden="true" tabindex="-1"></a>    num_iterations <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb44-43"><a href="#cb44-43" aria-hidden="true" tabindex="-1"></a>    torch.cuda.synchronize() <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb44-44"><a href="#cb44-44" aria-hidden="true" tabindex="-1"></a>    start <span class="op">=</span> time.time()</span>
<span id="cb44-45"><a href="#cb44-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-46"><a href="#cb44-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb44-47"><a href="#cb44-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(num_iterations):</span>
<span id="cb44-48"><a href="#cb44-48" aria-hidden="true" tabindex="-1"></a>            _ <span class="op">=</span> model(dummy_input)</span>
<span id="cb44-49"><a href="#cb44-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-50"><a href="#cb44-50" aria-hidden="true" tabindex="-1"></a>    torch.cuda.synchronize() <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb44-51"><a href="#cb44-51" aria-hidden="true" tabindex="-1"></a>    end <span class="op">=</span> time.time()</span>
<span id="cb44-52"><a href="#cb44-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-53"><a href="#cb44-53" aria-hidden="true" tabindex="-1"></a>    avg_time <span class="op">=</span> (end <span class="op">-</span> start) <span class="op">/</span> num_iterations</span>
<span id="cb44-54"><a href="#cb44-54" aria-hidden="true" tabindex="-1"></a>    fps <span class="op">=</span> <span class="dv">1</span> <span class="op">/</span> avg_time</span>
<span id="cb44-55"><a href="#cb44-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-56"><a href="#cb44-56" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">æ¨ç†æ—¶é—´: </span><span class="sc">{</span>avg_time<span class="op">*</span><span class="dv">1000</span><span class="sc">:.2f}</span><span class="ss"> ms"</span>)</span>
<span id="cb44-57"><a href="#cb44-57" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"FPS: </span><span class="sc">{</span>fps<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb44-58"><a href="#cb44-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-59"><a href="#cb44-59" aria-hidden="true" tabindex="-1"></a><span class="co"># ä½¿ç”¨</span></span>
<span id="cb44-60"><a href="#cb44-60" aria-hidden="true" tabindex="-1"></a>analyze_model(model)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
</section>
<section id="é”™è¯¯åˆ†æå·¥å…·" class="level3">
<h3 class="anchored" data-anchor-id="é”™è¯¯åˆ†æå·¥å…·">ğŸ” é”™è¯¯åˆ†æå·¥å…·</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ErrorAnalyzer:</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""é”™è¯¯åˆ†æå·¥å…·"""</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, model, dataloader, class_names, device):</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> model</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dataloader <span class="op">=</span> dataloader</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.class_names <span class="op">=</span> class_names</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.device <span class="op">=</span> device</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> analyze(<span class="va">self</span>):</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""å®Œæ•´é”™è¯¯åˆ†æ"""</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model.<span class="bu">eval</span>()</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>        errors <span class="op">=</span> []</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> inputs, labels <span class="kw">in</span> <span class="va">self</span>.dataloader:</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>                inputs, labels <span class="op">=</span> inputs.to(<span class="va">self</span>.device), labels.to(<span class="va">self</span>.device)</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>                outputs <span class="op">=</span> <span class="va">self</span>.model(inputs)</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>                probs <span class="op">=</span> torch.softmax(outputs, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>                preds <span class="op">=</span> outputs.argmax(dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>                <span class="co"># æ‰¾å‡ºé”™è¯¯æ ·æœ¬</span></span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>                wrong_mask <span class="op">=</span> preds <span class="op">!=</span> labels</span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> wrong_mask.<span class="bu">any</span>():</span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> i <span class="kw">in</span> torch.where(wrong_mask)[<span class="dv">0</span>]:</span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>                        errors.append({</span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'image'</span>: inputs[i].cpu(),</span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'true_label'</span>: labels[i].item(),</span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'pred_label'</span>: preds[i].item(),</span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'confidence'</span>: probs[i, preds[i]].item(),</span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'true_prob'</span>: probs[i, labels[i]].item()</span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a>                        })</span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"æ€»é”™è¯¯æ•°: </span><span class="sc">{</span><span class="bu">len</span>(errors)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># æŒ‰ç±»åˆ«ç»Ÿè®¡é”™è¯¯</span></span>
<span id="cb45-40"><a href="#cb45-40" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._error_by_class(errors)</span>
<span id="cb45-41"><a href="#cb45-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-42"><a href="#cb45-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># æŒ‰ç½®ä¿¡åº¦åˆ†æ</span></span>
<span id="cb45-43"><a href="#cb45-43" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._error_by_confidence(errors)</span>
<span id="cb45-44"><a href="#cb45-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-45"><a href="#cb45-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># å¯è§†åŒ–æœ€éš¾æ ·æœ¬</span></span>
<span id="cb45-46"><a href="#cb45-46" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._visualize_hard_examples(errors)</span>
<span id="cb45-47"><a href="#cb45-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-48"><a href="#cb45-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> errors</span>
<span id="cb45-49"><a href="#cb45-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-50"><a href="#cb45-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _error_by_class(<span class="va">self</span>, errors):</span>
<span id="cb45-51"><a href="#cb45-51" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""æŒ‰ç±»åˆ«ç»Ÿè®¡é”™è¯¯"""</span></span>
<span id="cb45-52"><a href="#cb45-52" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb45-53"><a href="#cb45-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-54"><a href="#cb45-54" aria-hidden="true" tabindex="-1"></a>        error_count <span class="op">=</span> defaultdict(<span class="bu">int</span>)</span>
<span id="cb45-55"><a href="#cb45-55" aria-hidden="true" tabindex="-1"></a>        confusion <span class="op">=</span> defaultdict(<span class="kw">lambda</span>: defaultdict(<span class="bu">int</span>))</span>
<span id="cb45-56"><a href="#cb45-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-57"><a href="#cb45-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> error <span class="kw">in</span> errors:</span>
<span id="cb45-58"><a href="#cb45-58" aria-hidden="true" tabindex="-1"></a>            true_label <span class="op">=</span> error[<span class="st">'true_label'</span>]</span>
<span id="cb45-59"><a href="#cb45-59" aria-hidden="true" tabindex="-1"></a>            pred_label <span class="op">=</span> error[<span class="st">'pred_label'</span>]</span>
<span id="cb45-60"><a href="#cb45-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-61"><a href="#cb45-61" aria-hidden="true" tabindex="-1"></a>            error_count[true_label] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb45-62"><a href="#cb45-62" aria-hidden="true" tabindex="-1"></a>            confusion[true_label][pred_label] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb45-63"><a href="#cb45-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-64"><a href="#cb45-64" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">æ¯ç±»é”™è¯¯æ•°:"</span>)</span>
<span id="cb45-65"><a href="#cb45-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> class_id, count <span class="kw">in</span> <span class="bu">sorted</span>(error_count.items()):</span>
<span id="cb45-66"><a href="#cb45-66" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>class_names[class_id]<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>count<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb45-67"><a href="#cb45-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-68"><a href="#cb45-68" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">æœ€å¸¸è§çš„æ··æ·†:"</span>)</span>
<span id="cb45-69"><a href="#cb45-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> true_id, pred_dict <span class="kw">in</span> confusion.items():</span>
<span id="cb45-70"><a href="#cb45-70" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> pred_id, count <span class="kw">in</span> <span class="bu">sorted</span>(pred_dict.items(),</span>
<span id="cb45-71"><a href="#cb45-71" aria-hidden="true" tabindex="-1"></a>                                        key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>],</span>
<span id="cb45-72"><a href="#cb45-72" aria-hidden="true" tabindex="-1"></a>                                        reverse<span class="op">=</span><span class="va">True</span>)[:<span class="dv">3</span>]:</span>
<span id="cb45-73"><a href="#cb45-73" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>class_names[true_id]<span class="sc">}</span><span class="ss"> â†’ "</span></span>
<span id="cb45-74"><a href="#cb45-74" aria-hidden="true" tabindex="-1"></a>                      <span class="ss">f"</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>class_names[pred_id]<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>count<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb45-75"><a href="#cb45-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-76"><a href="#cb45-76" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _error_by_confidence(<span class="va">self</span>, errors):</span>
<span id="cb45-77"><a href="#cb45-77" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""æŒ‰ç½®ä¿¡åº¦åˆ†æ"""</span></span>
<span id="cb45-78"><a href="#cb45-78" aria-hidden="true" tabindex="-1"></a>        confidences <span class="op">=</span> [e[<span class="st">'confidence'</span>] <span class="cf">for</span> e <span class="kw">in</span> errors]</span>
<span id="cb45-79"><a href="#cb45-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-80"><a href="#cb45-80" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">é”™è¯¯é¢„æµ‹çš„ç½®ä¿¡åº¦:"</span>)</span>
<span id="cb45-81"><a href="#cb45-81" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  å¹³å‡: </span><span class="sc">{</span>np<span class="sc">.</span>mean(confidences)<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb45-82"><a href="#cb45-82" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  ä¸­ä½æ•°: </span><span class="sc">{</span>np<span class="sc">.</span>median(confidences)<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb45-83"><a href="#cb45-83" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  æœ€å¤§: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">max</span>(confidences)<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb45-84"><a href="#cb45-84" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  æœ€å°: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">min</span>(confidences)<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb45-85"><a href="#cb45-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-86"><a href="#cb45-86" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _visualize_hard_examples(<span class="va">self</span>, errors, num_examples<span class="op">=</span><span class="dv">16</span>):</span>
<span id="cb45-87"><a href="#cb45-87" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""å¯è§†åŒ–æœ€éš¾çš„æ ·æœ¬"""</span></span>
<span id="cb45-88"><a href="#cb45-88" aria-hidden="true" tabindex="-1"></a>        <span class="co"># æŒ‰ç½®ä¿¡åº¦æ’åºï¼ˆé«˜ç½®ä¿¡åº¦ä½†é”™è¯¯ï¼‰</span></span>
<span id="cb45-89"><a href="#cb45-89" aria-hidden="true" tabindex="-1"></a>        sorted_errors <span class="op">=</span> <span class="bu">sorted</span>(errors,</span>
<span id="cb45-90"><a href="#cb45-90" aria-hidden="true" tabindex="-1"></a>                              key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">'confidence'</span>],</span>
<span id="cb45-91"><a href="#cb45-91" aria-hidden="true" tabindex="-1"></a>                              reverse<span class="op">=</span><span class="va">True</span>)[:num_examples]</span>
<span id="cb45-92"><a href="#cb45-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-93"><a href="#cb45-93" aria-hidden="true" tabindex="-1"></a>        fig, axes <span class="op">=</span> plt.subplots(<span class="dv">4</span>, <span class="dv">4</span>, figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">16</span>))</span>
<span id="cb45-94"><a href="#cb45-94" aria-hidden="true" tabindex="-1"></a>        axes <span class="op">=</span> axes.flatten()</span>
<span id="cb45-95"><a href="#cb45-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-96"><a href="#cb45-96" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, error <span class="kw">in</span> <span class="bu">enumerate</span>(sorted_errors):</span>
<span id="cb45-97"><a href="#cb45-97" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i <span class="op">&gt;=</span> num_examples:</span>
<span id="cb45-98"><a href="#cb45-98" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb45-99"><a href="#cb45-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-100"><a href="#cb45-100" aria-hidden="true" tabindex="-1"></a>            <span class="co"># åå½’ä¸€åŒ–</span></span>
<span id="cb45-101"><a href="#cb45-101" aria-hidden="true" tabindex="-1"></a>            img <span class="op">=</span> error[<span class="st">'image'</span>].numpy().transpose(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>)</span>
<span id="cb45-102"><a href="#cb45-102" aria-hidden="true" tabindex="-1"></a>            mean <span class="op">=</span> np.array([<span class="fl">0.485</span>, <span class="fl">0.456</span>, <span class="fl">0.406</span>])</span>
<span id="cb45-103"><a href="#cb45-103" aria-hidden="true" tabindex="-1"></a>            std <span class="op">=</span> np.array([<span class="fl">0.229</span>, <span class="fl">0.224</span>, <span class="fl">0.225</span>])</span>
<span id="cb45-104"><a href="#cb45-104" aria-hidden="true" tabindex="-1"></a>            img <span class="op">=</span> std <span class="op">*</span> img <span class="op">+</span> mean</span>
<span id="cb45-105"><a href="#cb45-105" aria-hidden="true" tabindex="-1"></a>            img <span class="op">=</span> np.clip(img, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb45-106"><a href="#cb45-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-107"><a href="#cb45-107" aria-hidden="true" tabindex="-1"></a>            ax <span class="op">=</span> axes[i]</span>
<span id="cb45-108"><a href="#cb45-108" aria-hidden="true" tabindex="-1"></a>            ax.imshow(img)</span>
<span id="cb45-109"><a href="#cb45-109" aria-hidden="true" tabindex="-1"></a>            ax.set_title(</span>
<span id="cb45-110"><a href="#cb45-110" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"çœŸå®: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>class_names[error[<span class="st">'true_label'</span>]]<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb45-111"><a href="#cb45-111" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"é¢„æµ‹: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>class_names[error[<span class="st">'pred_label'</span>]]<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb45-112"><a href="#cb45-112" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"ç½®ä¿¡åº¦: </span><span class="sc">{</span>error[<span class="st">'confidence'</span>]<span class="sc">:.3f}</span><span class="ss">"</span>,</span>
<span id="cb45-113"><a href="#cb45-113" aria-hidden="true" tabindex="-1"></a>                fontsize<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb45-114"><a href="#cb45-114" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span><span class="st">'red'</span></span>
<span id="cb45-115"><a href="#cb45-115" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb45-116"><a href="#cb45-116" aria-hidden="true" tabindex="-1"></a>            ax.axis(<span class="st">'off'</span>)</span>
<span id="cb45-117"><a href="#cb45-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-118"><a href="#cb45-118" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb45-119"><a href="#cb45-119" aria-hidden="true" tabindex="-1"></a>        plt.savefig(<span class="st">'hard_examples.png'</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb45-120"><a href="#cb45-120" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb45-121"><a href="#cb45-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-122"><a href="#cb45-122" aria-hidden="true" tabindex="-1"></a><span class="co"># ä½¿ç”¨</span></span>
<span id="cb45-123"><a href="#cb45-123" aria-hidden="true" tabindex="-1"></a>analyzer <span class="op">=</span> ErrorAnalyzer(model, test_loader, class_names, device)</span>
<span id="cb45-124"><a href="#cb45-124" aria-hidden="true" tabindex="-1"></a>errors <span class="op">=</span> analyzer.analyze()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
</section>
</section>
<section id="æ¨èèµ„æº" class="level2">
<h2 class="anchored" data-anchor-id="æ¨èèµ„æº">ğŸ“š æ¨èèµ„æº</h2>
<section id="è®ºæ–‡" class="level3">
<h3 class="anchored" data-anchor-id="è®ºæ–‡">ğŸ“– è®ºæ–‡</h3>
<p><strong>è¿ç§»å­¦ä¹ åŸºç¡€</strong>ï¼š - â€œA Survey on Transfer Learningâ€ (Pan &amp; Yang, 2010) - â€œHow transferable are features in deep neural networks?â€ (Yosinski et al., 2014)</p>
<p><strong>é¢†åŸŸè‡ªé€‚åº”</strong>ï¼š - â€œDomain-Adversarial Training of Neural Networksâ€ (Ganin et al., 2016) - â€œUnsupervised Domain Adaptation by Backpropagationâ€ (Ganin &amp; Lempitsky, 2015)</p>
<p><strong>å°‘æ ·æœ¬å­¦ä¹ </strong>ï¼š - â€œModel-Agnostic Meta-Learning (MAML)â€ (Finn et al., 2017) - â€œPrototypical Networks for Few-shot Learningâ€ (Snell et al., 2017) - â€œMatching Networks for One Shot Learningâ€ (Vinyals et al., 2016)</p>
<p><strong>çŸ¥è¯†è’¸é¦</strong>ï¼š - â€œDistilling the Knowledge in a Neural Networkâ€ (Hinton et al., 2015)</p>
<p><strong>å¯¹æ¯”å­¦ä¹ </strong>ï¼š - â€œA Simple Framework for Contrastive Learning (SimCLR)â€ (Chen et al., 2020) - â€œMomentum Contrast (MoCo)â€ (He et al., 2020)</p>
</section>
<section id="å·¥å…·å’Œåº“" class="level3">
<h3 class="anchored" data-anchor-id="å·¥å…·å’Œåº“">ğŸ”§ å·¥å…·å’Œåº“</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Hugging Face Transformers</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> AutoModel, AutoTokenizer</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Timm (PyTorch Image Models)</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> timm</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> timm.create_model(<span class="st">'resnet50'</span>, pretrained<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="co"># PyTorch Lightning (ç®€åŒ–è®­ç»ƒ)</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytorch_lightning <span class="im">as</span> pl</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Weights &amp; Biases (å®éªŒè·Ÿè¸ª)</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> wandb</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a><span class="co"># TensorBoard</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.tensorboard <span class="im">import</span> SummaryWriter</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
</section>
</section>
<section id="æ€»ç»“" class="level2">
<h2 class="anchored" data-anchor-id="æ€»ç»“">ğŸ“ æ€»ç»“</h2>
<section id="è¿ç§»å­¦ä¹ ä½•æ—¶æœ‰æ•ˆ" class="level3">
<h3 class="anchored" data-anchor-id="è¿ç§»å­¦ä¹ ä½•æ—¶æœ‰æ•ˆ">âœ… è¿ç§»å­¦ä¹ ä½•æ—¶æœ‰æ•ˆï¼Ÿ</h3>
<pre><code>âœ“ æºä»»åŠ¡å’Œç›®æ ‡ä»»åŠ¡ç›¸å…³
âœ“ ç›®æ ‡ä»»åŠ¡æ•°æ®è¾ƒå°‘
âœ“ æºä»»åŠ¡æ•°æ®é‡å¤§ä¸”è´¨é‡é«˜
âœ“ æœ‰åˆé€‚çš„é¢„è®­ç»ƒæ¨¡å‹å¯ç”¨</code></pre>
</section>
<section id="è¿ç§»å­¦ä¹ ä½•æ—¶æ— æ•ˆ" class="level3">
<h3 class="anchored" data-anchor-id="è¿ç§»å­¦ä¹ ä½•æ—¶æ— æ•ˆ">âŒ è¿ç§»å­¦ä¹ ä½•æ—¶æ— æ•ˆï¼Ÿ</h3>
<pre><code>âœ— æºä»»åŠ¡å’Œç›®æ ‡ä»»åŠ¡å®Œå…¨ä¸ç›¸å…³
âœ— ç›®æ ‡ä»»åŠ¡æ•°æ®å……è¶³
âœ— é¢„è®­ç»ƒæ¨¡å‹ä¸åŒ¹é…ç›®æ ‡ä»»åŠ¡
âœ— è®¡ç®—èµ„æºå……è¶³ï¼Œå¯ä»å¤´è®­ç»ƒ</code></pre>
</section>
<section id="å®è·µå»ºè®®" class="level3">
<h3 class="anchored" data-anchor-id="å®è·µå»ºè®®">ğŸ¯ å®è·µå»ºè®®</h3>
<ol type="1">
<li><strong>ä¼˜å…ˆå°è¯•é¢„è®­ç»ƒæ¨¡å‹</strong></li>
<li><strong>æ ¹æ®æ•°æ®é‡é€‰æ‹©ç­–ç•¥</strong>ï¼ˆç‰¹å¾æå– vs å¾®è°ƒï¼‰</li>
<li><strong>ä½¿ç”¨åˆ¤åˆ«å¼å­¦ä¹ ç‡</strong></li>
<li><strong>å……åˆ†åˆ©ç”¨æ•°æ®å¢å¼º</strong></li>
<li><strong>ç›‘æ§éªŒè¯é›†é¿å…è¿‡æ‹Ÿåˆ</strong></li>
<li><strong>å¯è§†åŒ–ç†è§£æ¨¡å‹è¡Œä¸º</strong>ï¼ˆGrad-CAMç­‰ï¼‰</li>
<li><strong>è®°å½•å®éªŒç»“æœ</strong>ï¼ˆWeights &amp; Biasesï¼‰</li>
<li><strong>é”™è¯¯åˆ†ææŒ‡å¯¼æ”¹è¿›</strong></li>
</ol>
<hr>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./Chapter8.html" class="pagination-link" aria-label="ç¬¬å…«ç« ï¼šAttention ä¸ Transformer">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-title">ç¬¬å…«ç« ï¼šAttention ä¸ Transformer</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./Chapter10.html" class="pagination-link" aria-label="ç¬¬åç« ï¼šå¼ºåŒ–å­¦ä¹  (Reinforcement Learning)">
        <span class="nav-page-text"><span class="chapter-title">ç¬¬åç« ï¼šå¼ºåŒ–å­¦ä¹  (Reinforcement Learning)</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>